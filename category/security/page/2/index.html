<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="twitter:widgets:csp" content="on" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="twitter:site" content="@matrixdotorg" />
    <meta name="twitter:creator" content="@matrixdotorg" />

    <title>Matrix.org - Security</title>
    <link rel="shortcut icon" href="/assets/favicon.ico" />
    <link rel="icon" type="image/png" href="/assets/favicon.png" />
    <link rel="stylesheet" href="/style.css" />

    
<link rel="alternate" type="application/rss+xml" title="RSS" href="/category/security/atom.xml">
</head>

<body>
    
    <header class="site-header">
    <a href="/" class="brand">
        <img src="/images/matrix-logo-white.svg" alt="Matrix logo">
    </a>
    <input id="site-header-dropdown-checkbox" type="checkbox" class="dropdown-checkbox" aria-hidden="true">
    <label for="site-header-dropdown-checkbox" class="dropdown-button">&#xe602;</label>
    <label for="site-header-dropdown-checkbox" class="page-overlay"></label>
    <nav>
        
        
        <a href="&#x2F;about&#x2F;" class="
            ">
            About
        </a>
        
        
        
        <a href="&#x2F;blog&#x2F;" class="
            ">
            Blog
        </a>
        
        
        
        <a href="&#x2F;docs&#x2F;" class="
            ">
            Documentation
        </a>
        
        
        
        
        
        <div class="section-wrap">
            <input id="ecosystem-submenu-checkbox" type="checkbox" class="submenu-checkbox" aria-hidden="true" >
            <label for="ecosystem-submenu-checkbox" class="submenu-title">Ecosystem <div class="arrow"></div></label>

            <div class="section-submenu-wrap">
                <div class="section-submenu">
                    
                    <a href="&#x2F;ecosystem&#x2F;clients&#x2F;">Clients</a>
                    
                    <a href="&#x2F;ecosystem&#x2F;servers&#x2F;">Servers</a>
                    
                    <a href="&#x2F;ecosystem&#x2F;bots&#x2F;">Bots</a>
                    
                    <a href="&#x2F;ecosystem&#x2F;sdks&#x2F;">SDKs</a>
                    
                    <a href="&#x2F;ecosystem&#x2F;hosting&#x2F;">Hosting</a>
                    
                    
                    
                    <a href="&#x2F;ecosystem&#x2F;bridges&#x2F;">Bridges</a>
                    
                </div>
            </div>
        </div>
        
        
        
        <a href="&#x2F;podcasts&#x2F;" class="
            ">
            Podcasts
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;shop.matrix.org" class="
            ">
            Shop
        </a>
        
        
        
        <a href="&#x2F;try-matrix&#x2F;" class="primary
            ">
            Try Matrix
        </a>
        
        
    </nav>
</header>


    <main>
        
<div id="taxonomy-single">
    <div class="content">
        <header>
            <h1>Security</h1>
            34 posts tagged with "Security" <a href="/category">(See all Category)</a>
            
            <h2>
                <small><a href="/category/security/atom.xml">Atom Feed</a></small>
            </h2>
            
        </header>

        
        <article class="post">
            <header>
                <h2><a href="&#x2F;blog&#x2F;2021&#x2F;11&#x2F;23&#x2F;synapse-1-47-1-released&#x2F;" title="Synapse 1.47.1 released">Synapse 1.47.1 released</a></h2>
                <span>
                    23.11.2021 12:46
                    —
                    <a href="/category/releases">
                        Releases
                    </a>
                    —
                    <a
                        href="/author/david-robertson">
                        David Robertson
                    </a>
                </span>
                
            </header>
            <div>
                
                <p>Today we are releasing Synapse 1.47.1, a security update based on last week's release of <a href="https://matrix.org/blog/2021/11/17/synapse-1-47-0-released">Synapse 1.47.0</a>. This <a href="https://github.com/matrix-org/synapse/releases/tag/v1.47.1">release</a> patches one high severity issue affecting Synapse installations 1.47.0 and earlier using the media repository. An attacker could cause these Synapses to download a remote file and store it in a directory outside the media repository. </p>
<p>Note that:</p>
<ul>
<li>This only affects homeservers using Synapse's built-in media repository, as opposed to <a href="https://github.com/matrix-org/synapse-s3-storage-provider">synapse-s3-storage-provider</a> or <a href="https://github.com/turt2live/matrix-media-repo">matrix-media-repo</a>.</li>
<li>Attackers cannot control the exact name or destination of the stored file.</li>
</ul>
<p>To quote from the advisory:</p>
<blockquote>
<h3 id="ghsa-3hfw-x7gx-437c-cve-2021-41281-path-traversal-when-downloading-remote-media"><a href="https://github.com/matrix-org/synapse/security/advisories/GHSA-3hfw-x7gx-437c">GHSA-3hfw-x7gx-437c</a> / CVE-2021-41281: Path traversal when downloading remote media.</h3>
<h4 id="impact">Impact</h4>
<p>Synapse instances with the media repository enabled can be tricked into downloading a file from a remote server into an arbitrary directory, potentially outside the media store directory.</p>
<p>The last two directories and file name of the path are chosen randomly by Synapse and cannot be controlled by an attacker, which limits the impact.</p>
<p>Homeservers with the media repository disabled are unaffected. Homeservers configured with a federation whitelist are also unaffected.</p>
</blockquote>
<p>The <a href="https://github.com/matrix-org/synapse/security/advisories/GHSA-3hfw-x7gx-437c">advisory</a> has full details, including workarounds.</p>
<p>This issue was discovered and fixed by our internal security team.</p>
<p>Please update at your earliest convenience.</p>

                
            </div>
        </article>
        
        <article class="post">
            <header>
                <h2><a href="&#x2F;blog&#x2F;2021&#x2F;11&#x2F;18&#x2F;pre-disclosure-upcoming-security-release-of-synapse-1-47-1&#x2F;" title="Pre-disclosure: upcoming security release of Synapse 1.47.1">Pre-disclosure: upcoming security release of Synapse 1.47.1</a></h2>
                <span>
                    18.11.2021 00:00
                    —
                    <a href="/category/security">
                        Security
                    </a>
                    —
                    <a
                        href="/author/matrix-security">
                        Matrix Security
                    </a>
                </span>
                
            </header>
            <div>
                
                <p>On <strong>Tuesday, 23rd November</strong> we plan to release Synapse 1.47.1 at 12:00 UTC to address a single high severity issue. This vulnerability was discovered internally by our security team. Synapse is a Matrix homeserver implementation developed by the matrix.org team and the wider Matrix community.</p>
<p>If you're a server administrator running Synapse, <strong>please be prepared to upgrade as soon as the patched version is released</strong>.</p>
<p>We will be reaching out to downstream packagers to ensure they can prepare patched versions of affected packages at the time of the release. The details of the vulnerability will be disclosed in a blog post on the day of the release. There is so far no evidence of the vulnerability being exploited in the wild.</p>
<p>Thank you for your patience while we work to resolve this issue.</p>
<p><em>Edit, 2021-11-19: The opening paragraph was amended to note that the vulnerability was discovered internally.</em></p>
<p><em>Edit, 2021-11-22: The opening paragraph was amended to include a release time of 12:00 UTC.</em></p>

                
            </div>
        </article>
        
        <article class="post">
            <header>
                <h2><a href="&#x2F;blog&#x2F;2021&#x2F;09&#x2F;13&#x2F;vulnerability-disclosure-key-sharing&#x2F;" title="Disclosing CVE-2021-40823 and CVE-2021-40824: E2EE vulnerability in multiple Matrix clients">Disclosing CVE-2021-40823 and CVE-2021-40824: E2EE vulnerability in multiple Matrix clients</a></h2>
                <span>
                    13.09.2021 17:29
                    —
                    <a href="/category/security">
                        Security
                    </a>
                    —
                    <a
                        href="/author/denis-kasak-dan-callahan-and-matthew-hodgson">
                        Denis Kasak, Dan Callahan, and Matthew Hodgson
                    </a>
                </span>
                
            </header>
            <div>
                
                <p>Today we are disclosing a critical security issue affecting multiple Matrix clients and libraries including <a href="https://element.io/">Element</a> (Web/Desktop/Android), <a href="https://fluffychat.im/">FluffyChat</a>, <a href="https://nheko-reborn.github.io/">Nheko</a>, <a href="https://cinny.in/">Cinny</a>, and <a href="https://schildi.chat/">SchildiChat</a>. Element on iOS is not affected.</p>
<p>Specifically, in certain circumstances it may be possible to trick vulnerable clients into disclosing encryption keys for messages previously sent by that client to user accounts later compromised by an attacker.</p>
<p>Exploiting this vulnerability to read encrypted messages requires gaining control over the recipient’s account. This requires either compromising their credentials directly or compromising their homeserver.</p>
<p>Thus, the greatest risk is to users who are in encrypted rooms containing malicious servers. Admins of malicious servers could attempt to impersonate their users' devices in order to spy on messages sent by vulnerable clients in that room.</p>
<p>This is not a vulnerability in the Matrix or Olm/Megolm protocols, nor the libolm implementation. It is an implementation bug in certain Matrix clients and SDKs which support end-to-end encryption (“E2EE”).</p>
<p><strong>We have no evidence of the vulnerability being exploited in the wild</strong>.</p>
<p>This issue was discovered during an internal audit by Denis Kasak, a security researcher at Element.</p>
<h2 id="remediation-and-detection">Remediation and Detection</h2>
<p>Patched versions of affected clients are available now; please upgrade as soon as possible — we apologise sincerely for the inconvenience. If you are unable to upgrade, consider keeping vulnerable clients offline until you can. If vulnerable clients are offline, they cannot be tricked into disclosing keys. They may safely return online once updated.</p>
<p>Unfortunately, it is difficult or impossible to retroactively identify instances of this attack with standard logging levels present on both clients and servers. However, as the attack requires account compromise, homeserver administrators may wish to review their authentication logs for any indications of inappropriate access.</p>
<p>Similarly, users should review the list of devices connected to their account with an eye toward missing, untrusted, or non-functioning devices. Because an attacker must impersonate an existing or historical device, exploiting this vulnerability would either break an existing login on the user’s account, or a historical device would be re-added and flagged as untrusted.</p>
<p>Lastly, if you have previously verified the users / devices in a room, you would witness the safety shield on the room turn red during the attack, indicating the presence of an untrusted and potentially malicious device.</p>
<h2 id="affected-software">Affected Software</h2>
<p>Given the severity of this issue, Element attempted to review all known encryption-capable Matrix clients and libraries so that patches could be prepared prior to public disclosure.</p>
<p>Known <strong>vulnerable</strong> software:</p>
<ul>
<li><strong><a href="https://github.com/matrix-org/matrix-js-sdk">matrix-js-sdk</a> &lt; 12.4.1</strong> (<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-40823">CVE-2021-40823</a>), including:
<ul>
<li><a href="https://element.io/">Element</a> Web / Desktop &lt; 1.8.3</li>
<li><a href="https://schildi.chat/">SchildiChat</a> (Web / Desktop) ≤ 1.7.32-sc1</li>
<li><a href="https://cinny.in/">Cinny</a> &lt; 1.2.1</li>
</ul>
</li>
<li><strong><a href="https://github.com/matrix-org/matrix-android-sdk2">matrix-android-sdk2</a> &lt; 1.2.2</strong> (<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-40824">CVE-2021-40824</a>), including:
<ul>
<li><a href="https://element.io/">Element</a> (Android) &lt; 1.2.2</li>
<li><a href="https://schildi.chat/">SchildiChat</a> (Android) &lt; 1.2.2.sc43</li>
</ul>
</li>
<li><strong><a href="https://github.com/matrix-org/matrix-rust-sdk">matrix-rust-sdk</a> &lt; 0.4.0:</strong>
<ul>
<li><a href="https://gitlab.gnome.org/GNOME/fractal/-/tree/fractal-next">fractal-next</a> is <strong>not vulnerable</strong> due to depending on a recent enough commit.</li>
<li><a href="https://github.com/poljar/weechat-matrix-rs/">weechat-matrix-rs</a>, a rewrite of the original weechat-matrix script, had no tagged releases, but some commits did depend on vulnerable versions of the matrix-rust-sdk. Users should ensure to update to the latest master of weechat-matrix-rs, presently <a href="https://github.com/poljar/weechat-matrix-rs/commit/2b093a7ff1c75650467d61335b90e4a6ce1fa210">2b093a7</a>.</li>
</ul>
</li>
<li><strong><a href="https://gitlab.com/famedly/company/frontend/famedlysdk">FamedlySDK</a> &lt; 0.5.0</strong>, including:
<ul>
<li>Famedly &lt; 0.45.0</li>
<li><a href="https://fluffychat.im/">FluffyChat</a> &lt; 0.40.0</li>
</ul>
</li>
<li><strong><a href="https://nheko-reborn.github.io/">Nheko</a> ≤ 0.8.2</strong></li>
</ul>
<p>We believe the following software is <strong>not vulnerable:</strong></p>
<ul>
<li><strong><a href="https://github.com/matrix-org/matrix-android-sdk">matrix-android-sdk</a></strong> (deprecated!)</li>
<li><strong><a href="https://github.com/matrix-org/matrix-ios-sdk">matrix-ios-sdk</a></strong></li>
<li><strong><a href="https://github.com/poljar/matrix-nio">matrix-nio</a></strong>, including its use in<a href="https://github.com/matrix-org/pantalaimon"> Pantalaimon</a> and <a href="https://github.com/poljar/weechat-matrix">weechat-matrix</a>.</li>
</ul>
<p>We believe the following are <strong>not vulnerable</strong> due to not implementing key sharing:</p>
<ul>
<li><strong><a href="https://source.puri.sm/Librem5/chatty/-/tree/master/src/matrix">Chatty</a></strong></li>
<li><strong><a href="https://github.com/vector-im/hydrogen-web/tree/master/src/matrix">Hydrogen</a></strong></li>
<li><strong><a href="https://github.com/mautrix/go">mautrix</a></strong></li>
<li><strong><a href="https://github.com/matrix-org/purple-matrix">purple-matrix</a></strong></li>
<li><strong><a href="https://github.com/syphon-org/syphon">Syphon</a></strong></li>
</ul>
<h2 id="background">Background</h2>
<p>Matrix supports the concept of “key sharing”, letting a Matrix client which lacks the keys to decrypt a message request those keys from that user's other devices or the original sender's device.</p>
<p>This was a feature added in 2016 in order to address edge cases where a newly logged-in device might not have the necessary keys to decrypt historical messages.  Specifically, if other devices in the room are unaware of the new device due to a network partition, they have no way to encrypt for it—meaning that the only way the new device will be able to decrypt history is if the recipient's other devices share the necessary keys with it.</p>
<p>Other situations where key sharing is desirable include when the recipient hasn't backed up their keys (either online or offline) and needs them to decrypt history on a new login, or when facing implementation bugs which prevent clients from sending keys correctly. Requesting keys from a user's other devices sidesteps these issues.</p>
<p>Key sharing is described <a href="https://matrix.org/docs/guides/end-to-end-encryption-implementation-guide#key-sharing">here</a> in the Matrix E2EE Implementation Guide, which contains the following paragraph:</p>
<blockquote>
<p>In order to securely implement key sharing, clients must not reply to every key request they receive. The recommended strategy is to share the keys automatically only to verified devices of the same user. </p>
</blockquote>
<p>This is the approach taken in the original implementation in matrix-js-sdk, as used in Element Web and others, with the extension of also letting the sending device service keyshare requests from recipient devices.  Unfortunately, the implementation did not sufficiently verify the identity of the device requesting the keyshare, meaning that a compromised account can impersonate the device requesting the keys, creating this vulnerability.</p>
<p>This is not a protocol or specification bug, but an implementation bug which was then unfortunately replicated in other independent implementations.</p>
<p>While we believe we have identified and contacted all affected E2EE client implementations: if your client implements key sharing requests, we strongly recommend you check that you cryptographically verify the identity of the device which originated the key sharing request.</p>
<h2 id="next-steps">Next Steps</h2>
<p>The fact that this vulnerability was independently introduced so many times is a clear signal that the current wording in the Matrix Spec and the E2EE Implementation Guide is insufficient. We will thoroughly review the related documentation and revise it with clear guidelines on safely implementing key sharing.</p>
<p>Going further, we will also consider whether key sharing is still a necessary part of the Matrix protocol. If it is not, we will remove it. As discussed above, key sharing was originally introduced to make E2EE more reliable while we were ironing out its many edge cases and failure modes. Meanwhile, implementations have become much more robust, to the point that we may be able to go without key sharing completely. We will also consider changing how we present situations in which you cannot decrypt messages because the original sender was not aware of your presence. For example, undecryptable messages could be filed in a separate conversation thread, or those messages could require that keys are shared manually, effectively turning a bug into a feature.</p>
<p>We will also accelerate our work on matrix-rust-sdk as a portable reference implementation of the Matrix protocol, avoiding the implicit requirement that each independent library must necessarily reimplement this logic on its own. This will have the effect of reducing attack surface and simplifying audits for software which chooses to use matrix-rust-sdk.</p>
<p>Finally, we apologise to the wider Matrix community for the inconvenience and disruption of this issue.  While Element discovered this vulnerability during an internal audit of E2EE implementations, we will be funding an independent end-to-end audit of the reference Matrix E2EE implementations (not just Olm + libolm) in the near future to help mitigate the risk from any future vulnerabilities. The results of this audit will be made publicly available.</p>
<h2 id="timeline">Timeline</h2>
<p>Ultimately, Element took two weeks from initial discovery to completing an audit of all known, public E2EE implementations. It took a further week to coordinate disclosure, culminating in today's announcement.</p>
<ul>
<li>Monday, 23rd August — Discovery that Element Web is exploitable.</li>
<li>Thursday, 26th August — Determination that Element Android is exploitable with a modified attack.</li>
<li>Wednesday, 1 September — Determination that Element iOS fails safe in the presence of device changes.</li>
<li>Friday, 3 September — Determination that FluffyChat and Nheko are exploitable.</li>
<li>Tuesday, 7th September — Audit of Matrix clients and libraries complete.</li>
<li>Wednesday, 8th September — Affected software authors contacted, disclosure timelines agreed.</li>
<li>Friday, 10th September —<a href="https://matrix.org/blog/2021/09/10/pre-disclosure-upcoming-critical-fix-for-several-popular-matrix-clients"> Public pre-disclosure notification</a>. Downstream packagers (e.g., Linux distributions) notified via Matrix and e-mail.</li>
<li>Monday, 13th September — Coordinated releases of all affected software, public disclosure.</li>
</ul>

                
            </div>
        </article>
        
        <article class="post">
            <header>
                <h2><a href="&#x2F;blog&#x2F;2021&#x2F;09&#x2F;10&#x2F;pre-disclosure-upcoming-critical-fix-for-several-popular-matrix-clients&#x2F;" title="Pre-disclosure: upcoming critical fix for several popular Matrix clients">Pre-disclosure: upcoming critical fix for several popular Matrix clients</a></h2>
                <span>
                    10.09.2021 16:43
                    —
                    <a href="/category/security">
                        Security
                    </a>
                    —
                    <a
                        href="/author/matrix-security">
                        Matrix Security
                    </a>
                </span>
                
            </header>
            <div>
                
                <p>Hi all,</p>
<p>A critical security vulnerability impacting several popular Matrix clients and libraries was recently discovered. A coordinated security release of the affected components will be happening in the afternoon (from an UTC perspective) of <strong>Monday, Sept 13th</strong>.</p>
<p>We will be reaching out to downstream packagers to ensure they can prepare patched versions of affected packages at the time of the release. The details of the vulnerability will be disclosed in a blog post on the day of the release. There is so far no evidence of the vulnerability being exploited in the wild.</p>
<p><strong>Please be prepared to upgrade as soon as the patched versions are released.</strong></p>
<p>Thank you for your patience while we work to resolve this issue.</p>

                
            </div>
        </article>
        
        <article class="post">
            <header>
                <h2><a href="&#x2F;blog&#x2F;2021&#x2F;08&#x2F;31&#x2F;synapse-1-41-1-released&#x2F;" title="Synapse 1.41.1 released">Synapse 1.41.1 released</a></h2>
                <span>
                    31.08.2021 00:00
                    —
                    <a href="/category/releases">
                        Releases
                    </a>
                    —
                    <a
                        href="/author/dan-callahan">
                        Dan Callahan
                    </a>
                </span>
                
            </header>
            <div>
                
                <p>Today we are releasing Synapse 1.41.1, a security update based on last week's release of <a href="https://matrix.org/blog/2021/08/24/synapse-1-41-0-released">Synapse 1.41.0</a>. This release patches two moderate severity issues which could reveal metadata about private rooms:</p>
<ul>
<li>
<p><strong><a href="https://github.com/matrix-org/synapse/security/advisories/GHSA-3x4c-pq33-4w3q">GHSA-3x4c-pq33-4w3q</a> / CVE-2021-39164: Enumerating a private room's list of members and their display names.</strong></p>
<p>If an unauthorized user both knows the Room ID of a private room <em>and</em> that room's history visibility is set to <code>shared</code>, then they may be able to enumerate the room's members, including their display names.</p>
<p>The unauthorized user must be on the same homeserver as a user who is a member of the target room.</p>
</li>
<li>
<p><strong><a href="https://github.com/matrix-org/synapse/security/advisories/GHSA-jj53-8fmw-f2w2">GHSA-jj53-8fmw-f2w2</a> / CVE-2021-39163: Disclosing a private room's name, avatar, topic, and number of members.</strong></p>
<p>If an unauthorized user knows the Room ID of a private room, then its name, avatar, topic, and number of members may be disclosed through Group / Community features.</p>
<p>The unauthorized user must be on the same homeserver as a user who is a member of the target room, and their homeserver must allow non-administrators to create groups (<code>enable_group_creation</code> in the Synapse configuration; off by default).</p>
</li>
</ul>
<p>Note that in both cases:</p>
<ul>
<li>The private room's Room ID must be known to the attacker.</li>
<li>Another user on the attacker's homeserver must be a legitimate member of the target room.</li>
<li>The information disclosed is <em>already</em> present in the database and thus legitimately known to the administrators of homeservers participating in the target room.</li>
</ul>
<p>We'd like to credit <a href="https://twitter.com/0xkasper">0xkasper</a> for discovering and responsibly disclosing these issues.</p>
<p>This release also fixes a small regression in 1.41.0 (<a href="https://github.com/matrix-org/synapse/issues/10709">#10709</a>) which broke compatibility with older Twisted versions when Synapse was a configured to send email.</p>
<p>Please update at your earliest convenience.</p>

                
            </div>
        </article>
        
        <article class="post">
            <header>
                <h2><a href="&#x2F;blog&#x2F;2021&#x2F;06&#x2F;30&#x2F;security-update-synapse-1-37-1-released&#x2F;" title="Security update: Synapse 1.37.1 released">Security update: Synapse 1.37.1 released</a></h2>
                <span>
                    30.06.2021 00:00
                    —
                    <a href="/category/releases">
                        Releases
                    </a>
                    —
                    <a
                        href="/author/matthew-hodgson">
                        Matthew Hodgson
                    </a>
                </span>
                
            </header>
            <div>
                
                <p>Hi all,</p>
<p>Over the last few days we've seen a distributed spam attack across the public Matrix network, where large numbers of spambots have been registered across servers with open registration and then used to flood abusive traffic into rooms such as Matrix HQ.</p>
<p>The spam itself has been handled by <a href="https://matrix.org/docs/guides/moderation#banning-servers">temporarily banning the abused servers</a>. However, on Monday and Tuesday the volume of traffic triggered performance problems for the homeservers participating in targeted rooms (e.g. memory explosions, or very delayed federation).  This was due to a combination of factors, but one of the most important ones was Synapse issue <a href="https://github.com/matrix-org/synapse/issues/9490">#9490</a>: that one busy room could cause head-of-line blocking, starving your server from processing events in other rooms, causing all traffic to fall behind.</p>
<p>We're happy to say that Synapse 1.37.1 <a href="https://github.com/matrix-org/synapse/pull/10272">fixes this</a> and we now process inbound federation traffic asynchronously, ensuring that one busy room won't impact others.  First impressions are that this has significantly improved federation performance and end-to-end encryption stability — for instance, new E2EE keys from remote users for a given conversation should arrive immediately rather than being blocked behind other traffic.</p>
<p><strong>Please upgrade to Synapse 1.37.1 as soon as possible, in order to increase resilience to any other traffic spikes.</strong></p>
<p><strong>Also, we highly recommend that you disable open registration or, if you keep it enabled, use SSO or require email validation to avoid abusive signups. Empirically adding a CAPTCHA is not enough. Otherwise you may find your server blocked all over the place if it is hosting spambots.</strong></p>
<p><strong>Finally, if your server has open registration, PLEASE check whether spambots have been registered on your server, and deactivate them.  Once deactivated, you will need to contact abuse@matrix.org to request that blocks on your server are removed</strong>.</p>
<p>Your best bet for spotting and neutralising dormant spambots is to review signups on your homeserver over the past 3-5 days and deactivate suspicious users. We do not recommend relying solely on lists of suspicious IP addresses for this task, as the distributed nature of the attack means any such list is likely to be incomplete or include shared proxies which may also catch legitimate users.</p>
<p>To ease review, we're working on an auditing script in <a href="https://github.com/matrix-org/synapse/pull/10290">#10290</a>; feedback on whether this is useful would be appreciated. Problematic accounts can then be dealt with using the <a href="https://matrix-org.github.io/synapse/v1.37/admin_api/user_admin_api.html#deactivate-account">Deactivate Account Admin API</a>.</p>
<p>Meanwhile, over to Dan for the Synapse 1.37 release notes.</p>
<h2 id="synapse-1-37-release-announcement">Synapse 1.37 Release Announcement</h2>
<p>Synapse 1.37 is now available!</p>
<blockquote>
<p>**Note: ** The legacy APIs for Spam Checker extension modules are now considered deprecated and targeted for removal in August. Please see <a href="https://matrix-org.github.io/synapse/v1.37/modules.html#porting-an-existing-module-that-uses-the-old-interface">the module docs</a> for information on updating.</p>
<p>This release also removes Synapse's built-in support for the obsolete ACMEv1 protocol for automatically obtaining TLS certificates. Server administrators should place Synapse behind a <a href="https://matrix-org.github.io/synapse/v1.37/reverse_proxy.html">reverse proxy</a> for TLS termination, or switch to a standalone ACMEv2 client like <a href="https://certbot.eff.org/">certbot</a>.</p>
</blockquote>
<h3 id="knock-knock">Knock, knock?</h3>
<p>After nearly 18 months and 129 commits, Synapse now includes support for <a href="https://github.com/matrix-org/matrix-doc/pull/2403">MSC2403: Add &quot;knock&quot; feature</a> and <a href="https://spec.matrix.org/unstable/rooms/v7/">Room Version 7</a>! This feature allows users to directly request admittance to private rooms, without having to track down an invitation out-of-band. One caveat: Though the server-side foundation is there, knocking is not <em>yet</em> implemented in clients.</p>
<h3 id="a-unified-interface-for-extension-modules">A Unified Interface for Extension Modules</h3>
<p>Third party modules can customize Synapse's behavior, implementing things like bespoke media storage providers or user event filters. However, Synapse previously lacked a unified means of enumerating and configuring third-party modules. That changes with Synapse 1.37, which introduces a new, <a href="https://matrix-org.github.io/synapse/v1.37/modules.html">generic interface for extensions</a>.</p>
<p>This new interface consolidates configuration into one place, allowing for more flexibility and granularity by explicitly registering callbacks with specific hooks. You can learn more about the new module API in the docs linked above, or in <a href="https://www.youtube.com/playlist?list=PLl5dnxRMP1hULbP8MYk2noPKFCFyg-SHK">Matrix Live</a> S6E29, due out this Friday, July 2nd.</p>
<h3 id="safer-reauthentication">Safer Reauthentication</h3>
<p>User-interactive authentication (&quot;UIA&quot;) is required for potentially dangerous actions like removing devices or uploading cross-signing keys. However, Synapse can optionally be configured to provide a brief grace period such that users are not prompted to re-authenticate on actions taken shortly after logging in or otherwise authenticating.</p>
<p>This improves user experience, but also creates risks for clients which rely on UIA as a guard against actions like account deactivation. Synapse 1.37 protects users by exempting especially risky actions from the grace period. See <a href="https://github.com/matrix-org/synapse/pull/10184">#10184</a> for details.</p>
<h3 id="smaller-improvements">Smaller Improvements</h3>
<p>We've landed a number of smaller improvements which, together, make Synapse more responsive and reliable. We now:</p>
<ul>
<li>More efficiently respond to key requests, preventing excessive load (<a href="https://github.com/matrix-org/synapse/pull/10221">#10221</a>, <a href="https://github.com/matrix-org/synapse/pull/10144">#10144</a>)</li>
<li>Render docs for each <code>vX.Y</code> Synapse release, starting with v1.37 (<a href="https://github.com/matrix-org/synapse/pull/10198">#10198</a>)</li>
<li>Ensure that log entries from failures during early startup are not lost (<a href="https://github.com/matrix-org/synapse/pull/10191">#10191</a>)</li>
<li>Have a notion of database schema &quot;compatibility versions&quot;, allowing for more graceful upgrades and downgrades of Synapse (<a href="https://matrix-org.github.io/synapse/v1.37/development/database_schema.html#synapse-schema-versions">docs</a>)</li>
</ul>
<p>We've also resolved two bugs which could cause sync requests to immediately return with empty payloads (<a href="https://github.com/matrix-org/synapse/issues/8518">#8518</a>), producing a tight loop of repeated network requests.</p>
<h3 id="everything-else">Everything Else</h3>
<p>Lastly, we've merged an experimental implementation of <a href="https://github.com/matrix-org/matrix-doc/pull/2716">MSC2716: Incrementally importing history into existing rooms</a> (<a href="https://github.com/matrix-org/synapse/pull/9247">#9247</a>) as part of Element's work to fully <a href="https://matrix.org/blog/2020/09/30/welcoming-gitter-to-matrix">integrate Gitter into Matrix</a>.</p>
<p>These are just the highlights; please see the <a href="https://github.com/matrix-org/synapse/blob/v1.37.1/UPGRADE.rst#upgrading-to-v1370">Upgrade Information</a> and <a href="https://github.com/matrix-org/synapse/blob/v1.37.1/CHANGES.md">Release Notes</a> for a complete list of changes in this release.</p>
<p>Synapse is a Free and Open Source Software project, and we'd like to extend our thanks to everyone who contributed to this release, including <a href="https://github.com/aaronraimist">aaronraimist</a>, <a href="https://github.com/Bubu">Bubu</a>, <a href="https://github.com/dklimpel">dklimpel</a>, <a href="https://github.com/jkanefendt">jkanefendt</a>, <a href="https://github.com/lukaslihotzki">lukaslihotzki</a>, <a href="https://github.com/mikure">mikure</a>, and <a href="https://github.com/Sorunome">Sorunome</a>,</p>

                
            </div>
        </article>
        
        <article class="post">
            <header>
                <h2><a href="&#x2F;blog&#x2F;2021&#x2F;06&#x2F;14&#x2F;adventures-in-fuzzing-libolm&#x2F;" title="Adventures in fuzzing libolm">Adventures in fuzzing libolm</a></h2>
                <span>
                    14.06.2021 00:00
                    —
                    <a href="/category/security">
                        Security
                    </a>
                    —
                    <a
                        href="/author/denis-kasak">
                        Denis Kasak
                    </a>
                </span>
                
            </header>
            <div>
                
                <h2 id="introduction">Introduction</h2>
<p>Hi all! My name is Denis and I'm a <a href="https://dkasak.github.io/">security
researcher</a>. Six months ago, I started working for
Element on doing dedicated security research on important Matrix projects.
After some initial focus on Synapse, I decided to take a closer look at
<a href="https://gitlab.matrix.org/matrix-org/olm">libolm</a>. In this entry, I'd like to
present an overview of that work, along with some early fruits that came out of
it.</p>
<p><strong>TL;DR: we found some bugs which had crept in since libolm's original audit in
2016, thanks to properly overhauling our fuzzing capability, and we'd like to
tell you all about it! The bugs were not easily exploitable (if at all), and
have already been fixed.</strong></p>
<p><strong>Update:
<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-34813">CVE-2021-34813</a>
has now been assigned to this.</strong></p>
<p>To give a bit of a background, libolm is a cryptographic library implementing
the <a href="https://en.wikipedia.org/wiki/Double_Ratchet_Algorithm">Double Ratchet
Algorithm</a> pioneered by
Signal and it is the cryptographic workhorse behind Matrix. The classic
algorithm is called Olm in Matrix land, but libolm also implements Megolm which
is a variant for efficient encrypted group chats between many participants.</p>
<p>Since libolm is currently used in all Matrix clients supporting end-to-end
encryption, it makes for a particularly juicy target. The present state of
libolm's monopoly on Matrix encryption is somewhat unfortunate -- luckily there
are some exciting new developments on the horizon, such as the
<a href="https://github.com/matrix-org/matrix-rust-sdk/tree/vodozemac-bench">vodozemac</a>
implementation in Rust. But for now, we're stuck with libolm.</p>
<p>To start, I decided to do a bit of fuzzing. libolm already had a fuzzing setup
using AFL, but it was written a while ago. The state of the art in fuzzing had
advanced quite rapidly in the last few years, so the setup was missing many
modern features and techniques. As an example, the fuzzing setup was configured
to use the now ancient afl-gcc coverage mode, which can be slower than the more
modern LLVM-based coverage by a factor of 2.</p>
<p>I also noticed that the fuzzing was done with non-hardened binaries (instead of
using something like ASAN), so many memory errors could've gone unnoticed.
There were also no corpora available from previous fuzzing runs and some of the
newer code was not covered by the harnesses.</p>
<h2 id="preparation">Preparation</h2>
<p>I decided to tackle these one by one, adding ASAN and MSAN builds as a first
step. I took the opportunity to switch to <a href="https://aflplus.plus/">AFL++</a> since
it is a drop-in replacement and contains numerous improvements, notably
improved coverage modes which are either much faster (e.g. LLVM-PCGUARD) or
guaranteed to have no collisions (LTO)<sup class="footnote-reference"><a href="#1">1</a></sup>. AFL++ also optimizes mutation
scheduling (by using scheduling algorithms from
<a href="https://github.com/mboehme/aflfast">AFLFast</a>) and mutation operator selection
(through <a href="https://github.com/puppet-meteor/MOpt-AFL">MOpt</a>). All of this makes
it much more efficient at discovering bugs.</p>
<p>After this, I changed the existing harnesses to use AFL's persistent mode
(which lowers process creation overhead and thus increases fuzzing
performance). This change, combined with the switch to a newer coverage mode,
increased the fuzzing exec/s from ~2.5k to ~5.5k on my machine, so this is not
an insignificant gain!</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>In the context of fuzzing, collisions are situations where
two different execution paths appear to the fuzzer as the same one due to
technical limitations.
Classically, AFL tracks coverage by tracking so-called &quot;edges&quot; (or &quot;tuples&quot;).
Edges are really pairs of (A, B), where A and B represent basic blocks. Each
edge is meant to represent a different execution &quot;jump&quot;, but sometimes, as
the number of basic blocks in a program grows, two different execution paths
can end up being encoded as the same edge. LTO mode in AFL++ does some magic
so that this is guaranteed not to happen.</p>
</div>
<p>After this preparatory work, I generated a small initial corpus and ran a small
fleet of fuzzers with varying parameters. Almost immediately, I started getting
heaps of crashes. Luckily, after some investigation, these turned out not to be
serious bugs in the library but a double-free in the fuzzing harness! The
double-free only got triggered when the input was of size 0. It also only
happened with AFL++ and not vanilla AFL, presumably due to differences in input
trimming logic, which must be the reason no one noticed this earlier. I quickly
came up with a patch and resumed.</p>
<h2 id="the-plot-thickens">The plot thickens</h2>
<p>I let the fuzzers run for a while. Since ASAN introduces a bit of a performance
overhead, I only run a single AFL instance with ASAN variant of the binary.
This is okay because all fuzzer instances actually synchronize their findings,
which means every instance gets to see every input which increases coverage.
When I came back to check, there was another crash waiting. This time the
crashing input wasn't being generated continually so it looked much more
promising -- and only the ASAN instance was crashing. <em>A-ha</em>!</p>
<p>Running the offending input on the ASAN variant of the harness revealed it was
an invalid read one byte past the end of a heap buffer. The read was happening
in the base64 decoder:</p>
<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>❮ ./build/fuzzers/fuzz_group_decrypt_asan &quot;&quot; pickled-inbound-group-session.txt &lt;input
</span><span>=================================================================
</span><span>==1838065==ERROR: AddressSanitizer: heap-buffer-overflow on address 0xf4a00795 at pc 0x56560660 bp 0xffff9df8 sp 0xffff9de8
</span><span>READ of size 1 at 0xf4a00795 thread T0
</span><span>    #0 0x5656065f in olm::decode_base64(unsigned char const*, unsigned int, unsigned char*) src/base64.cpp:124
</span><span>    #1 0x565607b5 in _olm_decode_base64 src/base64.cpp:165
</span><span>    #2 0x565d5a9e in olm_group_decrypt_max_plaintext_length src/inbound_group_session.c:304
</span><span>    #3 0x56558e75 in main fuzzers/fuzz_group_decrypt.cpp:46
</span><span>    #4 0xf7509a0c in __libc_start_main (/usr/lib32/libc.so.6+0x1ea0c)
</span><span>    #5 0x5655a0f4 in _start (/home/dkasak/code/olm/build/fuzzers/fuzz_group_decrypt_asan+0x50f4)
</span><span>
</span><span>0xf4a00795 is located 0 bytes to the right of 5-byte region [0xf4a00790,0xf4a00795)
</span><span>allocated by thread T0 here:
</span><span>    #0 0xf7a985c5 in __interceptor_malloc /build/gcc/src/gcc/libsanitizer/asan/asan_malloc_linux.cpp:145
</span><span>    #1 0x56558ce3 in main fuzzers/fuzz_group_decrypt.cpp:32
</span><span>    #2 0xf7509a0c in __libc_start_main (/usr/lib32/libc.so.6+0x1ea0c)
</span><span>
</span><span>SUMMARY: AddressSanitizer: heap-buffer-overflow src/base64.cpp:124 in olm::decode_base64(unsigned char const*, unsigned int, unsigned char*)
</span><span>Shadow bytes around the buggy address:
</span><span>  0x3e9400a0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span>  0x3e9400b0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span>  0x3e9400c0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span>  0x3e9400d0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span>  0x3e9400e0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span>=&gt;0x3e9400f0: fa fa[05]fa fa fa 05 fa fa fa fa fa fa fa fa fa
</span><span>  0x3e940100: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span>  0x3e940110: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span>  0x3e940120: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span>  0x3e940130: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span>  0x3e940140: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span><span>Shadow byte legend (one shadow byte represents 8 application bytes):
</span><span>  Addressable:           00
</span><span>  Partially addressable: 01 02 03 04 05 06 07 
</span><span>  Heap left redzone:       fa
</span><span>  Freed heap region:       fd
</span><span>  Stack left redzone:      f1
</span><span>  Stack mid redzone:       f2
</span><span>  Stack right redzone:     f3
</span><span>  Stack after return:      f5
</span><span>  Stack use after scope:   f8
</span><span>  Global redzone:          f9
</span><span>  Global init order:       f6
</span><span>  Poisoned by user:        f7
</span><span>  Container overflow:      fc
</span><span>  Array cookie:            ac
</span><span>  Intra object redzone:    bb
</span><span>  ASan internal:           fe
</span><span>  Left alloca redzone:     ca
</span><span>  Right alloca redzone:    cb
</span><span>  Shadow gap:              cc
</span><span>==1838065==ABORTING
</span></code></pre>
<p>Following the stack trace, I quickly pinpointed the root of the bug: the logic
of the decoder was subtly flawed, unconditionally accessing a remainder
byte<sup class="footnote-reference"><a href="#2">2</a></sup> in the base64 input which might not actually be there.
This occurs when the input is 1 (mod 4) in length, which can never happen in
a <em>valid</em> base64 payload, but of course we cannot assume all inputs are
necessarily valid payloads. Specifically, if the payload was not 0 (mod 4) in
length, the code was assuming it was at least 2 (mod 4) or more in length and
immediately read the second byte. This spurious byte was then incorporated into
the output value.</p>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p>By <em>remainder byte</em>, I mean bytes which are not part of
a group of 4. These can only occur at the end of a base64 payload and they're
the ones that get suffixed with padding in padded base64.</p>
</div>
<p>I examined the code in an attempt to find a way to have it leak more than
a single byte, but it was impossible. As it turned out, not even the full byte
of useful information was encoded into the output -- due to the way the byte is
encoded, only about 6 bits of useful information ended up in the output value.</p>
<p>Still, even a single leaked bit is too much in a cryptographic context. Could
we do some heap hacking so that something of interest is placed there and then
have it be leaked to us?</p>
<p>I next tracked down all call sites of the vulnerable function
<code>olm::decode_base64</code>. Most of them were immune to the problem since they were
preceded with calls to another function, <code>olm::decode_base64_length</code>, which
checks that the base64 payload is of legal length. This left me with only a few
potentially vulnerable call sites, so I examined where their base64 inputs come
from. Promisingly, two of them received input from other conversation
participants, but they either had no way of leaking the information back to the
attacker or they hardcoded the number of bytes to be processed, after ensuring
the input was of some minimum length. The output of the remaining function
<a href="https://gitlab.matrix.org/matrix-org/olm/-/blob/0a7b6da9a0959694303d5b0724a09e63e8c217ab/src/pk.cpp#L352"><code>olm_pk_decrypt</code></a> is never sent anywhere externally, so there
was again no way of leaking the data to the attacker.</p>
<p>In conclusion, even though this invalid read is a valid bug, I was not able to
find a working exploit for it.</p>
<p>But wait a second! Something was still bothering me about <code>olm_pk_decrypt</code>.
It's a fairly complex function, <em>receives several string inputs from the
homeserver</em> and it itself isn't tested by any of the harnesses. Furthermore,
the reason I started looking at it in the first place is that it was missing
the <code>olm::decode_base64_length</code> check. Perhaps it warrants a closer look?</p>
<h2 id="it-does">It does</h2>
<p>And sure enough, there was something amiss. As <code>olm_pk_decrypt</code> receives three
base64 inputs from the homeserver: the ciphertext to decrypt, an ephemeral
public key and a MAC. All three are eventually passed to <code>olm::decode_base64</code>
to be decoded. Yet there was only a single length check there, to ensure the
decrypted ciphertext would fit its output buffer. What would happen if the
server returned a public key that was longer than expected?</p>
<pre data-lang="c++" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-c++ "><code class="language-c++" data-lang="c++"><span style="color:#569cd6;">struct</span><span> _olm_curve25519_public_key ephemeral;
</span><span>olm::decode_base64(
</span><span>    (</span><span style="color:#569cd6;">const </span><span>uint8_t</span><span style="color:#569cd6;">*</span><span>)ephemeral_key, ephemeral_key_length,
</span><span>    (uint8_t </span><span style="color:#569cd6;">*</span><span>)ephemeral.public_key
</span><span>);
</span></code></pre>
<p>As can be seen from the snippet, the decoded version of public key gets written
to <code>ephemeral.public_key</code>, which is an array allocated on the stack. If the
input is longer than expected, this will become a stack buffer overflow.</p>
<p>The purpose of <code>olm_pk_decrypt</code> is to decrypt secrets previously stored by
a Matrix device on the homeserver. The point of encryption is to prevent the
server from learning these secrets since they're supposed to be known only by
your own devices. One use case for this mechanism is to allow one of your
devices to store encrypted end-to-end encryption keys on the homeserver. Your
other devices can then retrieve those keys from the homeserver, making it
possible to view all of your private conversations on each of your devices.</p>
<p>I decided to go for an end-to-end test to confirm the bug is triggerable by
connecting with the latest Element Android from my test phone to my homeserver,
with <a href="https://mitmproxy.org/">mitmproxy</a> sitting in between. This allowed me to
write a small mitmproxy script which intercepts HTTP calls fetching the E2E
encryption keys from the homeserver and modifies the response so that the key
is longer than expected.</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#9b9b9b;">import </span><span>json
</span><span>
</span><span style="color:#9b9b9b;">from </span><span>mitmproxy </span><span style="color:#9b9b9b;">import </span><span>ctx, http
</span><span>
</span><span>
</span><span style="color:#569cd6;">def </span><span>response(flow: http.HTTPFlow) -&gt; </span><span style="color:#569cd6;">None</span><span>:
</span><span>    </span><span style="color:#569cd6;">if </span><span>(</span><span style="color:#d69d85;">&quot;/_matrix/client/unstable/room_keys/keys&quot; </span><span style="color:#569cd6;">in </span><span>flow.request.pretty_url
</span><span>            </span><span style="color:#569cd6;">and </span><span>flow.request.method == </span><span style="color:#d69d85;">&quot;GET&quot;</span><span>):
</span><span>
</span><span>        response_body = flow.response.content.decode(</span><span style="color:#d69d85;">&quot;utf-8&quot;</span><span>)
</span><span>        response_json = json.loads(response_body)
</span><span>
</span><span>        rooms = response_json[</span><span style="color:#d69d85;">&quot;rooms&quot;</span><span>]
</span><span>        room_id = list(rooms.keys())[</span><span style="color:#b5cea8;">0</span><span>]
</span><span>
</span><span>        sessions = rooms[room_id][</span><span style="color:#d69d85;">&quot;sessions&quot;</span><span>]
</span><span>        session = list(sessions.keys())[</span><span style="color:#b5cea8;">0</span><span>]
</span><span>        session_data = sessions[session][</span><span style="color:#d69d85;">&quot;session_data&quot;</span><span>]
</span><span>
</span><span>        ephemeral = session_data[</span><span style="color:#d69d85;">&quot;ephemeral&quot;</span><span>]
</span><span>        ctx.log.info(</span><span style="color:#569cd6;">f</span><span style="color:#d69d85;">&quot;Replacing ephemeral key &#39;</span><span>{ephemeral}</span><span style="color:#d69d85;">&#39; with &#39;</span><span>{ephemeral * </span><span style="color:#b5cea8;">10</span><span>}</span><span style="color:#d69d85;">&#39;&quot;</span><span>)
</span><span>        session_data[</span><span style="color:#d69d85;">&quot;ephemeral&quot;</span><span>] = ephemeral * </span><span style="color:#b5cea8;">10
</span><span>
</span><span>        modified_body = json.dumps(response_json).encode(</span><span style="color:#d69d85;">&quot;utf-8&quot;</span><span>)
</span><span>        flow.response.content = modified_body
</span></code></pre>
<p>This longer value is then eventually passed by Element Android to libolm's
<code>olm_pk_decrypt</code>, which triggers the buffer overflow. With all of that in
place, I deleted the local encryption key backup on my device and asked for it
to be restored from the server:</p>
<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>F libc    : stack corruption detected (-fstack-protector)
</span><span>F libc    : Fatal signal 6 (SIGABRT), code -6 (SI_TKILL) in tid 24517 (DefaultDispatch), pid 24459 (im.vector.app)
</span><span>F DEBUG   : *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***
</span><span>F DEBUG   : Build fingerprint: &#39;xiaomi/tissot/tissot_sprout:9/PKQ1.180917.001/V10.0.24.0.PDHMIXM:user/release-keys&#39;
</span><span>F DEBUG   : Revision: &#39;0&#39;
</span><span>F DEBUG   : ABI: &#39;arm64&#39;
</span><span>F DEBUG   : pid: 24459, tid: 24517, name: DefaultDispatch  &gt;&gt;&gt; im.vector.app &lt;&lt;&lt;
</span><span>F DEBUG   : signal 6 (SIGABRT), code -6 (SI_TKILL), fault addr --------
</span><span>F DEBUG   : Abort message: &#39;stack corruption detected (-fstack-protector)&#39;
</span><span>F DEBUG   :     x0  0000000000000000  x1  0000000000005fc5  x2  0000000000000006  x3  0000000000000008
</span><span>F DEBUG   :     x4  0000000000000000  x5  0000000000000000  x6  0000000000000000  x7  0000000000000030
</span><span>F DEBUG   :     x8  0000000000000083  x9  7d545b4513138652  x10 0000000000000000  x11 fffffffc7ffffbdf
</span><span>F DEBUG   :     x12 0000000000000001  x13 0000000060b0f2a9  x14 0022ed916fede200  x15 0000d925cd93f18f
</span><span>F DEBUG   :     x16 00000079e741b2b0  x17 00000079e733c9d8  x18 0000000000000000  x19 0000000000005f8b
</span><span>F DEBUG   :     x20 0000000000005fc5  x21 0000007940e3c400  x22 000000000000026b  x23 00000000000001d0
</span><span>F DEBUG   :     x24 000000000000002f  x25 000000793d9653f0  x26 0000007948303368  x27 0000007945dd5588
</span><span>F DEBUG   :     x28 00000000000001d0  x29 0000007945dd37d0
</span><span>F DEBUG   :     sp  0000007945dd3790  lr  00000079e732e00c  pc  00000079e732e034
</span></code></pre>
<h3 id="impact">Impact</h3>
<p>This vulnerability is a server-controlled stack buffer overflow in Matrix
clients supporting room key backup.</p>
<p>Of course, the largest fear stemming from any remotely controlled stack buffer
overflow is code execution. This is perhaps even doubly so in a cryptographic
library, where we have the additional worry of an attacker being able to leak
our dearly protected conversations.</p>
<p>The federated architecture of Matrix may be somewhat of a mitigating
circumstance in this case, since users are much more likely to know and trust
the homeserver owner, but we don't want to have to rely on this trust.</p>
<h4 id="native-binaries">Native binaries</h4>
<p>Luckily, on its own, this bug is not enough to successfully execute code on
native binaries. By default, libolm is compiled for all supported targets with
stack canaries (also called stack protectors or stack cookies), which are magic
values unknown to the attacker, placed just before the current function's frame
on the stack. This value is checked upon returning from the function -- if its
value is changed, the process aborts itself to prevent further damage. This is
evident from the <code>Abort message: 'stack corruption detected (-fstack-protector)'</code> message above. Besides canaries, other system-level
protections exist to make exploiting bugs such as this harder, such as ASLR.</p>
<p>Therefore, to achieve remote code execution, an attacker would need to find
additional vulnerabilities which would allow him to exfiltrate the stack canary
and addresses of key memory locations from the system.</p>
<h4 id="wasm">WASM</h4>
<p>With WASM, the analysis is much more complicated due to its very different
memory and execution model. In WASM, the unmanaged stack is generally much more
vulnerable due to it missing support for stack canaries. This implies a stack
buffer overflow can not only overwrite the frame of the function in which the
overflow occurred but also <em>all parent frames</em>.</p>
<p>On the other hand, due to typed calls and much stronger control-flow integrity
techniques, it's much harder for the attacker to make the code do something
that is (maliciously) useful. Notably, return addresses live outside unmanaged
memory and are out of reach to the attacker. Because of this, the primary way
of influencing code execution is by manipulating <code>call_indirect</code> instructions
in such a way as to call.</p>
<p>The analysis of the impact of this bug on the WASM binary is thus left as an
exercise to the reader. If you're interested, the 2020 USENIX paper <a href="https://www.usenix.org/conference/usenixsecurity20/presentation/lehmann">Everything
Old is New Again: Binary Security of WebAssembly</a>
is a great starting point.</p>
<h2 id="the-fix">The fix</h2>
<p>Once the problems were identified, <a href="https://gitlab.matrix.org/matrix-org/olm/-/commit/e82f2601b0dc2a69d3167499ee969555267b7aa6">the patches</a> were <a href="https://gitlab.matrix.org/matrix-org/olm/-/commit/ccc0d122ee1b4d5e5ca4ec1432086be17d5f901b">rather
trivial</a> and the issues were promptly resolved. The first libolm
release that includes the fix is 3.2.3 which was released on 2021-05-25.</p>
<p>We reached out to all Matrix clients which were determined to be affected. The
Element client versions which first fix the issue are as follows:</p>
<ul>
<li>Element Web/Desktop: v1.7.29</li>
<li>Element Android: v1.1.9</li>
<li>Element iOS: v1.4.0</li>
</ul>
<p>For the mobile clients, these versions are already available in their
respective application stores at the time of publishing this post. If you
haven't already, please upgrade.</p>
<h2 id="future-work">Future work</h2>
<p>Even though the fuzzing setup is in a much better shape now (or rather will be,
since I still have some PRs to merge upstream), there's still a lot that can be
done to further improve it.</p>
<p>Right now, there are undoubtedly parts of the codebase that are not fuzzed
well. The reasons for this range from the obvious, like some parts of the code
simply not being called by any the existing harnesses, to more subtle ones such
as the fact that cryptographic operations form a nearly-insurmountable natural
barrier for naive fuzzing operations<sup class="footnote-reference"><a href="#3">3</a></sup>. Finally, some of
the existing harnesses accept additional parameters as command-line arguments,
meaning we would have to re-run the same harness with different values of those
parameters in order to reach full coverage of the code. This is suboptimal.</p>
<p>So the plan for future work is roughly as follows:</p>
<ol>
<li>Write missing harnesses to cover more portions of the codebase.</li>
<li>Write starting corpus generators. These should generate believable, valid
input for each of the harnesses. For example, for the decryption harness, we
should generate a variety of encrypted messages: empty, short, long, text,
binary, etc.</li>
<li>Modify the harnesses so that their extra parameters are determined from the
fuzzed input. This will allow the fuzzer to vary these itself, which reduces
the importance of the human in the loop and makes it harder to forget some
combination.</li>
<li>Fuzz for some time until coverage stops increasing. The corpora generated
should be saved so that future fuzzing attempts can resume from an earlier
point so that this work is not wasted.</li>
<li>Use afl-cov to investigate which parts of the code are not covered well or
at all. This should inform us what further changes are needed.</li>
<li>Write intelligent, custom mutators. These will allow the fuzzer to take
a valid input and easily produce another valid input instead of only
corrupting it with a high probability.</li>
<li>Design harnesses which test for wanted semantic properties instead of only
memory errors.</li>
</ol>
<div class="footnote-definition" id="3"><sup class="footnote-definition-label">3</sup>
<p>Classic fuzzers famously have a hard time
circumventing magic values and checksums, and cryptography is full of these.
This is further complicated by the fact that the double ratchet algorithm is
very stateful and depends on the two ratchets evolving in lockstep. This
means that even if, for example, the decryption harness is supplied with
a corpus of valid encrypted messages, the mutations done by the fuzzer would
only manage to produce corrupted versions of those messages which will fail
to decrypt, but it will ~never manage to produce a different <em>valid</em>
encrypted message.</p>
</div>
<p>It's very exciting that we're able to do full-time security research on Matrix
these days (thanks to Element's funding), and going forwards we'll publish any
interesting discoveries for the visibility and education of the whole Matrix
community. We'd also like to remind everyone that we run an official <a href="https://matrix.org/security-disclosure-policy/">Security
Disclosure Policy</a> for
Matrix.org and we'd welcome other researchers to come join our Hall of Fame!
(And hopefully we will get more bounty programmes running in future.)</p>

                
            </div>
        </article>
        
        <article class="post">
            <header>
                <h2><a href="&#x2F;blog&#x2F;2021&#x2F;05&#x2F;11&#x2F;synapse-1-33-2-released&#x2F;" title="Synapse 1.33.2 released">Synapse 1.33.2 released</a></h2>
                <span>
                    11.05.2021 23:53
                    —
                    <a href="/category/releases">
                        Releases
                    </a>
                    —
                    <a
                        href="/author/dan-callahan">
                        Dan Callahan
                    </a>
                </span>
                
            </header>
            <div>
                
                <p><a href="https://github.com/matrix-org/synapse/releases/tag/v1.33.2">Synapse 1.33.2</a> is now available.</p>
<p>This release fixes a denial of service issue (<a href="https://github.com/matrix-org/synapse/security/advisories/GHSA-x345-32rc-8h85">CVE-2021-29471</a>) where evaluating specially crafted push rules could lead to excessive CPU load. Server administrators are encouraged to upgrade.</p>
<p>To learn more about Synapse 1.33, see last week's <a href="/blog/2021/05/05/synapse-1-33-0-released">release announcement</a>.</p>

                
            </div>
        </article>
        
        <article class="post">
            <header>
                <h2><a href="&#x2F;blog&#x2F;2021&#x2F;03&#x2F;26&#x2F;synapse-1-30-1-released&#x2F;" title="Synapse 1.30.1 released">Synapse 1.30.1 released</a></h2>
                <span>
                    26.03.2021 16:12
                    —
                    <a href="/category/releases">
                        Releases
                    </a>
                    —
                    <a
                        href="/author/dan-callahan">
                        Dan Callahan
                    </a>
                </span>
                
            </header>
            <div>
                
                <p><a href="https://github.com/matrix-org/synapse/releases/tag/v1.30.1">Synapse 1.30.1</a> is now available. This release is identical to Synapse 1.30.0, with the exception of explicitly setting a minimum version of the Python Cryptography library to ensure that users of Synapse are protected from yesterday's <a href="https://mta.openssl.org/pipermail/openssl-announce/2021-March/000198.html">OpenSSL security advisories</a>, especially CVE-2021-3449.</p>
<p>Note that Cryptography defaults to bundling its own statically linked copy of OpenSSL, which means that you may not be protected by your operating system's security updates.</p>
<p>It's also worth noting that Cryptography no longer supports Python 3.5, so admins deploying to older environments like Debian 9 (Stretch) or Ubuntu 16.04 (Xenial) may not be protected against this or future vulnerabilities.</p>
<p>The next release of Synapse will be the last to support Python 3.5.</p>

                
            </div>
        </article>
        
        <article class="post">
            <header>
                <h2><a href="&#x2F;blog&#x2F;2020&#x2F;12&#x2F;09&#x2F;synapse-1-24-0-and-1-23-1-released&#x2F;" title="Synapse 1.24.0 and 1.23.1 released">Synapse 1.24.0 and 1.23.1 released</a></h2>
                <span>
                    09.12.2020 23:51
                    —
                    <a href="/category/releases">
                        Releases
                    </a>
                    —
                    <a
                        href="/author/dan-callahan">
                        Dan Callahan
                    </a>
                </span>
                
            </header>
            <div>
                
                <p><a href="https://github.com/matrix-org/synapse/releases/tag/v1.24.0">Synapse 1.24.0</a> is now available!</p>
<p>This release fixes a denial of service vulnerability (<a href="https://github.com/matrix-org/synapse/security/advisories/GHSA-hxmp-pqch-c8mm">GHSA-hxmp-pqch-c8mm</a> / <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-26257">CVE-2020-26257</a>) in which a malicious homeserver could send malformed events into a room which would then break federation of that room.</p>
<p>This follows the disclosure of a denial of service vulnerability in OpenSSL (<a href="https://www.openssl.org/news/secadv/20201208.txt">CVE-2020-1971</a>). If you have installed Synapse from source, please ensure your host is up to date and then execute <code>pip install 'cryptography&gt;=3.3'</code> inside your Synapse virtualenv.</p>
<p>We've also released <a href="https://github.com/matrix-org/synapse/releases/tag/v1.23.1">Synapse 1.23.1</a> which includes that security fix and a small patch to maintain Python 3.5 compatibility. It is otherwise <a href="https://github.com/matrix-org/synapse/compare/v1.23.0...v1.23.1">identical to 1.23.0</a>. Note that Synapse 1.24.0 includes backwards incompatible changes which may affect a small number of users. See the <a href="https://github.com/matrix-org/synapse/blob/develop/UPGRADE.rst#upgrading-to-v1240">notes on upgrading</a> for more information.</p>
<p>Synapse 1.24.0 brings a pair of new Admin APIs, including a way to <a href="https://github.com/matrix-org/synapse/blob/v1.24.0/docs/admin_api/user_admin_api.rst#login-as-a-user">log in as users</a> and to <a href="https://github.com/matrix-org/synapse/blob/v1.24.0/docs/admin_api/rooms.md#delete-room-api">forcibly purge</a> rooms when deleting them. We've also made numerous bug fixes and improvements to SSO support, especially around OpenID Connect and SAML providers.</p>
<p>This release includes an optional change to push notification badges: currently, the number in the badge is based on the count of <em>rooms</em> with unread messages. However, in some specialized cases you may want the badge to show the count of <em>all</em> unread messages, even if there are multiple unread messages in the same room. This behavior can now be toggled with a <a href="https://github.com/matrix-org/synapse/pull/8820">new configuration setting</a>.</p>
<p>Additionally, for server admins, the deprecated <code>/_matrix/client/*/admin</code> Admin API endpoints <a href="https://github.com/matrix-org/synapse/issues/8785">have been removed</a>. If you have tools which target these endpoints, please update them to use the <code>/_synapse/admin</code> URL prefix instead.</p>
<p>See the <a href="https://github.com/matrix-org/synapse/blob/v1.24.0/CHANGES.md">full changelog</a> for more.</p>
<p>Installation instructions are available <a href="https://github.com/matrix-org/synapse/blob/master/INSTALL.md">on GitHub</a>, as is the <code>v1.24.0</code> <a href="https://github.com/matrix-org/synapse/releases/tag/v1.24.0">release tag</a>.</p>
<p>Synapse is a Free and Open Source Software project, and we'd like to extend our thanks to everyone who contributed to this release, including <a href="https://github.com/angdraug">@angdraug</a>, <a href="https://github.com/chagai95">@chagai95</a>, <a href="https://github.com/daenney">@daenney</a>, <a href="https://github.com/dklimpel">@dklimpel</a>, <a href="https://github.com/jordanbancino">@jordanbancino</a>, <a href="https://github.com/localguru">@localguru</a>, <a href="https://github.com/nchamo">@nchamo</a>, <a href="https://github.com/ShadowJonathan">@ShadowJonathan</a>, <a href="https://github.com/TeFiLeDo">@TeFiLeDo</a>, <a href="https://github.com/tulir">@tulir</a>, and <a href="https://github.com/waylon531">@waylon531</a>.</p>

                
            </div>
        </article>
        
        <nav class="pagination">
    <div class="prev">
        
        <a href="&#x2F;category&#x2F;security&#x2F;">‹ Previous</a>
        
    </div>
    <span class="page-number">2 / 4</span>
    <div class="prev">
        
        <a href="&#x2F;category&#x2F;security&#x2F;page&#x2F;3&#x2F;">Next ›</a>
        
    </div>
</nav>

    </div>
</div>

    </main>

    <footer class="site-footer">
    <div class="internal-links">
        
        <a href="&#x2F;faq">FAQs</a>
        
        <a href="&#x2F;security-disclosure-policy">Security Disclosure Policy</a>
        
        <a href="&#x2F;security-hall-of-fame">Security Hall of Fame</a>
        
        <a href="&#x2F;legal&#x2F;code-of-conduct">Code of Conduct for Matrix.org</a>
        
        <a href="&#x2F;legal">Legal</a>
        
        <a href="&#x2F;contact">Contact</a>
        
        <a href="https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix.org&#x2F;">Site Source</a>
        
    </div>
    <div class="external-links">
        <div>
            
            <a href="&#x2F;code"><img src="/assets/github.svg" alt="GitHub"></a>
            
            <a href="https:&#x2F;&#x2F;gitlab.matrix.org&#x2F;"><img src="/assets/gitlab.svg" alt="GitLab"></a>
            
            <a href="https:&#x2F;&#x2F;mastodon.matrix.org&#x2F;@matrix"><img src="/assets/mastodon.svg" alt="Mastodon"></a>
            
            <a href="https:&#x2F;&#x2F;twitter.com&#x2F;matrixdotorg"><img src="/assets/twitter.svg" alt="Twitter"></a>
            
            <a href="https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UCVFkW-chclhuyYRbmmfwt6w"><img src="/assets/youtube.svg" alt="YouTube"></a>
            
        </div>
    </div>
    <p>© 2022 The Matrix.org Foundation C.I.C.</p>
</footer>

</body>

</html>
