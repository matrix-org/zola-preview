<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="twitter:widgets:csp" content="on" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="twitter:site" content="@matrixdotorg" />
    <meta name="twitter:creator" content="@matrixdotorg" />

    <title>Matrix.org - Blog</title>
    <link rel="shortcut icon" href="/assets/favicon.ico" />
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg" />
    <link rel="stylesheet" href="/style.css" />

    

<meta name="description" content="The Matrix.org Foundation blod is where the Matrix Foundation and Community
post updates on their activity. Every Friday evening they publish This Week In
Matrix, a digest of the past week activity.
">

</head>

<body>
    
    <header class="site-header">
    <a href="/" class="brand">
        <img src="/images/matrix-logo-white.svg" alt="Matrix logo">
    </a>
    <input id="site-header-dropdown-checkbox" type="checkbox" class="dropdown-checkbox" aria-hidden="true">
    <label for="site-header-dropdown-checkbox" class="dropdown-button">&#xe602;</label>
    <label for="site-header-dropdown-checkbox" class="page-overlay"></label>
    <nav>
        
        
        <a href="&#x2F;about&#x2F;" class="
            ">
            About
        </a>
        
        
        
        <a href="&#x2F;blog&#x2F;" class="
            current">
            Blog
        </a>
        
        
        
        <a href="&#x2F;docs&#x2F;" class="
            ">
            Documentation
        </a>
        
        
        
        
        
        <div class="section-wrap">
            <input id="ecosystem-submenu-checkbox" type="checkbox" class="submenu-checkbox" aria-hidden="true"
                >
            <label for="ecosystem-submenu-checkbox" class="submenu-title">Ecosystem <div class="arrow">
                </div></label>

            <div class="section-submenu-wrap">
                <div class="section-submenu">
                    
                    
                    <a href="&#x2F;ecosystem&#x2F;clients&#x2F;">Clients</a>
                    
                    
                    <a href="&#x2F;ecosystem&#x2F;bridges&#x2F;">Bridges</a>
                    
                    
                    <a href="&#x2F;ecosystem&#x2F;servers&#x2F;">Servers</a>
                    
                    <a href="&#x2F;ecosystem&#x2F;integrations&#x2F;">Integrations</a>
                    
                    <a href="&#x2F;ecosystem&#x2F;sdks&#x2F;">SDKs</a>
                    
                    <a href="&#x2F;ecosystem&#x2F;hosting&#x2F;">Hosting</a>
                    
                </div>
            </div>
        </div>
        
        
        
        <a href="&#x2F;podcasts&#x2F;" class="
            ">
            Podcasts
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;shop.matrix.org" class="
            ">
            Shop
        </a>
        
        
        
        <a href="&#x2F;try-matrix&#x2F;" class="primary
            ">
            Try Matrix
        </a>
        
        
    </nav>
</header>


    <main>
        <div class="content">
    
    <article class="post">
        <header>
            <h1><a href="https:&#x2F;&#x2F;matrix.turbo.fish&#x2F;blog&#x2F;2017&#x2F;04&#x2F;04&#x2F;opening-up-cyberspace-with-matrix-and-webvr&#x2F;" title="Opening up cyberspace with Matrix and WebVR!">Opening up cyberspace with Matrix and WebVR!</a></h1>
            <span>
                04.04.2017 00:00
                â€”
                <a href="/category/tech">
                    Tech
                </a>
                â€”
                
                <a href="/author/matthew-hodgson">
                    Matthew Hodgson
                </a>
                
            </span>
            
        </header>
        <div>
            <p>TL;DR: <a href="/vrdemo">here's the demo</a>!</p>
<p>Hi everyone,</p>
<p>Today is a special day, the sort of day where you take a big step towards an ultimate dream. Starting Matrix and seeing it gaining momentum is already huge for us, a once in a lifetime opportunity. But one of the crazier things which drove us to create Matrix is the dream of creating cyberspace; the legendary promised land of the internet.</p>
<p>Whether it's the Matrix of <a href="https://en.wikipedia.org/wiki/Neuromancer">Neuromancer</a>, the <a href="https://en.wikipedia.org/wiki/Metaverse">Metaverse</a> of <a href="https://en.wikipedia.org/wiki/Snow_Crash">Snow Crash</a> or the Other Plane of <a href="https://en.wikipedia.org/wiki/True_Names">True Names</a>, an immersive 3D environment where people can meet from around the world to communicate, create and share is the ultimate expression of the Internet's potential as a way to connect: the idea of an open, neutral, decentralised virtual reality within the 'net<b>.</b></p>
<p>This is essentially the software developer equivalent of lying on your back at night, looking up at the stars, and wondering if you'll ever fly among them... and Matrix is not alone in dreaming of this! Â There have been many walled-garden virtual worlds over the years - <a href="http://secondlife.com/">Second Life</a>, <a href="http://habbo.com">Habbo Hotel</a>, all of the <a href="http://www.mmorpg.com/games-list">MMORPGs</a>, <a href="https://www.sansar.com/">Project Sansar</a> etc. Â And there have been decentralised worlds which lack the graphics but share the vision - whether it's <a href="https://en.wikipedia.org/wiki/FidoNet">FidoNet</a>, <a href="https://en.wikipedia.org/wiki/Usenet">Usenet</a>, <a href="https://en.wikipedia.org/wiki/Internet_Relay_Chat">IRC</a> servers, <a href="http://xmpp.org/">XMPP</a>, the <a href="https://en.wikipedia.org/wiki/Blogosphere">blogosphere</a> or Matrix as it's used today. Â And there are a few ambitious projects like <a href="https://en.wikipedia.org/wiki/Croquet_Project">Croquet</a>/<a href="http://www.opencobalt.net/">OpenCobalt</a>, <a href="http://opensimulator.org/">Open Simulator</a>, <a href="http://www.janusvr.com">JanusVR</a> or <a href="http://highfidelity.com">High Fidelity</a> which aim for a decentralised cyberspace, albeit without defining an open standard.</p>
<p>But despite all this activity, where is the open cyberspace? Where is the universal fabric which could weave these worlds together? Â Where is the VR equivalent of The Web itself? Â Where is the neutral communication layer that could connect the galaxies of different apps and users into a coherent reality? Â How do you bridge between today's traditional web apps and their VR equivalents?</p>
<p>Aside from cultural ones, we believe there are three missing ingredients which have been technically holding back the development of an open cyberspace so far:</p>
<ol>
 	<li> The hardware</li>
 	<li> Client software support (i.e. apps)</li>
 	<li> A universal real-time data layer to store the space</li>
</ol>
Nowadays the hardware problem is effectively solved: the <a href="https://www.vive.com">HTC Vive</a>, <a href="https://www.oculus.com/">Oculus Rift</a> and even <a href="https://vr.google.com/cardboard/">Google Cardboard</a> have brought VR displays to the general public. Â Meanwhile, accelerometers and head-tracking turn normal screens into displays for immersive content without even needing goggles, giving <i>everyone</i> a window into a virtual world.
<p>Client software is a more interesting story: Â If there are many custom and proprietary VR apps that already exist out there, almost none of them can connect to other servers than the ones ran by their own vendors, or even other services and apps. Â Â An open neutral cyberspace is just like the web: it needs the equivalent of web browsers, i.e. ubiquitous client apps which can connect to any servers and services written by any vendors and hosted by any providers, communicating together via an open common language. Â Â And while web browsers of course exist, until very recently there was no way to link them into VR hardware.</p>
<p>This has changed with the creation of <a href="https://en.wikipedia.org/wiki/WebVR">WebVR</a> by Mozilla - defining an API to let browsers render VR content, gracefully degrading across hardware and platforms such that you get the best possible experience all the way from a top-end gaming PC + Vive, down to tapping on a link on a simple smartphone. Â WebVR is a genuine revolution: suddenly every webapp on the planet can create a virtual world! And frameworks like <a href="https://aframe.io/">A-Frame</a>, <a href="https://github.com/ngokevin/aframe-react">aframe-react</a> and <a href="https://facebookincubator.github.io/react-vr/">React VR</a> make it incredibly easy and fun to do.</p>
<p>So looking back at our list, the final missing piece is nothing less than a backbone: some kind of data layer to link these apps together. Â Right now, <b>all</b> the WebVR apps out there are little islands - each its own isolated walled garden and there is no standard way to provide shared experiences. Â There is no standard way for users to communicate between these worlds (or between the VR and non-VR web) - be that by messaging, VoIP, Video or even VR interactions. Â There is no standard way to define an avatar, its location and movement within a world, or how it might travel between worlds. Â And finally, there is no standard way to describe the world's state in general: each webapp is free to manage its scene and its content any way it likes; there is nowhere to expose the realtime scene-graph of the world such that other avatars, bots, apps, services etc. can interact with it. The same way there is no standard way to exchange messages or reuse a user profile between messaging apps today: if the cyberspace is taking shape as we speak, it is definitely not taking the path of openness. At least not yet.</p>
<p>Predictably enough, it's this last point of the 'missing data layer for cyberspace' which we've been thinking about with Matrix: an open, neutral, decentralised meta-network powering or connecting these worlds. Â To start with, we've made Matrix available as a generic communications layer for VR, taking WebVR (via A-Frame) and combining it with <a href="https://github.com/matrix-org/matrix-js-sdk">matrix-js-sdk, </a>as an open, secure and decentralised way to place voip calls, video calls and instant messaging both within and between WebVR apps and the rest of the existing Matrix ecosystem (e.g. apps like Riot).</p>
<p>In fact, the best way is to test it live: we've put together a quick demo at <a href="/vrdemo">https://matrix.org/vrdemo</a> to show it off, so please <a href="/vrdemo">give it a go!</a></p>
<p><a href="/vrdemo"><img class="aligncenter size-large wp-image-2424" src="/blog/wp-content/uploads/2017/04/table-1024x333.jpg" alt="" width="1024" height="333" /></a></p>
<p><a href="/vrdemo">In the demo</a> you get:</p>
<ol>
 	<li> a virtual lobby, providing a 1:1 WebRTC video call via Matrix through to a â€˜guide' user of your choice anywhere else in Matrix (VR or not). Â From the lobby you can jump into two other apps:</li>
 	<li> a video conference, calling between all the participants of a given Matrix room in VR (no interop yet with other Matrix apps)</li>
 	<li> a 'virtual tourism' example, featuring a 1:1 WebRTC video call with a guide, superimposed over the top of the user going skiing through 360 degree video footage.</li>
</ol>
Video calling requires a WebRTC-capable browser (Chrome or Firefox). Unfortunately no iOS browsers support it yet. If you have dedicated VR hardware (Vive or Rift), you'll have to configure your browser appropriately to use the demo - see <a href="https://webvr.rocks">https://webvr.rocks</a> for the latest details.
<p>Needless to say, the demo's open sourced under the Apache License like all things Matrix - you can check out the code from <a href="https://github.com/matrix-org/matrix-vr-demo">https://github.com/matrix-org/matrix-vr-demo</a>. Â Huge kudos to Richard Lewis, Rob Swain and Ben Lewis for building this out - and to Aidan Taub and Tom Elliott for providing the 360 degree video footage!</p>
<p>The demo is quite high-bandwidth and hardware intensive, so here's a video of it in action, just in case:</p>
<iframe src="https://www.youtube.com/embed/nk0nMlVXkbk" frameBorder="0" allowFullScreen="allowfullscreen"></iframe>
<p>Now, it's important to understand that here we're using Matrix as a standard communications API for VR, but we're not using Matrix to store any VR world data (yet). Â The demo uses plain A-Frame via aframe-react to render its world: we are not providing an API which exposes the world itself onto the network for folks to interact with and extend. Â This is because Matrix is currently optimised for storing and synchronising two types of data structure: decentralised timelines of conversation data, and arbitrary decentralised key-value data (e.g. room names, membership, topics).</p>
<p>However, the job of storing arbitrary world data requires storing and flexibly querying it as an object graph of some kind - e.g. as a scene graph hierarchy. Â Doing this efficiently whilst supporting Matrix's decentralised eventual consistency model is tantamount to evolving Matrix into being a generic decentralised object-graph database (whilst upholding the constraints of that virtual world). Â This is tractable, but it's a bunch more work than just supporting the eventually-consistent timeline &amp; key-value store we have today. Â It's something we're thinking about though. :)</p>
<p>Also, Matrix is currently not super low-latency - on a typical busy Synapse deployment event transmission between clients has a latency of 50-200ms (ignoring network). Â This is fine for instant messaging and setting up VoIP calls etc, but useless for publishing the realtime state of a virtual world: having to wait 200ms to be told that something happened in an interactive virtual world would be a terrible experience. Â However, there are various fixes we can do here: Matrix itself is getting faster; Dendrite is expected to be one or two orders of magnitude faster than Synapse. Â We could also use Matrix simply as a signalling layer in order to negotiate a lower latency realtime protocol to describe world data updates (much as we use Matrix as a signalling layer for setting up RTP streams for VoIP calls or MIDI sessions).</p>
<p>Finally, you need somewhere to store the world assets themselves (textures, sounds, Collada or GLTF assets, etc). Â This is no different to using attachments in Matrix today - this could be as plain HTTP, or via the Matrix decentralised content store (mxc:// URLs), or via something like IPFS.</p>
<p>This said, it's only a matter of time before someone starts storing world data itself in Matrix. Â We have more work to do before it's a tight fit, but this has always been one of the long-term goals of the project and we're going to do everything we can to support it well.</p>
<p>So: this is the future we're thinking of. Â Obviously work on today's Matrix servers, clients, spec &amp; bridges is our focus and priority right now and we lots of work left there - but the longer term plan is critical too. Â Communication in VR is pretty much a blank canvas right now, and Matrix can be <em>the</em>Â connecting fabric for it - which isÂ unbelievably exciting. Â Right now our demo is just a PoC - we'd encourage all devs reading this to have a think about how to extend it, and how we all can build together the new frontier of cyberspace!</p>
<p>Finally, if you're interested in chatting more about VR on Matrix, come hang out over at <a href="https://matrix.to/#/#vr:matrix.org">#vr:matrix.org</a>!</p>
<ul>
<li>Matthew, Amandine &amp; the Matrix team</li>
</ul>
<blockquote>
<p lang="en" dir="ltr">Amandine grins at the future in the newest skunkworks zone of the London <a href="https://t.co/y2YCHNIbgU">https://t.co/y2YCHNIbgU</a> HQ... :&gt; :D ðŸ˜ˆ <a href="https://t.co/K5xBz7U9o2">pic.twitter.com/K5xBz7U9o2</a></p>&mdash; Matrix (@matrixdotorg) <a href="https://twitter.com/matrixdotorg/status/843181984448991232?ref_src=twsrc%5Etfw">March 18, 2017</a>
</blockquote>

        </div>
    </article>
    
    <article class="post">
        <header>
            <h1><a href="https:&#x2F;&#x2F;matrix.turbo.fish&#x2F;blog&#x2F;2017&#x2F;03&#x2F;21&#x2F;synapse-0-19-3-released&#x2F;" title="Synapse 0.19.3 released">Synapse 0.19.3 released</a></h1>
            <span>
                21.03.2017 00:00
                â€”
                <a href="/category/general">
                    General
                </a>
                â€”
                
                <a href="/author/matthew-hodgson">
                    Matthew Hodgson
                </a>
                
            </span>
            
        </header>
        <div>
            <p>Hi all,</p>
<p>We've released Synapse 0.19.3-rc2 as 0.19.3 with no changes. This is a slightly unusual release, as 0.19.3-rc2 dates from March 13th and <a href="https://github.com/matrix-org/synapse/compare/672dcf5...d101488">a lot of stuff</a> has landed on the develop branch since then - however, we'll be releasing that as 0.20.0 once it's ready. Instead, 0.19.3 has a set of intermediary performance and bug fixes; the only new feature is a set of admin APIs kindly contributed by <a href="https://github.com/morteza-araby">@morteza-araby</a>.</p>
<p>The changelog follows - please upgrade from https://github.com/matrix-org/synapse or your OS packages as normal :)</p>
<h3 id="changes-in-synapse-v0-19-3-2017-03-20">Changes in synapse v0.19.3 (2017-03-20)</h3>
<p>No changes since v0.19.3-rc2</p>
<h3 id="changes-in-synapse-v0-19-3-rc2-2017-03-13">Changes in synapse v0.19.3-rc2 (2017-03-13)</h3>
<p>Bug fixes:</p>
<ul>
 	<li>Fix bug in handling of incoming device list updates over federation.</li>
</ul>
<h3 id="changes-in-synapse-v0-19-3-rc1-2017-03-08">Changes in synapse v0.19.3-rc1 (2017-03-08)</h3>
<p>Features:</p>
<ul>
 	<li>Add some administration functionalities. Thanks to <a class="user-mention" href="https://github.com/morteza-araby"><span class="ghh-user-x tooltipstered" title="">@morteza-araby</span></a>! (PR <a class="issue-link js-issue-link ghh-issue-x tooltipstered" title="" href="https://github.com/matrix-org/synapse/pull/1784" data-url="https://github.com/matrix-org/synapse/issues/1784" data-id="199561652" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#1784</a>)</li>
</ul>
Changes:
<ul>
 	<li>Reduce database table sizes (PR <a class="issue-link js-issue-link ghh-issue-x tooltipstered" title="" href="https://github.com/matrix-org/synapse/pull/1873" data-url="https://github.com/matrix-org/synapse/issues/1873" data-id="204670414" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#1873</a>, <a class="issue-link js-issue-link ghh-issue-x tooltipstered" title="" href="https://github.com/matrix-org/synapse/pull/1916" data-url="https://github.com/matrix-org/synapse/issues/1916" data-id="207518205" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#1916</a>, <a class="issue-link js-issue-link ghh-issue-x tooltipstered" title="" href="https://github.com/matrix-org/synapse/pull/1923" data-url="https://github.com/matrix-org/synapse/issues/1923" data-id="208136725" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#1923</a>, <a class="issue-link js-issue-link ghh-issue-x tooltipstered" title="" href="https://github.com/matrix-org/synapse/pull/1963" data-url="https://github.com/matrix-org/synapse/issues/1963" data-id="211038447" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#1963</a>)</li>
 	<li>Update contrib/ to not use syutil. Thanks to <a class="user-mention" href="https://github.com/andrewshadura"><span class="ghh-user-x tooltipstered" title="">@andrewshadura</span></a>! (PR <a class="issue-link js-issue-link ghh-issue-x tooltipstered" title="" href="https://github.com/matrix-org/synapse/pull/1907" data-url="https://github.com/matrix-org/synapse/issues/1907" data-id="207038123" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#1907</a>)</li>
 	<li>Don't fetch current state when sending an event in common case (PR <a class="issue-link js-issue-link ghh-issue-x tooltipstered" title="" href="https://github.com/matrix-org/synapse/pull/1955" data-url="https://github.com/matrix-org/synapse/issues/1955" data-id="210568365" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#1955</a>)</li>
</ul>
Bug fixes:
<ul>
 	<li>Fix synapse_port_db failure. Thanks to <a class="user-mention" href="https://github.com/Pneumaticat"><span class="ghh-user-x tooltipstered" title="">@Pneumaticat</span></a>! (PR <a class="issue-link js-issue-link ghh-issue-x tooltipstered" title="" href="https://github.com/matrix-org/synapse/pull/1904" data-url="https://github.com/matrix-org/synapse/issues/1904" data-id="207022149" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#1904</a>)</li>
 	<li>Fix caching to not cache error responses (PR <a class="issue-link js-issue-link ghh-issue-x tooltipstered" title="" href="https://github.com/matrix-org/synapse/pull/1913" data-url="https://github.com/matrix-org/synapse/issues/1913" data-id="207216238" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#1913</a>)</li>
 	<li>Fix APIs to make kick & ban reasons work (PR <a class="issue-link js-issue-link ghh-issue-x tooltipstered" title="" href="https://github.com/matrix-org/synapse/pull/1917" data-url="https://github.com/matrix-org/synapse/issues/1917" data-id="207542829" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#1917</a>)</li>
 	<li>Fix bugs in the /keys/changes api (PR <a class="issue-link js-issue-link ghh-issue-x tooltipstered" title="" href="https://github.com/matrix-org/synapse/pull/1921" data-url="https://github.com/matrix-org/synapse/issues/1921" data-id="207764068" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#1921</a>)</li>
 	<li>Fix bug where users couldn't forget rooms they were banned from (PR <a class="issue-link js-issue-link ghh-issue-x tooltipstered" title="" href="https://github.com/matrix-org/synapse/pull/1922" data-url="https://github.com/matrix-org/synapse/issues/1922" data-id="207904548" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#1922</a>)</li>
 	<li>Fix issue with long language values in pushers API (PR <a class="issue-link js-issue-link ghh-issue-x tooltipstered" title="" href="https://github.com/matrix-org/synapse/pull/1925" data-url="https://github.com/matrix-org/synapse/issues/1925" data-id="208403542" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#1925</a>)</li>
 	<li>Fix a race in transaction queue (PR <a class="issue-link js-issue-link ghh-issue-x tooltipstered" title="" href="https://github.com/matrix-org/synapse/pull/1930" data-url="https://github.com/matrix-org/synapse/issues/1930" data-id="208932693" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#1930</a>)</li>
 	<li>Fix dynamic thumbnailing to preserve aspect ratio. Thanks to <a class="user-mention" href="https://github.com/jkolo"><span class="ghh-user-x tooltipstered" title="">@jkolo</span></a>! (PR <a class="issue-link js-issue-link ghh-issue-x tooltipstered" title="" href="https://github.com/matrix-org/synapse/pull/1945" data-url="https://github.com/matrix-org/synapse/issues/1945" data-id="210167714" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#1945</a>)</li>
 	<li>Fix device list update to not constantly resync (PR <a class="issue-link js-issue-link ghh-issue-x tooltipstered" title="" href="https://github.com/matrix-org/synapse/pull/1964" data-url="https://github.com/matrix-org/synapse/issues/1964" data-id="211092538" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#1964</a>)</li>
 	<li>Fix potential for huge memory usage when getting device that have changed (PR <a class="issue-link js-issue-link ghh-issue-x tooltipstered" title="" href="https://github.com/matrix-org/synapse/pull/1969" data-url="https://github.com/matrix-org/synapse/issues/1969" data-id="212091226" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#1969</a>)</li>
</ul>

        </div>
    </article>
    
    <article class="post">
        <header>
            <h1><a href="https:&#x2F;&#x2F;matrix.turbo.fish&#x2F;blog&#x2F;2017&#x2F;03&#x2F;15&#x2F;dendrite-receives-its-first-messages&#x2F;" title="Dendrite receives its first messages!!!">Dendrite receives its first messages!!!</a></h1>
            <span>
                15.03.2017 00:00
                â€”
                <a href="/category/tech">
                    Tech
                </a>
                â€”
                
                <a href="/author/matthew-hodgson">
                    Matthew Hodgson
                </a>
                
            </span>
            
        </header>
        <div>
            <p>Hi all,</p>
<p>We hit a major milestone today on <a href="https://github.com/matrix-org/dendrite">Dendrite</a>, our next-generation golang homeserver: <b>Dendrite received its first messages!!</b></p>
<p>Before you get too excited, please understand that Dendrite is still a pre-alpha work in progress - whilst we successfully created some rooms on an instance and sent a bunch of messages into them via the Client-Server API, most other functionality (e.g. receiving messages via /sync, logging in, registering, federation etc) is yet to exist. <b>It cannot yet be used as a homeserver</b>.  However, this is still a huge step in the right direction, as it demonstrates the core DAG functionality of Matrix is intact, and the beginnings of a usable Client-Server API are hooked up.</p>
<p>The architecture of Dendrite is genuinely interesting - please check out the <a href="https://github.com/matrix-org/dendrite/blob/master/WIRING.md">wiring diagram</a> if you haven't already.  The idea is that the server is broken down into a series of components which process streams of data stored in Kafka-style append-only logs.  Each component scales horizontally (you can have as many as required to handle load), which is an enormous win over Synapse's monolithic design.  Each component is also decoupled from each other by the logs, letting them run on entirely different machines as required.  Please note that whilst the initial implementation is using Kafka for convenience, the actual append-only log mechanism is abstracted away - in future we expect to see configurations of Dendrite which operate entirely from within a single go executable (using go channels as the log mechanism), as well as alternatives to Kafka for distributed solutions.</p>
<p>The components which have taken form so far are the central <a href="https://github.com/matrix-org/dendrite/tree/master/src/github.com/matrix-org/dendrite/roomserver">roomserver</a> service, which is responsible (as the name suggests) for maintaining the state and integrity of one or more rooms - authorizing events into the room DAG; storing them in postgres, tracking the auth chain of events where needed; etc.  Much of the core matrix DAG logic of the roomserver is provided by <a href="https://github.com/matrix-org/gomatrixserverlib">gomatrixserverlib</a>.  The roomserver receives events sent by users via the 'client room send' component (and 'federation backfill' component, when that exists).  The 'client room send' component (and in future also 'client sync') is provided by the <a href="https://github.com/matrix-org/dendrite/tree/master/src/github.com/matrix-org/dendrite/clientapi">clientapi</a> service - which is what as of today is successfully creating rooms and events and relaying them to the roomserver!</p>
<p>The actual events we've been testing with are the history of the Matrix Core room: around 10k events.  Right now the roomserver (and the postgres DB that backs it) are the main bottleneck in the pipeline rather than clientapi, so it's been interesting to see how rapidly the roomserver can consume its log of events.  As of today's benchmark, on a generic dev workstation and an entirely unoptimised roomserver (i.e. no caching whatsoever) running on a single core, we're seeing it ingest the room history at over <b>350 events per second</b>.  The vast majority of this work is going into encoding/decoding JSON or waiting for postgres: with a simple event cache to avoid repeatedly hitting the DB for every auth and state event, we expect this to increase significantly.  And then as we increase the number of cores, kafka partitions and roomserver instances it should scale fairly arbitrarily(!)</p>
<p>For context, the main synapse process for Matrix.org currently maxes out persisting events at around 15 and 20 per second (although it is also spending a bunch of time relaying events to the various worker processes, and other miscellanies).  As such, an initial benchmark for Dendrite of 350 msgs/s really does look incredibly promising.</p>
<p>You may be wondering where this leaves Synapse?  Well, a major driver for implementing Dendrite has been to support the growth of the main matrix.org server, which currently persists around 10 events/s (whilst emitting around 1500 events/s).  We have exhausted most of the low-hanging fruit for optimising Synapse, and have got to point where the architectural fixes required are of similar shape and size to the work going into Dendrite.  So, whilst Synapse is going to be around for a while yet, we're putting the majority of our long-term plans into Dendrite, with a distinct degree of urgency as we race against the ever-increasing traffic levels on the Matrix.org server!</p>
<p>Finally, you may be wondering what happened to <a href="https://github.com/matrix-org/dendron">Dendron</a>, our original experiment in Golang servers.  Well: Dendron was an attempt at a <a href="https://www.martinfowler.com/bliki/StranglerApplication.html">strangler pattern</a> rewrite of Synapse, acting as an shim in front of Synapse which could gradually swap out endpoints with their golang implementations.  In practice, the operational complexity it introduced, as well as the amount of room for improvement (at the time) we had in Synapse, and the relatively tight coupling to Synapse's existing architecture, storage &amp; schema, meant that it was far from a clear win - and effectively served as an excuse to learn Go.  As such, we've finally formally killed it off as of last week - Matrix.org is now running behind a normal haproxy, and Dendron is dead.  Meanwhile, Dendrite (aka Dendron done Right ;) is very much alive, progressing fast, free from the shackles of Synapse.</p>
<p>We'll try to keep the blog updated with progress on Dendrite as it continues to grow!</p>

        </div>
    </article>
    
    <article class="post">
        <header>
            <h1><a href="https:&#x2F;&#x2F;matrix.turbo.fish&#x2F;blog&#x2F;2017&#x2F;03&#x2F;14&#x2F;an-adventure-in-irc-land&#x2F;" title="An Adventure in IRC-Land">An Adventure in IRC-Land</a></h1>
            <span>
                14.03.2017 00:00
                â€”
                <a href="/category/general">
                    General
                </a>
                â€”
                
                <a href="/author/kegan-dougal">
                    Kegan Dougal
                </a>
                
            </span>
            
        </header>
        <div>
            <p>Hi everyone. I'm Kegan, one of the core developers at matrix.org. This is the first in a series on the matrix.org IRC bridge. The aim of this series is to try to give a behind the scenes look at how the IRC bridge works, what kinds of problems we encountered, and how we plan to scale in the future. This post looks at how the IRC bridge actually works.</p>
<p>Firstly, what is &quot;bridging&quot;? The simple answer is that it is a program which maps between different messaging protocols so that users on different protocols can communicate with each other. Some protocols may have features which are not supported in the other (typing notifications in Matrix, DCC - <em>direct</em> file transfers - in IRC). This means that bridging will always be &quot;inferior&quot; to just using the respective protocol. That being said, where there is common ground a bridge can work well; all messaging protocols support sending and receiving text messages for example. As we'll see however, the devil is in the detail...</p>
<p>A lot of existing IRC bridges for different protocols share one thing in common: they use a single global bot to bridge traffic. This bot listens to all messages from IRC, and sends them to the other network. The bot also listens for messages from users on the other network, and sends messages on their behalf to IRC. This is a lot easier than having to maintain dedicated TCP connections for each user. However, it isn't a great experience for IRC users as they:</p>
<ul>
 	<li>Don't know who is reading messages on a channel as there is just 1 bot in the membership list.</li>
 	<li>Cannot PM users on the other network.</li>
 	<li>Cannot kick/ban users on the other network without affecting everyone else.</li>
 	<li>Cannot bing/mention users on the other network easily (tab completion).</li>
</ul>
We made the decision very early on that we would keep dedicated TCP connections for each Matrix user. This means every Matrix user has their own tiny IRC client. This has its own problems:
<ul>
 	<li>It involves multiple connections to the IRCd so you need special permission to set up an i:line.</li>
 	<li>You need to be able to support identification of individual users (via ident or unique IPv6 addresses).</li>
 	<li>With all these connections to the same IRC channels, you need to have some way to identify which incoming messages have already been handled and which have not.</li>
</ul>
<h3 id="mapping-rooms">Mapping Rooms</h3>
<p>So now that we have a way to send and receive messages, how do we map the rooms/channels between protocols? This isn't as easy as you may think. We can have a single static one-to-one mapping:</p>
<ul>
 	<li>All messages to <code>#channel</code> go to <code>!abcdef:matrix.org</code>.</li>
 	<li>All messages from <code>!abcdef:matrix.org</code> go to <code>#channel</code>.</li>
 	<li>All PMs between <code>@alice:matrix.org</code> and Bob go to <code>!wxyz:matrix.org</code> and the respective PM on IRC.</li>
</ul>
In order to make PMs secure, we need to limit who can access the room. This is done by making the Matrix PM room "invite-only". This can cause problems though if the Matrix user ever leaves that room: they won't be able to ever re-join! The IRC bridges get around this by allowing Matrix users to <em>replace</em> their dedicated PM room with a new room, and by checking to make sure that the Matrix user is inside the room before sending messages.
<p>Then you have problem of &quot;ownership&quot; of rooms. Who should be able to kick users in a bridged room? There are two main scenarios to consider:</p>
<ul>
 	<li>The IRC channel has existed for a while and there are existing IRC channel operators.</li>
 	<li>The IRC channel does not exist, but there are existing Matrix moderators.</li>
</ul>
In the first case, we want to defer ownership to the channel operators. This is what happens by default for all bridged IRC channels on matrix.org. The Matrix users have no power in the room, and are at the mercy of the IRC channel operators. The channel operators are represented by virtual Matrix users in the room. However, they do not have any power level: they are at the same level as real Matrix users. Why? The bridge does this because, unlike IRC, it's not possible in Matrix to bring a user to the same level as yourself (e.g <code>+o</code>), and then downgrade them back to a regular user (e.g. <code>-o</code>). Instead, the bridge bot itself acts as a custodian for the room, and performs privileged IRC operations (topic changing, kickbans, etc) on the IRC channel operator's behalf.
<p>In the second case, we want to defer ownership to the Matrix moderators. This is what happens when you &quot;provision a room&quot; in Matrix. The bridge will PM a currently online channel operator and ask for their permission to bridge to Matrix. If they accept, the bridge is made and the power levels in the pre-existing Matrix room are left untouched, giving moderators in Matrix control over the room. However, this power doesn't extend completely to IRC. If a Matrix moderator grants moderator powers to another Matrix user, this will not be mapped to IRC. Why? It's not possible for the bridge to give chanops to any random user on any random IRC channel, so it cannot always honour the request. This relies on the humans on either side of the bridge to communicate and map power accordingly. This is done on purpose as there is no 100% perfect mapping between IRC powers and Matrix powers: it's always going to need to compromise which only a human can make.</p>
<p>Finally, there is the problem of one-to-many mappings. It is possible to have two Matrix rooms bridged to the same IRC channel. The problem occurs when a Matrix user in one room speaks. The bridge can easily map that to IRC, but unless it <em>also</em> maps it back to Matrix, the message will never make it to the 2nd Matrix room. The bridge cannot control/puppet the Matrix user who spoke, so instead it creates a virtual Matrix user to represent that <em>real</em> Matrix user and then sends the message into the 2nd Matrix room. Needless to say, this can be quite confusing and we strongly discourage one-to-many mappings for this reason.</p>
<h3 id="mapping-messages">Mapping Messages</h3>
<p>Mapping Matrix messages to IRC is rather easy for the most part. Messages are passed from the Homeserver to the bridge via the AS API, and the bridge sends a textual representation of the message to IRC using the IRC connection for that Matrix user. The <a href="https://github.com/matrix-org/matrix-appservice-irc/issues/258">exact form</a> of the text for images, videos and long text can be quite subjective, and there is inevitably some data loss along the way. For example, you can send big text headings, tables and lists in Matrix, but there is no equivalent on IRC. Thankfully, most Matrix users are sending the corresponding markdown and so the formatting can be reasonably preserved by just sending the plaintext (markdown) body.</p>
<p>Mapping IRC messages to Matrix is more difficult: not because it's hard to represent the message in Matrix, but because of the architecture of the bridge. The bridge maintains separate connections for each Matrix user. This means the bridge might have, for example, 5 users (and hence connections) on the <em>same channel</em>. When an IRC user sends a message, the bridge gets 5 copies of the message. How does the bridge know:</p>
<ul>
 	<li>If the message has already been sent?</li>
 	<li>If the message is an intentional duplicate?</li>
</ul>
The IRC protocol does not have message IDs, so the bridge cannot de-duplicate messages as they arrive. Instead, it "nominates" a single user's connection to be responsible for delivering messages from that channel. This introduces another problem though. Long-lived TCP connections are fickle things, and can fail without any kind of visible warning until you try to send bytes down it. If a user's connection drops, another user needs to take over responsibility for delivering messages. This is what the "IRC Event Broker" class does. It allows users to "steal" messages if the bridge has any indication that the connection in charge has dropped. This technique has worked well for us, and gives us the ability to have more robust connections to the channel than with one TCP connection alone.
<h3 id="admin-rooms">Admin Rooms</h3>
<p>Admin rooms are private Matrix rooms between a real Matrix user and the bridge bot. It allows the Matrix user to control their connection to IRC. It allows:</p>
<ul>
 	<li>The IRC nick to be changed.</li>
 	<li>The ability to issue /whois commands.</li>
 	<li>The ability to bypass the bridge and send raw IRC commands directly down the TCP connection (e.g. MODE commands).</li>
 	<li>The ability to save a NickServ password for use when the bridge reconnects you.</li>
 	<li>The ability to disconnect from the network entirely.</li>
</ul>
To perform these actions, Matrix users send a text message which starts with a command name, e.g <code>!whois $ARG</code>. Like all commands, you expect to get a reply once you've issued it. However, IRC makes this extremely difficult to do. There is no request/response pair like there is with HTTP requests. Instead, the IRC server may:
<ul>
 	<li>Ignore the request entirely.</li>
 	<li>Send an error you're aware of (in the RFC/most servers)</li>
 	<li>Send some information which can be assumed to indicate success.</li>
 	<li>Send an error you're unaware of.</li>
 	<li>Send some information which <em>sometimes</em> indicates success.</li>
</ul>
This makes it very difficult to know if a request succeeded or failed, and I'll go into more detail in the next post which focuses on problems we've encountered when developing the IRC bridge. This room is also used to inform the Matrix user about general information about their IRC connection, such as when their connection has been lost, or if there are any errors (e.g. "requires chanops to do this action"). The bridge makes no effort to parse these errors, because it doesn't always know what caused the error to happen.
<h3 id="wrapup">Wrapup</h3>
<p>Developing a comprehensive IRC bridge is a very difficult task. This post has outlined a few of the ways in which we've designed our bridge, and some of the general problems in this field. The bridge is constantly improving as we discover new edge cases with the plethora of IRCd implementations out there. The next post will look at some of these edge cases and look back at some previous outages and examine why they occurred.</p>

        </div>
    </article>
    
    <article class="post">
        <header>
            <h1><a href="https:&#x2F;&#x2F;matrix.turbo.fish&#x2F;blog&#x2F;2017&#x2F;03&#x2F;11&#x2F;how-do-i-bridge-thee-let-me-count-the-ways&#x2F;" title="How do I bridge thee?  Let me count the ways...">How do I bridge thee?  Let me count the ways...</a></h1>
            <span>
                11.03.2017 00:00
                â€”
                <a href="/category/tech">
                    Tech
                </a>
                â€”
                
                <a href="/author/matthew-hodgson">
                    Matthew Hodgson
                </a>
                
            </span>
            
        </header>
        <div>
            <p><a href="https://xkcd.com/1810"><img class="aligncenter wp-image-2297" src="/blog/wp-content/uploads/2017/03/xkcd1810-matrixified-v2-1024x842.png" width="753" height="619" /></a></p>
<p id="types-of-bridging">Bridges come in many flavours, and we need consistent terminology within the Matrix community to ensure everyone (users, developers, core team) is on the same page. This post is primarily intended for bridge developers to refer to when building bridges.</p>
<em>The most recent version of this document is <a href="/docs/guides/types-of-bridging.html">here</a> (<a href="https://github.com/matrix-org/matrix-doc/blob/master/supporting-docs/guides/2017-03-11-types-of-bridging.md">source</a>) but we're also posting it as a blog post for visibility.</em>
<h3 id="types-of-rooms">Types of rooms</h3>
<h4 id="portal-rooms">Portal rooms</h4>
<p>Bridges can register themselves as controlling chunks of room aliases namespace, letting Matrix users join remote rooms transparently if they <code>/join #freenode_#wherever:matrix.org</code> or similar. The resulting Matrix room is typically automatically bridged to the single target remote room. Access control for Matrix users is typically managed by the remote network's side of the room. This is called a portal room, and is useful for jumping into remote rooms without any configuration needed whatsoever - using Matrix as a â€˜bouncer' for the remote network.</p>
<h4 id="plumbed-rooms">Plumbed rooms</h4>
<p>Alternatively, an existing Matrix room can be can plumbed into one or more specific remote rooms by configuring a bridge (which can be run by anyone). For instance, #matrix:matrix.org is plumbed into #matrix on Freenode, matrixdotorg/#matrix on Slack, etc. Access control for Matrix users is necessarily managed by the Matrix side of the room. This is useful for using Matrix to link together different communities.</p>
<p>Migrating rooms between a portal &amp; plumbed room is currently a bit of a mess, as there's not yet a way for users to remove portal rooms once they're created, so you can end up with a mix of portal &amp; plumbed users bridged into a room, which looks weird from both the Matrix and non-Matrix viewpoints. https://github.com/matrix-org/matrix-appservice-irc/issues/387 tracks this.</p>
<h3 id="types-of-bridges-simplest-first">Types of bridges (simplest first):</h3>
<h4 id="bridgebot-based-bridges">Bridgebot-based bridges</h4>
<p>The simplest way to exchange messages with a remote network is to have the bridge log into the network using one or more predefined users called bridge bots - typically called MatrixBridge or MatrixBridge[123] etc. These relay traffic on behalf of the users on the other side, but it's a terrible experience as all the metadata about the messages and senders is lost. This is how the <a href="https://github.com/SijmenSchoon/telematrix">telematrix</a> matrix&lt;-&gt;telegram bridge currently works.</p>
<h4 id="bot-api-aka-virtual-user-based-bridges">Bot-API (aka Virtual user) based bridges</h4>
<p>Some remote systems support the idea of injecting messages from â€˜fake' or â€˜virtual' users, which can be used to represent the Matrix-side users as unique entities in the remote network. For instance, Slack's inbound webhooks lets remote bots be created on demand, letting Matrix users be shown cosmetically correctly in the timeline as virtual users. However, the resulting virtual users aren't real users on the remote system, so don't have presence/profile and can't be tab-completed or direct-messaged etc. They also have no way to receive typing notifs or other richer info which may not be available via bot APIs. This is how the current <a href="https://github.com/matrix-org/matrix-appservice-slack">matrix-appservice-slack</a> bridge works.</p>
<h4 id="simple-puppeted-bridge">Simple puppeted bridge</h4>
<p>This is a richer form of bridging, where the bridge logs into the remote service as if it were a real 3rd party client for that service. As a result, the Matrix user has to already have a valid account on the remote system. In exchange, the Matrix user â€˜puppets' their remote user, such that other users on the remote system aren't even aware they are speaking to a user via Matrix. The full semantics of the remote system are available to the bridge to expose into Matrix. However, the bridge has to handle the authentication process to log the user into the remote bridge.</p>
<p>This is essentially how the current <a href="https://github.com/matrix-org/matrix-appservice-irc">matrix-appservice-irc</a> bridge works (if you configure it to log into the remote IRC network as your â€˜real' IRC nickname). <a href="https://github.com/matrix-org/matrix-appservice-gitter">matrix-appservice-gitter</a> is being extended to support both puppeted and bridgebot-based operation. It's how the experimental <a href="https://github.com/matrix-org/matrix-appservice-tg">matrix-appservice-tg</a> bridge works.</p>
<p>Going forwards we're aiming for all bridges to be at least simpleÂ puppeted, if notÂ double-puppeted.</p>
<h4 id="double-puppeted-bridge">Double-puppeted bridge</h4>
<p>A simple â€˜puppeted bridge' allows the Matrix user to control their account on their remote network. However, ideally this puppeting should work in both directions, so if the user logs into (say) their native telegram client and starts conversations, sends messages etc, these should be reflected back into Matrix as if the user had done them there. This requires the bridge to be able to puppet the Matrix side of the bridge on behalf of the user.</p>
<p>This is the holy-grail of bridging; <a href="https://github.com/matrix-hacks/matrix-puppet-bridge">matrix-puppet-bridge</a> is a community project that tries to facilitate development of doubleÂ puppeted bridges, having done so for <a href="https://github.com/matrix-hacks/matrix-puppet-bridge#examples">several networks</a>. The main obstacle is working out an elegant way of having the bridge auth with Matrix as the matrix user (which requires some kind of scoped access_token delegation).</p>
<h4 id="server-to-server-bridging">Server-to-server bridging</h4>
<p>Some remote protocols (IRC, XMPP, SIP, SMTP, NNTP, GnuSocial etc) support federation - either open or closed. The most elegant way of bridging to these protocols would be to have the bridge participate in the federation as a server, directly bridging the entire namespace into Matrix.</p>
<p>We're not aware of anyone who's done this yet.</p>
<h4 id="sidecar-bridge">Sidecar bridge</h4>
<p>Finally: the types of bridging described above assume that you are synchronising the conversation history of the remote system into Matrix, so it may be decentralised and exposed to multiple users within the wider Matrix network.</p>
<p>This can cause problems where the remote system may have arbitrarily complicated permissions (ACLs) controlling access to the history, which will then need to be correctly synchronised with Matrix's ACL model, without introducing security issues such as races. We already see some problems with this on the IRC bridge, where history visibility for +i and +k channels have to be carefully synchronised with the Matrix rooms.</p>
<p>You can also hit problems with other network-specific features not yet having equivalent representation in the Matrix protocol (e.g. ephemeral messages, or op-only messages - although arguably that's a type of ACL).</p>
<p>One solution could be to support an entirely different architecture of bridging, where the Matrix client-server API is mapped directly to the remote service, meaning that ACL decisions are delegated to the remote service, and conversations are not exposed into the wider Matrix. This is effectively using the bridge purely as a 3rd party client for the network (similar to Bitlbee). The bridge is only available to a single user, and conversations cannot be shared with other Matrix users as they aren't actually Matrix rooms. (Another solution could be to use Active Policy Servers at last as a way of centralising and delegating ACLs for a room)</p>
<p>This is essentially an entirely different product to the rest of Matrix, and whilst it could be a solution for some particularly painful ACL problems, we're focusing on non-sidecar bridges for now.</p>

        </div>
    </article>
    
    <article class="post">
        <header>
            <h1><a href="https:&#x2F;&#x2F;matrix.turbo.fish&#x2F;blog&#x2F;2017&#x2F;03&#x2F;06&#x2F;new-bridged-irc-network-gimpnet&#x2F;" title="New bridged IRC network: GIMPNet">New bridged IRC network: GIMPNet</a></h1>
            <span>
                06.03.2017 00:00
                â€”
                <a href="/category/general">
                    General
                </a>
                â€”
                
                <a href="/author/kegan-dougal">
                    Kegan Dougal
                </a>
                
            </span>
            
        </header>
        <div>
            <p>Hey everyone! As of last week, we are now bridging irc.gimp.org (GIMPNet) for all your GTK+/GNOME needs! It's running a bleeding-edge version of the IRC bridge which supports basic chanops syncing from IRC to Matrix. This means that if an IRC user gives chanops to a Matrix connection, the bridge will give that Matrix user moderator privileges in the room, allowing them to set the room topic/avatar/alias/etc! We hope this will make customising Matrix-bridged rooms a lot easier.</p>
<p>For a more complete list of current and future bridged IRC networks, see the <a href="https://github.com/matrix-org/matrix-appservice-irc/issues/208">official wishlist</a>.</p>

        </div>
    </article>
    
    <article class="post">
        <header>
            <h1><a href="https:&#x2F;&#x2F;matrix.turbo.fish&#x2F;blog&#x2F;2017&#x2F;03&#x2F;01&#x2F;google-summer-of-code-2017&#x2F;" title="Google Summer of Code 2017">Google Summer of Code 2017</a></h1>
            <span>
                01.03.2017 00:00
                â€”
                <a href="/category/gsoc">
                    GSOC
                </a>
                â€”
                
                <a href="/author/oddvar-lovaas">
                    Oddvar Lovaas
                </a>
                
            </span>
            
        </header>
        <div>
            <p><img src="/blog/wp-content/uploads/2017/03/GSoC-icon-192.png" alt="" width="192" height="192" class="alignleft size-full wp-image-2044" />We are very happy to <a href="/blog/2016/03/08/matrix-in-google-summer-of-code/">again</a> be one of the organisations selected for Google Summer of Code (GSoC)!</p>
<p>Last year we had two students working on Matrix-projects over the summer - you can read the <a href="/blog/2016/11/12/the-matrix-autumn-special/">retrospective here</a> - and now we are again offering students to work on Matrix as part of GSoC! Currently we are in the <a href="https://developers.google.com/open-source/gsoc/timeline">stage</a> where students can propose interesting project ideas to any of the <a href="https://summerofcode.withgoogle.com/organizations/">open source organisations</a> picked by Google. Of course, we encourage students to get in touch with us and discuss their ideas before writing their application - please come say hi in the <a href="https://matrix.to/#/#gsoc:matrix.org">#gsoc:matrix.org</a> room!</p>
<p>We are very eager to see what ideas students come up with. We have added our own ideas <a href="https://github.com/matrix-org/GSoC/blob/master/IDEAS.md">here</a>, but students are expected to do some research and come up with their own ideas for projects. We have also written down some <a href="https://github.com/matrix-org/GSoC/blob/master/README.md#how-do-i-write-my-gsoc-application">general tips</a> on what to include in the application.</p>
<p>Applications can be submitted from March 20th, so there's still plenty of time to have a play with Matrix and come up with a cool project idea!</p>
<p>Good luck!</p>

        </div>
    </article>
    
    <article class="post">
        <header>
            <h1><a href="https:&#x2F;&#x2F;matrix.turbo.fish&#x2F;blog&#x2F;2017&#x2F;02&#x2F;21&#x2F;synapse-0-19-2-is-out&#x2F;" title="Synapse 0.19.2 is out">Synapse 0.19.2 is out</a></h1>
            <span>
                21.02.2017 00:00
                â€”
                <a href="/category/general">
                    General
                </a>
                â€”
                
                <a href="/author/matthew-hodgson">
                    Matthew Hodgson
                </a>
                
            </span>
            
        </header>
        <div>
            <p>We just pushed <a href="https://github.com/matrix-org/synapse/releases">Synapse 0.19.2</a>, which contains a single but important fix for protecting event visibility when accessed via the <code>/context</code> API. Please upgrade from <a href="https://github.com/matrix-org/synapse">https://github.com/matrix-org/synapse</a>!</p>
<h3 id="changes-in-synapse-v0-19-2-2017-02-20">Changes in synapse v0.19.2 (2017-02-20)</h3>
<ul>
 	<li>Fix bug with event visibility check in /context/ API. Thanks to Tokodomo for pointing it out! (PR <a class="issue-link js-issue-link" href="https://github.com/matrix-org/synapse/pull/1929" data-url="https://github.com/matrix-org/synapse/issues/1929" data-id="208902437" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#1929</a>)</li>
</ul>

        </div>
    </article>
    
    <article class="post">
        <header>
            <h1><a href="https:&#x2F;&#x2F;matrix.turbo.fish&#x2F;blog&#x2F;2017&#x2F;02&#x2F;17&#x2F;load-problems-on-the-matrix-org-homeserver&#x2F;" title="Load problems on the Matrix.org homeserver">Load problems on the Matrix.org homeserver</a></h1>
            <span>
                17.02.2017 00:00
                â€”
                <a href="/category/general">
                    General
                </a>
                â€”
                
                <a href="/author/matthew-hodgson">
                    Matthew Hodgson
                </a>
                
            </span>
            
        </header>
        <div>
            <p>Hi folks,</p>
<p>Since FOSDEM we've seen even more interest in Matrix than normal, and we've been having some problems getting the Matrix.org homeserver to keep up with demand. Â This has resulted in performance being slightly slower than normal at peak times, but the main impact has been the additional traffic exacerbatingÂ outages on the homeserver - either by revealing new failure modes, or making it harder to recover rapidly after something goes wrong.</p>
<p>Specifically:Â on Friday afternoon we had a service disruption caused by someone sending an unusual event into Matrix HQ. Â It turns out that both matrix-android-sdk and matrix-ios-sdk based clients (e.g. Riot/Android and iOS) handled this naively by simply resyncing the room state... which has been fine in the past, but not when you have several hundred clients actively syncing the room, and resulted in a thundering herd effect which overloaded the server for ~10 mins or so whilst they all resynced the room (which, in turn, nowadays, involves calculating and syncing several MB of JSON state to each client). Â The traffic load was then high enough that it took the server a further 10-20 minutes for the server to fully catch up and recover after the herd had dissipated. Â We then had a repeat performance on Monday morning of the same failure mode.</p>
<p>Similarly, we had disruption last night after a user who hadn't used the service for ages logged on for the first time and rapidly caught up on a few rooms which literally had <em>millions</em> of unread messages in them. Â Generally this would be okay, but the combination of loaded DB and the sheer number of notifications being deleted ended up with 4 long-running DB deletes in parallel. Â This seems to have caused postgres to lock the event_actions_table more aggressively than we'd expect, blocking other queries which were trying to access it... causing most requests to block until the deletes were over. Â At the current traffic volumes this meant that the main synapse process tried to serve thousands of simultaneous requests as they stacked up and ran out of filehandles within about 10 minutes and wedged the whole synapse solid before the DB could unblock. Â Irritatingly, it turns out our end-to-end monitoring has a bug where it in turn can crash on receiving a 500 from synapse, so despite having PagerDuty all set up and running (and having been receiving pages for traffic delays overÂ the last few weeks)... we didn't get paged when we got actual failed traffic rather than slow traffic, which delayed resolving the issue. Â Finally, whilst rolling out a fix this afternoon, we again hit issues with the traffic load causing more problems than we were expecting, making a routine redeploy distinctly more disruptive.</p>
<p>So, what are we doing about this?</p>
<ol>
 	<li>Fix the root causes:
<ul>
 	<li>The 'android/iOS thundering herd' bug is being worked on both the android/iOS side (fixing the naive behaviour) and the server side. Â A temporary mitigation is in now place which moves the server-side code to worker processes so that worst case it can't take out the main synapse process and can scale better.</li>
 	<li>The 'event_push_actions table is inefficient' bug had <a href="https://github.com/matrix-org/synapse/pull/1916">already been fixed</a>Â - so this was a matter of rushing through the hotfix to matrix.org before we saw a recurrence.</li>
</ul>
</li>
 	<li>Move to faster hardware. Â Our current DB master is a "fast when we bought it 5 years ago" machine whose IO is simply starting to saturate (6x 300GB 10krpm disks in RAID5, fwiw), which is maxing out at around 500IOPS and 20MB/s of random access, and acting as a *very* hard limit to the current synapse performance. Â We're currently in the process of evaluating SSD-backed IO for the DB (in fact, we're already running a DB slave), and assuming this tests out okay we're hoping to migrate next week, which should give us a 10x-20x speed up on disk IO and buy considerable headroom. Â Watch this space for details.</li>
 	<li>Make synapse faster. Â We're continuing to plug away at optimisations (e.g. <a href="https://github.com/matrix-org/synapse/pull/1923">stuff like this</a>), but these are reaching the point of diminishing returns, especially relative to the win from faster hardware.</li>
 	<li>Fix the end-to-end monitoring. Â <a href="https://github.com/matrix-org/matrixmon/commit/9481da67b87c1d5142dbc76d9e4b6eb29c56398b">This already happened</a>.</li>
 	<li>Load-test before deploying. Â This is hard, as you really need to test against precisely the same traffic profile as live traffic, and that's hard to simulate. Â We're thinking about ways of fixing this, but the best solution is probably going to be clustering and being able to do incremental redeploys to gradually test new changes. Â On which note:</li>
 	<li>Fix synapse's architectural deficiencies to support clustering, allowing for rolling zero-downtime redeploys, and better horizontal scalability to handle traffic spikes like this. Â We're choosing not to fix this in synapse, but we are currently in full swing implementing <a href="https://github.com/matrix-org/dendrite">dendrite</a>Â as a next-generation homeserver in Golang,Â architected from the outset for clustering and horizontal scalability. Â N.B. most of the exciting stuff is happening on <a href="https://github.com/matrix-org/dendrite/branches">feature branches</a> and <a href="https://github.com/matrix-org/gomatrixserverlib">gomatrixserverlib</a> atm. Also, we're deliberately taking the time to try to get it right this time, unlike bits of synapse which were something of a rush job. Â It'll be a few weeks before dendrite is functional enough to even send a message (letÂ alone finish the implementation), but hopefully faster hardware will give the synapse deployment on matrix.org enough headroom for us to get dendrite ready to take over when the time comes!</li>
</ol>
The good news of course is that you can run your own synapse today to avoid getting caught up in this operational fun & games, and unless you're planning to put tens of thousands of daily active users on the server you should be okay!
<p>Meanwhile, please accept our apologies for the instability and be assured that we'reÂ doing everything we can to get out this turbulence as rapidly as possible.</p>
<p>Matthew</p>

        </div>
    </article>
    
    <article class="post">
        <header>
            <h1><a href="https:&#x2F;&#x2F;matrix.turbo.fish&#x2F;blog&#x2F;2017&#x2F;02&#x2F;14&#x2F;synapse-0-19-1-released&#x2F;" title="Synapse 0.19.1 released">Synapse 0.19.1 released</a></h1>
            <span>
                14.02.2017 00:00
                â€”
                <a href="/category/general">
                    General
                </a>
                â€”
                
                <a href="/author/matthew-hodgson">
                    Matthew Hodgson
                </a>
                
            </span>
            
        </header>
        <div>
            <p>Hi folks,</p>
<p>We're a little late with this, but Synapse 0.19.1 was released last week. The only change is a bugfix to a regression in room state replication that snuck in during the performance improvements that landed in 0.19.0. Please upgrade if you haven't already. We've also fixed the Debian repository to make installing Synapse easier on Jessie by including backported packages for stuff like Twisted where we're forced to use the latest releases.</p>
<p>You can grab it fromÂ <a href="https://github.com/matrix-org/synapse/">https://github.com/matrix-org/synapse/</a>Â as always.</p>
<h3 id="changes-in-synapse-v0-19-1-2017-02-09">Changes in synapse v0.19.1 (2017-02-09)</h3>
<ul>
 	<li>Fix bug where state was incorrectly reset in a room when synapse received an event over federation that did not pass auth checks (PR <a class="issue-link js-issue-link" href="https://github.com/matrix-org/synapse/pull/1892" data-url="https://github.com/matrix-org/synapse/issues/1892" data-id="206218885" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#1892</a>)</li>
</ul>

        </div>
    </article>
    
    <nav class="pagination">
    <div class="prev">
        
        <a href="https:&#x2F;&#x2F;matrix.turbo.fish&#x2F;blog&#x2F;page&#x2F;54&#x2F;">â€¹ Previous</a>
        
    </div>
    <span class="page-number">55 / 68</span>
    <div class="prev">
        
        <a href="https:&#x2F;&#x2F;matrix.turbo.fish&#x2F;blog&#x2F;page&#x2F;56&#x2F;">Next â€º</a>
        
    </div>
</nav>

</div>
    </main>

    <footer class="site-footer">
    <div class="internal-links">
        
        <a href="&#x2F;faq">FAQs</a>
        
        <a href="&#x2F;security-disclosure-policy">Security Disclosure Policy</a>
        
        <a href="&#x2F;security-hall-of-fame">Security Hall of Fame</a>
        
        <a href="&#x2F;legal&#x2F;code-of-conduct">Code of Conduct for Matrix.org</a>
        
        <a href="&#x2F;legal">Legal</a>
        
        <a href="&#x2F;contact">Contact</a>
        
        <a href="https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix.org&#x2F;">Site Source</a>
        
    </div>
    <div class="external-links">
        <div>
            
            <a href="https:&#x2F;&#x2F;github.com&#x2F;matrix-org"><img src="/assets/github.svg" alt="GitHub"></a>
            
            <a href="https:&#x2F;&#x2F;gitlab.matrix.org&#x2F;"><img src="/assets/gitlab.svg" alt="GitLab"></a>
            
            <a href="https:&#x2F;&#x2F;mastodon.matrix.org&#x2F;@matrix"><img src="/assets/mastodon.svg" alt="Mastodon"></a>
            
            <a href="https:&#x2F;&#x2F;twitter.com&#x2F;matrixdotorg"><img src="/assets/twitter.svg" alt="Twitter"></a>
            
            <a href="https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UCVFkW-chclhuyYRbmmfwt6w"><img src="/assets/youtube.svg" alt="YouTube"></a>
            
        </div>
    </div>
    <p><a href="/legal/copyright-notice">Copyright Notice</a></p>
</footer>

</body>

</html>
