<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="twitter:widgets:csp" content="on" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="twitter:site" content="@matrixdotorg" />
    <meta name="twitter:creator" content="@matrixdotorg" />

    <title>Matrix.org - Blog</title>
    <link rel="shortcut icon" href="/assets/favicon.ico" />
    <link rel="icon" type="image/png" href="/assets/favicon.png" />
    <link rel="stylesheet" href="/style.css" />

    </head>

<body>
    
    <header class="site-header">
    <a href="/" class="brand">
        <img src="/images/matrix-logo-white.svg" alt="Matrix logo">
    </a>
    <input id="site-header-dropdown-checkbox" type="checkbox" class="dropdown-checkbox" aria-hidden="true">
    <label for="site-header-dropdown-checkbox" class="dropdown-button">&#xe602;</label>
    <label for="site-header-dropdown-checkbox" class="page-overlay"></label>
    <nav>
        
        
        <a href="&#x2F;about&#x2F;" class="
            ">
            About
        </a>
        
        
        
        <a href="&#x2F;blog&#x2F;" class="
            current">
            Blog
        </a>
        
        
        
        <a href="&#x2F;docs&#x2F;" class="
            ">
            Documentation
        </a>
        
        
        
        
        
        <div class="section-wrap">
            <input id="ecosystem-submenu-checkbox" type="checkbox" class="submenu-checkbox" aria-hidden="true"
                >
            <label for="ecosystem-submenu-checkbox" class="submenu-title">Ecosystem <div class="arrow">
                </div></label>

            <div class="section-submenu-wrap">
                <div class="section-submenu">
                    
                    
                    <a href="&#x2F;ecosystem&#x2F;clients&#x2F;">Clients</a>
                    
                    
                    <a href="&#x2F;ecosystem&#x2F;bridges&#x2F;">Bridges</a>
                    
                    
                    <a href="&#x2F;ecosystem&#x2F;servers&#x2F;">Servers</a>
                    
                    <a href="&#x2F;ecosystem&#x2F;bots&#x2F;">Bots</a>
                    
                    <a href="&#x2F;ecosystem&#x2F;sdks&#x2F;">SDKs</a>
                    
                    <a href="&#x2F;ecosystem&#x2F;hosting&#x2F;">Hosting</a>
                    
                </div>
            </div>
        </div>
        
        
        
        <a href="&#x2F;podcasts&#x2F;" class="
            ">
            Podcasts
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;shop.matrix.org" class="
            ">
            Shop
        </a>
        
        
        
        <a href="&#x2F;try-matrix&#x2F;" class="primary
            ">
            Try Matrix
        </a>
        
        
    </nav>
</header>


    <main>
        <div class="content">
    
    <article class="post">
        <header>
            <h1><a href="&#x2F;blog&#x2F;2021&#x2F;12&#x2F;17&#x2F;type-coverage-for-sydent-evaluation&#x2F;" title="Type coverage for Sydent: evaluation">Type coverage for Sydent: evaluation</a></h1>
            <span>
                17.12.2021 00:00
                ‚Äî
                <a href="/category/tech">
                    Tech
                </a>
                ‚Äî
                <a href="/author/david-robertson">
                    David Robertson
                </a>
            </span>
            
        </header>
        <div>
            <p>This is the third in a series of three posts which discuss recent work to improve type annotations in <a href="https://github.com/matrix-org/sydent">Sydent</a>, the reference Matrix Identity server. <a href="https://matrix.org/blog/2021/12/10/type-coverage-for-sydent-annotation">Last time</a> we discussed the mechanics of how we added type coverage. Now I want to reflect on how well we did. What information and guarantees did we gain from <code>mypy</code>? How could we track our progress and measure the effect of our work? And lastly, what other tools are out there apart from <code>mypy</code>?</p>
<h2 id="the-best-parts-of-strict">The best parts of <code>--strict</code></h2>
<p>While the primary goal was to improve Sydent's coverage and robustness, to some extent this was an experiment too. How much could we get out of typing and static analysis, if we <em>really</em> invested in thorough annotations? Sydent is a small project that would make for a good testbed! I decided my goal would be to get Sydent passing mypy under <a href="https://mypy.readthedocs.io/en/stable/command_line.html#cmdoption-mypy-strict">--strict mode</a>. This is a command line option which turns on a number of extra checks (though not everything); it feels similar to passing <code>-Wall -Wextra -Werror</code> to <code>gcc</code>. It's a little extreme, but Sydent is a small project and this would be a good chance to see how hard it would be. In my view, the most useful options implied by strict mode were as follows.</p>
<h3 id="check-untyped-defs"><a href="https://mypy.readthedocs.io/en/stable/command_line.html#cmdoption-mypy-check-untyped-defs">--check-untyped-defs</a></h3>
<p>By default, mypy will only analyze the implementation of functions that are annotated. On the one hand, without annotations for inputs and the return type, it's going to be hard for mypy to thoroughly check the soundness of your function. On the other, it can still do good work with the type information it has from other sources. Mypy can</p>
<ul>
<li>infer the type of literals, e.g. deducing <code>x: str</code> from  <code>x = &quot;hello&quot;</code>;</li>
<li>lookup the return types of standard library calls, via <code>typeshed</code>; and similarly</li>
<li>lookup the return types of any annotated functions in your code or dependencies.</li>
</ul>
<p>The information is already available for free: we may as well try to use it to spot problems.</p>
<h3 id="disallow-untyped-defs-and-friends"><a href="https://mypy.readthedocs.io/en/stable/command_line.html#cmdoption-mypy-disallow-untyped-defs">--disallow-untyped-defs</a> and <a href="https://mypy.readthedocs.io/en/stable/command_line.html#untyped-definitions-and-calls">friends</a></h3>
<p>This flag forces you to fully annotate every function. There are less extreme versions available, e.g. <code>--disallow-incomplete-defs</code>; but I think this is a good option to ensure full coverage of your module. It means you can rely on mypy's error output as a to-do list.</p>
<p>One downside to this: sometimes I felt like I was writing obvious boilerplate annotations, e.g.</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span>    </span><span style="color:#569cd6;">def </span><span>__str__(self) -&gt; str:
</span><span>        </span><span style="color:#569cd6;">...
</span></code></pre>
<p>There was one particular example of this that crops up a lot. Mypy has a special exception for a class's <code>__init__</code> and <code>__init_subclass__</code> methods. If a return type annotation is missing, it will <a href="https://github.com/python/mypy/issues/604#issuecomment-348525995">assume these functions return None</a> instead of <code>Any</code>. (See  here for <a href="https://github.com/python/mypy/pull/5677">its implementation</a>.) This is normally compatible with <code>--disallow-untyped-defs</code> and <code>--disallow-incomplete-defs</code>, with one exception. If your <code>__init__</code> function takes no arguments other than <code>self</code>, mypy won't consider it annotated, and you'll need to write <code>-&gt; None</code> explicitly.</p>
<p>It's also worth mentioning <a href="https://mypy.readthedocs.io/en/stable/command_line.html#cmdoption-mypy-disallow-untyped-calls">--disallow-untyped-calls</a>, which will cause an error if an annotated function calls an unannotated function. Again, it helps to ensure that mypy has a complete picture of the types in your function's implementation. It also helps to highlight dependencies‚Äîif you see errors from this, it might be more practical to annotate the functions and modules it's calling first.</p>
<h3 id="warn-return-any"><a href="https://mypy.readthedocs.io/en/stable/command_line.html#cmdoption-mypy-warn-return-any">--warn-return-any</a></h3>
<p>If I've written a function and annotated it to return an <code>int</code>, mypy will rightly complain if its implementation actually goes on to return a <code>str</code>.</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#569cd6;">def </span><span>foo() -&gt; int:
</span><span>    </span><span style="color:#608b4e;"># error: Incompatible return value type (got &quot;str&quot;, expected &quot;int&quot;)
</span><span>    </span><span style="color:#569cd6;">return </span><span style="color:#d69d85;">&quot;hello&quot;
</span></code></pre>
<p>If mypy isn't sure what type I'm returning though, i.e. if I'm returning an expression of type <code>Any</code>, then by default mypy will trust that we've done the right thing.</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#569cd6;">def </span><span>i_promise_this_is_an_int():
</span><span>    </span><span style="color:#569cd6;">return </span><span style="color:#d69d85;">&quot;hello&quot;
</span><span>
</span><span style="color:#569cd6;">def </span><span>bar() -&gt; int:
</span><span>    reveal_type(i_promise_this_is_an_int()) </span><span style="color:#608b4e;"># Any
</span><span>    </span><span style="color:#569cd6;">return </span><span>i_promise_this_is_an_int()
</span></code></pre>
<p>Enabling <code>--warn-return-any</code> will disable this behaviour; to make this error pass we'll have to prove to mypy that <code>i_promise_this_is_an_int()</code> really is an <code>int</code>. Sometimes that will be the case, and an extra annotation will provide the necessary proof. At other times (like in this example), investigation will prove that there really is a bug!</p>
<h3 id="strict-equality"><a href="https://mypy.readthedocs.io/en/stable/command_line.html#cmdoption-mypy-strict-equality">--strict-equality</a></h3>
<p>This is a bit like a limited form of gcc's <a href="https://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html">-Wtautological-compare</a>. Mypy will report and reject equality tests between incompatible types. If mypy can spot that an equality is always <code>False</code>, there's a good chance of there being a bug in your program, or else an incorrect annotation.</p>
<p>I'm not sure how general this check is, since users can define their own types with their own rules for equality by overriding <a href="https://docs.python.org/3/reference/datamodel.html?highlight=__eq__#object.__eq__"><strong>eq</strong></a>. Perhaps it only applies to built-in types?</p>
<h2 id="quantifying-coverage">Quantifying coverage</h2>
<p>It was important to have some way to numerically evaluate our efforts to improve type coverage. It's a fairly abstract piece of work: there's nothing user-visible about it, unless we happen to discover a bug and fix it.</p>
<p>The most obvious metric is the number of total errors reported by mypy. Before the recent sprint, we had roughly 600 errors total.</p>
<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>dmr on titan in sydent on ÓÇ† HEAD (3dde3ad) via üêç v3.9.7 (env)
</span><span>2021-11-08 12:35:37 ‚úî  $ mypy --strict sydent
</span><span>Found 635 errors in 59 files (checked 78 source files)
</span></code></pre>
<p>This is a decent way to measure your progress when working on a particular module or package, but it's not perfect, because the errors aren't independent. Fixing one could fix another ten or reveal another twenty‚Äîthe numeric value can be erratic.</p>
<h3 id="reports">Reports</h3>
<p>I found mypy's various <a href="https://mypy.readthedocs.io/en/stable/command_line.html#report-generation">reports</a> to be a better approach here. There were three reports I found particularly useful.</p>
<h4 id="html-report"><code>--html-report</code></h4>
<p>This produces a main index page showing the &quot;imprecision&quot; of each module. At the bottom of the table is a total imprecision value across the entire project.</p>
<p><img src="/blog/img/2021-12-17-sydent-typing-html-report-index.png" alt="HTML report, index page. A table showing each module's precision and number of lines of code." /></p>
<p>The precision for each module is broken down line-by-line and colour-coded accordingly, which is useful for getting an intuition for what makes a line imprecise. More on that shortly.</p>
<p><img src="/blog/img/2021-12-17-sydent-typing-html-report-module.png" alt="HTML report, module page. Most lines of source code are highlighted green; a minority are highlighted red." /></p>
<h4 id="txt-report"><code>--txt-report</code></h4>
<p>This reproduces the index page from the <code>html</code> report as a plain text file. It's slightly easier to parse‚Äîthat's how I got the data for the precision line graphs in <a href="https://matrix.org/blog/2021/12/03/type-coverage-for-sydent-motivation">part one</a> of this series. That was a quick and dirty hack, though; a proper analysis of precision probably ought to read from the json or xml output formats. Here's a truncated sample:</p>
<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>+-----------------------------------+-------------------+----------+
</span><span>| Module                            | Imprecision       | Lines    |
</span><span>+-----------------------------------+-------------------+----------+
</span><span>| sydent                            |   0.00% imprecise |    1 LOC |
</span><span>| sydent.config                     |   0.00% imprecise |  266 LOC |
</span><span>| sydent.config._base               |   0.00% imprecise |   31 LOC |
</span><span>| sydent.config.crypto              |  15.94% imprecise |   69 LOC |
</span><span>| ...                               |               ... |      ... |
</span><span>| sydent.validators                 |   0.00% imprecise |   61 LOC |
</span><span>| sydent.validators.common          |   7.35% imprecise |   68 LOC |
</span><span>| sydent.validators.emailvalidator  |   1.30% imprecise |  154 LOC |
</span><span>| sydent.validators.msisdnvalidator |   1.34% imprecise |  149 LOC |
</span><span>+-----------------------------------+-------------------+----------+
</span><span>| Total                             |   5.95% imprecise | 9707 LOC |
</span><span>+-----------------------------------+-------------------+----------+
</span></code></pre>
<h4 id="any-exprs-report"><code>--any-exprs-report</code></h4>
<p>Selecting this option generate two reports: <code>any-exprs.txt</code> and <code>types-of-anys.txt</code>. The latter is interesting to understand where the <code>Anys</code> come from, but the former is more useful for quantifying the progress of typing. Another sample:</p>
<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>                  Name   Anys   Exprs   Coverage
</span><span>-------------------------------------------------
</span><span>                sydent      0       2    100.00%
</span><span>         sydent.config      0     185    100.00%
</span><span>   sydent.config._base      0       3    100.00%
</span><span>  sydent.config.crypto     34      80     57.50%
</span><span>sydent.config.database      0       8    100.00%
</span><span>   sydent.config.email      0      86    100.00%
</span><span>                   ...    ...     ...        ...
</span><span>-------------------------------------------------
</span><span>                 Total    544   11366     95.21%
</span></code></pre>
<p>The breakdown in <code>types-of-anys.txt</code> has more gory detail. I found the &quot;Unimported&quot; column particularly interesting: it lets us see how exposed we are to a lack of typing in our dependencies.</p>
<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>                             Name   Unannotated   Explicit   Unimported   Omitted Generics   Error   Special Form   Implementation Artifact
</span><span>-------------------------------------------------------------------------------------------------------------------------------------------
</span><span>                           sydent             0          0            0                  0       0              0                         0
</span><span>                    sydent.config             0          3            0                  0       0              0                         0
</span><span>              sydent.config._base             0          0            0                  0       0              0                         0
</span><span>                              ...           ...        ...          ...                ...     ...            ...                       ...
</span><span>        sydent.util.versionstring             0         80            0                  0       0              0                         0
</span><span>                sydent.validators             0          4            0                  0       0              0                         0
</span><span>         sydent.validators.common             0         20            0                  0       0              0                         0
</span><span> sydent.validators.emailvalidator             0          8            0                  0       0              0                         0
</span><span>sydent.validators.msisdnvalidator             0          8            0                  0       0              0                         0
</span><span>-------------------------------------------------------------------------------------------------------------------------------------------
</span><span>                            Total             9       1276          273                  0      37              0                        17
</span><span>
</span></code></pre>
<h3 id="the-meaning-of-precision">The meaning of precision</h3>
<p>There are two metrics I chose to focus on:</p>
<ul>
<li>the proportion of &quot;imprecise&quot; lines across the project; I also used the complement, <code>precision = 100% - imprecision</code>, and</li>
<li>the proportion of expressions whose type is not <code>Any</code>.</li>
</ul>
<p>These are plotted in the graph at the top of this writeup. I could see that precision and the proportion of typed expressions were correlated, but I didn't understand how they differed. I couldn't see an explanation in the mypy docs, so I went <a href="https://github.com/python/mypy/blob/d807e097d142a88a48af93314d15ad87e41d2f19/mypy/stats.py">digging</a> into the mypy source code. My understanding is as follows.</p>
<ol>
<li>There are <a href="https://github.com/python/mypy/blob/d807e097d142a88a48af93314d15ad87e41d2f19/mypy/stats.py#L27-L31">five kinds of precision</a>. Full details are visible in the <code>--lineprecision-report</code>.</li>
<li>Two kinds of precision, <code>EMPTY</code> and <code>UNANALYZED</code> convey no information, because there's nothing to analyze.</li>
<li>A line is marked as precise, imprecise or any based on the expressions it uses.
<ul>
<li>An expression that has type <code>Any</code> leads to precision <code>ANY</code>.</li>
<li>I <em>think</em> an expression that <a href="https://github.com/python/mypy/blob/2907a4dea939e20ff39ef7d9ff85ae1a199a0ee8/mypy/stats.py#L422-L423">involves <code>Any</code> but is not <code>Any</code></a> counts as imprecise. For instance, <code>Dict[str, Any]</code>.</li>
<li>Remaining expressions have precision <code>PRECISE</code>.</li>
</ul>
</li>
<li>A line's precision is the worst of all its expressions' precisions.
<ul>
<li><code>ANY</code> is worse than <code>IMPRECISE</code>, which is worse than <code>PRECISE</code>.</li>
</ul>
</li>
</ol>
<p>The &quot;imprecision&quot; number reported by mypy counts the number of lines <a href="https://github.com/python/mypy/blob/3bdef9fe6d401f3d2e0cacf4964bd315550c3394/mypy/xml/mypy-txt.xslt#L77-L78">classified as <code>IMPRECISE</code> or <code>ANY</code></a>.</p>
<p>On balance, my preferred metric is the line-level (im)precision percentage. There wasn't much difference between the two in my experience, but the colour-coded visualisation in the HTML report is a neat feature to have. Maybe in the future there could be a version of the HTML report that colour-codes each <em>expression</em>?</p>
<h2 id="the-larger-typing-ecosystem">The larger typing ecosystem</h2>
<p>There are plenty of articles out there about the typing. As well as the <a href="http://mypy-lang.blogspot.com/">mypy blog itself</a>, see Daniele Varrazzo's <a href="https://www.varrazzo.com/blog/2020/03/31/first-experience-mypy/">post on <code>psycopg3</code> (2020)</a>, Dropbox's <a href="https://dropbox.tech/application/our-journey-to-type-checking-4-million-lines-of-python">blog post (2019)</a>, Zulip's <a href="https://blog.zulip.com/2016/10/13/static-types-in-python-oh-mypy/">blog post (2016)</a>, Glyph's <a href="https://glyph.twistedmatrix.com/2020/07/new-duck.html">blog post on <code>Protocols</code> (2020)</a> and a follow-up <a href="https://glyph.twistedmatrix.com/2021/03/interfaces-and-protocols.html">comparing them to <code>zope.interface</code> (2021)</a> and Nylas's <a href="https://www.nylas.com/blog/not-your-pie-mypy/">blog (2019)</a>. I'm sure there's plenty more out there.</p>
<p>It's worth highlighting the <code>typeshed</code> project, which maintains stubs for the standard library, plus popular third-party libraries. I <a href="https://github.com/python/typeshed/pull/6150">submitted a PR</a> to add a single type hint‚Äîit was a very pleasant experience! Microsoft has an <a href="https://github.com/microsoft/python-type-stubs">incubator</a> of sorts for stubs too.</p>
<h3 id="other-typecheckers">Other typecheckers</h3>
<p>After the sprint to improve coverage, I spent a short amount of time trying the alternative type checkers out there. Mypy isn't the <em>only</em> typechecker out there‚Äîother companies have built and open-sourced their own tools, with different strengths, weaknesses and goals. This is by no means an authoritative, exhaustive survey‚Äîjust my quick notes.</p>
<h4 id="pyre-facebook"><a href="https://pyre-check.org/">Pyre</a> (Facebook)</h4>
<ul>
<li>I couldn't work out how to configure paths to resolve import errors; in the end, I wasn't able to process much of Sydent's source code.</li>
<li>Couldn't get it to process annotations like <code>syd: &quot;Sydent&quot;</code> where &quot;Sydent&quot; is an import guarded by <a href="https://docs.python.org/3/library/typing.html?highlight=type_checking#typing.TYPE_CHECKING">TYPE_CHECKING</a>.</li>
<li>No plugin system that I could see. That said, it has a separate mode/program for running <a href="https://pyre-check.org/docs/pysa-basics">&quot;Taint Analysis&quot;</a> to spot security issues.</li>
<li>Seemed stricter by default compared to mypy: there was less inference of types.</li>
<li>Also has its own strict mode.</li>
</ul>
<h4 id="pyright-microsoft"><a href="https://github.com/microsoft/pyright">Pyright</a> (Microsoft)</h4>
<ul>
<li>Didn't seem to recognise <code>getLogger</code> as being imported from <code>logging</code>. Not sure what happened there‚Äîmaybe something wrong with its bundled version of <code>typeshed</code>?</li>
<li>In a few places, Sydent uses <code>urllib.parse.quote</code> but only imports <code>urllib</code>. We must be unintentionally relying on our dependencies to <code>import urllib.parse</code> somewhere! Mypy didn't complain about this; pyright did.</li>
<li>Seemed to give a better explanations of why complex types were incompatible. For example:<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>/home/dmr/workspace/sydent/sydent/replication/pusher.py
</span><span>   /home/dmr/workspace/sydent/sydent/replication/pusher.py:77:16 - error: Expression of type &quot;DeferredList&quot; cannot be assigned to return type &quot;Deferred[List[Tuple[bool, None]]]&quot;
</span><span>     TypeVar &quot;_DeferredResultT@Deferred&quot; is contravariant
</span><span>       TypeVar &quot;_T@list&quot; is invariant
</span><span>         Tuple entry 2 is incorrect type
</span><span>           Type &quot;None&quot; cannot be assigned to type &quot;_DeferredResultT@_DeferredListResultItemT&quot; (reportGeneralTypeIssues)
</span><span> /home/dmr/workspace/sydent/sydent/sms/openmarket.py
</span><span>   /home/dmr/workspace/sydent/sydent/sms/openmarket.py:93:13 - error: Argument of type &quot;dict[_KT@dict, list[bytes]]&quot; cannot be assigned to parameter &quot;rawHeaders&quot; of type &quot;Mapping[AnyStr@__init__, Sequence[AnyStr@__init__]] | None&quot; in function &quot;__init__&quot;
</span><span>     Type &quot;dict[_KT@dict, list[bytes]]&quot; cannot be assigned to type &quot;Mapping[AnyStr@__init__, Sequence[AnyStr@__init__]] | None&quot;
</span><span>       TypeVar &quot;_KT@Mapping&quot; is invariant
</span><span>         Type &quot;_KT@dict&quot; is incompatible with constrained type variable &quot;AnyStr&quot;
</span><span>       Type cannot be assigned to type &quot;None&quot; (reportGeneralTypeIssues)
</span></code></pre>
This would have been really helpful when interpreting mypy's error reports; I'd love to see something like it in mypy.
Here's another example where I tried running against a Synapse file.<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>/home/dmr/workspace/synapse/synapse/storage/databases/main/cache.py
</span><span>/home/dmr/workspace/synapse/synapse/storage/databases/main/cache.py:103:53 - error: Expression of type &quot;list[tuple[Unknown, Tuple[Unknown, ...]]]&quot; cannot be assigned to declared type &quot;List[Tuple[int, _CacheData]]&quot;
</span><span>¬†¬†TypeVar &quot;_T@list&quot; is invariant
</span><span>¬†¬†¬†¬†Tuple entry 2 is incorrect type
</span><span>¬†¬†¬†¬†¬†¬†Tuple size mismatch; expected 3 but received indeterminate number (reportGeneralTypeIssues)
</span></code></pre>
This is really valuable information. It's worth considering Pyright as an option to get a second opinion!</li>
<li>It looks like Pyright's name for <code>Any</code> is <code>Unknown</code>. I think that does a better job of emphasising that <code>Unknown</code> won't be type checked. I'd certainly be more reluctant to type <code>x: Unknown</code> versus <code>x: Any</code>!</li>
<li>Pyright is the machinery behind <a href="https://github.com/microsoft/pylance-release">Pylance</a>, which drives <a href="https://marketplace.visualstudio.com/items?itemName=ms-python.vscode-pylance">VS Code's Python extension</a>. That alone probably makes it worthy of more eyes.</li>
<li>Seemed like it was the best-placed alternative typechecker to challenge mypy (the de-facto standard).</li>
</ul>
<h4 id="pytype-google"><a href="https://github.com/google/pytype">Pytype</a> (Google)</h4>
<ul>
<li>Google internal? Seems to be maintained by one person semiregularly by &quot;syncing&quot; from Google.</li>
<li>Apparently contains a script <a href="https://github.com/google/pytype/tree/master/pytype/tools/merge_pyi">merge-pyi</a> to annotate a source file given a stub file.</li>
<li>No support for TypedDict: as soon as it saw one in Sydent, it stopped all analysis.</li>
<li>No Python 3.10 support (according to the README anyway).</li>
<li>I think it might use a different kind of typing semantics; its <a href="https://google.github.io/pytype/typing_faq.html">typing FAQ</a> speaks of &quot;descriptive typing&quot; and a more lenient approach.</li>
</ul>
<h4 id="pycharm"><a href="https://www.jetbrains.com/pycharm/">PyCharm</a></h4>
<p>PyCharm has its own means to typechecking code as you write it. It's definitely caught bugs before, and having the instant feedback as you type is really nice! I have seen it struggle with <code>zope.interface</code> and some uses of <code>Generic</code>s though.</p>
<h3 id="runtime-uses-of-annotations">Runtime uses of annotations</h3>
<p>When annotations <a href="https://www.python.org/dev/peps/pep-3107/">were first introduced</a>, they were a generic means to associate Python objects with parts of a program. (It was only later that the community agreed that we really want to use them to annotate <em>types</em>). These annotations are available at runtime in the <code>__annotations__</code> attribute. There's also a helper function in <code>typing</code> which will help resolve forward references.</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span>&gt;&gt;&gt; </span><span style="color:#9b9b9b;">from </span><span>typing </span><span style="color:#9b9b9b;">import </span><span>get_type_hints
</span><span>&gt;&gt;&gt; </span><span style="color:#ff3333;">def </span><span>foo(x: int) -&gt; str: </span><span style="color:#569cd6;">pass
</span><span style="color:#569cd6;">...
</span><span>&gt;&gt;&gt; get_type_hints(foo)
</span><span>{</span><span style="color:#d69d85;">&#39;x&#39;</span><span>: &lt;</span><span style="color:#ff3333;">class </span><span style="color:#d69d85;">&#39;int&#39;</span><span>&gt;, </span><span style="color:#d69d85;">&#39;return&#39;</span><span>: &lt;</span><span style="color:#ff3333;">class </span><span style="color:#d69d85;">&#39;str&#39;</span><span>&gt;}
</span></code></pre>
<p>Programs and libraries are free to use these annotations at runtime as they see fit. The most well-known examples are probably <a href="https://docs.python.org/3/library/dataclasses.html">dataclasses</a>, <a href="https://www.attrs.org/en/stable/">attrs</a> with <a href="https://www.attrs.org/en/stable/types.html">auto_attribs=True</a> and <a href="https://pydantic-docs.helpmanual.io/">Pydantic</a>. I'd be interested to learn if anyone else is consuming annotations at runtime!</p>
<h2 id="summary">Summary</h2>
<p>All in all, in a two-week sprint we were able to get Sydent's mypy coverage from a precision of 83% up to 94%. Our work would have spotted the <a href="https://github.com/matrix-org/sydent/pull/415">bytes-versus-strings bug</a>; we understand why <a href="https://github.com/matrix-org/sydent/pull/413">the missing await</a> wasn't detected. We <a href="https://github.com/matrix-org/sydent/issues/419">fixed</a> <a href="https://github.com/matrix-org/sydent/issues/449">other</a> <a href="https://github.com/matrix-org/sydent/issues/447">small</a> <a href="https://github.com/matrix-org/sydent/issues/445">bugs</a> too as part of the process. As well as fix bugs, I've hopefully made the source code clearer for future readers (but that one is hard to quantify).</p>
<p>There's room to spin out contributions upstream too. I submitted <a href="https://github.com/twisted/twisted/pull/1669">two</a> <a href="https://github.com/twisted/twisted/pull/1668">PRs</a> to twisted upstream; have started to work on annotations for <a href="https://github.com/pyca/pynacl/pull/693">pynacl</a> <a href="https://github.com/pyca/pynacl/pull/694">in my</a> <a href="https://github.com/pyca/pynacl/pull/695">spare time</a>; and submitted a quick fix to <a href="https://github.com/python/typeshed/pull/6150">typeshed</a>.</p>
<p>Looking forward, I think we'd get a quick gain from ensuring that our smaller libraries (<a href="https://github.com/matrix-org/python-signedjson">signedjson</a>, <a href="https://github.com/matrix-org/python-canonicaljson">canonicaljson</a>) are annotated. We'll be sticking with mypy for now‚Äîthe <code>mypy-zope</code> plugin is crucial given our reliance on twisted. We're also working to improve Sygnal and Synapse‚Äîthough not to the extreme standard of <code>--strict</code> across everything.</p>
<p>I'd say the biggest outstanding hole is our processing of JSON objects. There's too much <code>Dict[str, Any]</code> flying around. The ideal for me would be to define <code>dataclass</code> or <code>attr.s</code> class <code>C</code>, and be able to deserialise a JSON object to <code>C</code>, including automatic (deep) type checking. <a href="https://pydantic-docs.helpmanual.io/">Pydantic</a> sounds really close to what we want, but I'm told it will by default gladly interpret the json string <code>&quot;42&quot;</code> as the Python integer <code>42</code>, which isn't what we'd like. More investigation needed there. There are other avenues to explore too, like <a href="https://github.com/erickpeirson/jsonschema-typed">jsonschema-typed</a>, <a href="https://pypi.org/project/typedload/">typedload</a> or <a href="https://github.com/bloomberg/attrs-strict">attrs-strict</a>.</p>
<p>To end, I'd like to add a few personal thoughts. Having types available in the source code is definitely A Good Thing. But there is a part of me that wonders if it might have been worth writing our projects in a language which incorporates types from day one. There are always trade-offs, of course: runtime performance, build times, iteration speed, ease of onboarding new contributors, ease of deployment, availability of libraries, ability to shoot yourself in the foot... the list goes on. </p>
<p>On a more upbeat note, adding typing is a great way to get familiar with new source code. It involves a mixture of reading, cross-referencing, deduction, analysis, all across a wide variety of files. It'd be a <em>lot</em> easier to type as you write from the get-go, but typing after the fact is still a worthy use of time and effort. </p>
<hr />
<p>Many thanks for reading! If you've got any corrections, comments or queries, I'm available on Matrix at <a href="https://matrix.to/#/@dmrobertson:matrix.org">@dmrobertson:matrix.org</a>.</p>

        </div>
    </article>
    
    <article class="post">
        <header>
            <h1><a href="&#x2F;blog&#x2F;2021&#x2F;12&#x2F;15&#x2F;on-matrix-and-the-log4j-vulnerabilities&#x2F;" title="On Matrix and the log4j vulnerabilities">On Matrix and the log4j vulnerabilities</a></h1>
            <span>
                15.12.2021 12:58
                ‚Äî
                <a href="/category/security">
                    Security
                </a>
                ‚Äî
                <a href="/author/matrix-security">
                    Matrix Security
                </a>
            </span>
            
        </header>
        <div>
            <p>There is currently a lot of buzz and uncertainty around a number of vulnerabilities discovered in the log4j library in the Java ecosystem. These vulnerabilities are collectively known as &quot;Log4Shell&quot; and currently encompass CVE-2021-44228 and CVE-2021-45046.</p>
<p>First and foremost, there are to our knowledge no Matrix homeservers written in Java. <a href="https://github.com/matrix-org/synapse/">Synapse</a>, the canonical implementation developed by the Matrix Foundation and the implementation that is backing matrix.org, is written in Python and thus unaffected. P2P Matrix relies on <a href="https://github.com/matrix-org/dendrite">Dendrite</a>, our next-gen homeserver which is written in Go and is unaffected. <a href="https://gitlab.com/famedly/conduit/">Conduit</a>, a community homeserver, is written in Rust and also unaffected. Supporting components like <a href="https://github.com/matrix-org/sygnal">Sygnal</a> and <a href="https://github.com/matrix-org/sydent">Sydent</a> are written in Python and unaffected.</p>
<p>There are two components that are commonly used in the Matrix ecosystem that do rely on Java. These are Jitsi, specifically the <a href="https://github.com/jitsi/jitsi-videobridge">Jitsi Videobridge</a> for VoIP, and <a href="https://gitlab.com/signald/signald">signald</a> used by the Signal bridge. Both components pull in log4j as part of their (transitive) dependencies. We're not aware of other bridges that are dependent on Java-based components.</p>
<p>For both of these projects updates have been published that integrate log4j 2.15.0 covering the initial CVE and we're currently waiting for additional updates to be published that integrate log4j 2.16.0 to cover the second. In the meantime, we've put all mitigations we are aware of in place on our systems and we strongly recommend everyone do the same.</p>
<p>For what mitigations to put in place, we recommend following the <a href="https://www.lunasec.io/docs/blog/log4j-zero-day-mitigation-guide/">recommendations provided by LunaSec</a>. They also provide a lot of background information on the vulnerabilities and how to audit for them.</p>
<p>Please keep an eye out for releases from the Jitsi and signald projects and follow their upgrade instructions to update your own deployments as soon as possible.</p>

        </div>
    </article>
    
    <article class="post">
        <header>
            <h1><a href="&#x2F;blog&#x2F;2021&#x2F;12&#x2F;14&#x2F;synapse-1-49-0-released&#x2F;" title="Synapse 1.49.0 released">Synapse 1.49.0 released</a></h1>
            <span>
                14.12.2021 00:00
                ‚Äî
                <a href="/category/releases">
                    Releases
                </a>
                ‚Äî
                <a href="/author/brendan-abolivier">
                    Brendan Abolivier
                </a>
            </span>
            
        </header>
        <div>
            <p><a href="https://github.com/matrix-org/synapse/releases/tag/v1.49.0">Synapse 1.49.0</a> is out now!</p>
<h2 id="platform-deprecations">Platform deprecations</h2>
<p>Synapse 1.49.0 is the last version of Synapse to officially support Python 3.6 and PostgreSQL 9.6. This follows our <a href="https://matrix-org.github.io/synapse/v1.49/deprecation_policy.html">platform dependency deprecation policy</a>.</p>
<p>As a consequence of this, Synapse 1.49.0 is the last version of Synapse to support Ubuntu 18.04 LTS (Bionic Beaver), as it ships with Python 3.6.</p>
<p>On the topic of supported Ubuntu releases, please note that Ubuntu 21.04 (Hirsute Hippo) reaches its own end of life <a href="https://lists.ubuntu.com/archives/ubuntu-announce/2021-December/000275.html">on January 20, 2022</a>. Past this date we will stop producing new packages for Ubuntu 21.04.</p>
<h2 id="improved-documentation">Improved documentation</h2>
<p>Up until now, a lot of very useful information was stored on the <a href="https://github.com/matrix-org/synapse/wiki">Synapse repo's wiki</a>, which wasn't well advertised nor well reviewed.</p>
<p>With this release, we have migrated most of this information to Synapse's <a href="https://matrix-org.github.io/synapse/latest">documentation website</a>, so all the information you need to set up, maintain and troubleshoot a Synapse instance lives at the same place. Included in these new pages are the <a href="https://matrix-org.github.io/synapse/v1.49/usage/administration/admin_faq.html">server admin FAQ</a> and a <a href="https://matrix-org.github.io/synapse/v1.49/usage/administration/understanding_synapse_through_grafana_graphs.html">guide to Synapse's Grafana dashboard</a>.</p>
<p>The <a href="https://matrix-org.github.io/synapse/v1.49/media_repository.html">media repository</a> documentation has also been updated with a lot of details about how Synapse stores media files.</p>
<h2 id="refresh-tokens">Refresh tokens</h2>
<p>When a Matrix client needs to authenticate a request to a homeserver, it uses what is called an access token. Sometimes server administrators might not want a user's access token to live forever (e.g. for security reasons). To address this concern, <a href="https://github.com/matrix-org/matrix-doc/pull/2918">MSC2918</a> introduces the concept of refresh tokens to Matrix.</p>
<p>Initial support for refresh tokens in Synapse was introduced in <a href="https://github.com/matrix-org/synapse/releases/tag/v1.38.0">version 1.38.0</a>. Synapse 1.49.0 finalises and stabilises this implementation, allowing any client that supports this feature to use it as it is currently described in the related MSC.</p>
<h2 id="everything-else">Everything else</h2>
<p>This release introduces the last changes needed to Synapse for basic threading support. It also introduces support for <a href="https://github.com/matrix-org/matrix-doc/pull/3030">MSC3030</a>, which allows clients to jump to a specific date in a room's history (expect a sneak peek of this in the next episode of Matrix Live!).</p>
<p>Another interesting point is the addition of a couple of <a href="https://matrix-org.github.io/synapse/v1.49/usage/administration/admin_api/federation.html">admin APIs for federation</a>. More specifically, they allow you to visualise all of the other homeservers your Synapse instance has been interacting with, as well as how successful the last attempts at communicating with them have been.</p>
<p>Please see the Synapse <a href="https://github.com/matrix-org/synapse/blob/v1.49.0/CHANGES.md">release notes</a> for a complete list of changes in this release.</p>
<p>Synapse is a Free and Open Source Software project, and we'd like to extend our thanks to everyone who contributed to this release, including <a href="https://github.com/dklimpel">Dirk Klimpel</a>, <a href="https://github.com/Ma27">Maximilian Bosch</a> and <a href="https://github.com/tulir">Tulir Asokan</a>.</p>
<h2 id="till-next-year">Till next year</h2>
<p>This is the last release of Synapse of 2021! The Synapse team will take a break for the holidays, pushing the next release of Synapse (1.50.0) to January 11, 2022.</p>
<p>We'd like to thank everyone who has been using Synapse, contributing to it, and/or supporting us for the past year, and we hope to see you again in 2022! üéÜ</p>

        </div>
    </article>
    
    <article class="post">
        <header>
            <h1><a href="&#x2F;blog&#x2F;2021&#x2F;12&#x2F;13&#x2F;disclosure-buffer-overflow-in-libolm-and-matrix-js-sdk&#x2F;" title="Disclosure: buffer overflow in libolm and matrix-js-sdk">Disclosure: buffer overflow in libolm and matrix-js-sdk</a></h1>
            <span>
                13.12.2021 18:35
                ‚Äî
                <a href="/category/security">
                    Security
                </a>
                ‚Äî
                <a href="/author/matrix-security">
                    Matrix Security
                </a>
            </span>
            <br>
            <small>Last update: 13.12.2021 16:11</small>
        </header>
        <div>
            <p>Today we are releasing security updates to libolm, matrix-js-sdk, and several clients including Element Web / Desktop. Users are encouraged to upgrade as soon as possible. This resolves the <a href="https://matrix.org/blog/2021/12/03/pre-disclosure-upcoming-security-release-of-libolm-and-matrix-js-sdk">pre-disclosure</a> issued on December 3rd.</p>
<p>Fixed library versions are:</p>
<ul>
<li>libolm: <a href="https://gitlab.matrix.org/matrix-org/olm/-/tree/3.2.8">3.2.8</a></li>
<li>matrix-js-sdk: <a href="https://github.com/matrix-org/matrix-js-sdk/releases/tag/v15.2.1">15.2.1</a></li>
</ul>
<p>Client versions incorporating the fixes are:</p>
<ul>
<li>Element Web / Desktop: <a href="https://github.com/vector-im/element-web/releases/tag/v1.9.7">1.9.7</a></li>
<li>SchildiChat Web / Desktop: <a href="https://github.com/SchildiChat/schildichat-desktop/releases/tag/v1.9.7-sc.1">1.9.7-sc.1</a></li>
<li>Cinny: <a href="https://github.com/ajbura/cinny/releases/tag/v1.6.0">1.6.0</a></li>
</ul>
<p>These releases mitigate a buffer overflow in <code>olm_session_describe</code>, a libolm debugging function used by matrix-js-sdk in its end-to-end encryption (E2EE) implementation. If you rely on matrix-js-sdk for E2EE, you are affected. This vulnerability has been assigned <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44538">CVE-2021-44538</a>.</p>
<p>Clients which do <em>not</em> use matrix-js-sdk for E2EE, like FluffyChat or Element Android / iOS, are <em>not</em> affected.</p>
<p>This issue has been present since the introduction of the <code>olm_session_describe</code> function in October 2019 (commits: <a href="https://gitlab.matrix.org/matrix-org/olm/-/commit/39a1ee0b18f0fced6d7bc293cc9a46ea70ec9e96">libolm</a>, <a href="https://github.com/matrix-org/matrix-js-sdk/commit/e6699c5424a856a639baa6d6f78d44594baaf404">matrix-js-sdk</a>).</p>
<p>We do not believe it is practical to successfully exploit this issue. However, upgrading remains important as the overflow <em>can</em> be triggered remotely.</p>
<p>Separately from the above vulnerability, we noticed during an internal audit that the libolm bindings in matrix-js-sdk were not zeroing out certain arrays containing entropy for cryptographic operations. This causes the entropy to remain resident in memory longer than necessary. As a defense-in-depth measure, this release of libolm now proactively overwrites those arrays when it is safe to do so.</p>
<p>Lastly, we are also taking this opportunity to update the version of Electron bundled with Element Desktop, pulling in the latest backported security fixes there.</p>
<p>The buffer overflow was found and reported by GitHub user <a href="https://github.com/brevilo">@brevilo</a> in the course of developing <a href="https://github.com/brevilo/jolm/">jOlm</a>, a library of Java bindings to libolm; thank you. If you believe you've discovered a security vulnerability in Matrix or its implementations, please see our <a href="https://matrix.org/security-disclosure-policy/">Security Disclosure Policy</a> for how to get in touch.</p>

        </div>
    </article>
    
    <article class="post">
        <header>
            <h1><a href="&#x2F;blog&#x2F;2021&#x2F;12&#x2F;10&#x2F;this-week-in-matrix-2021-12-10&#x2F;" title="This Week in Matrix 2021-12-10">This Week in Matrix 2021-12-10</a></h1>
            <span>
                10.12.2021 19:24
                ‚Äî
                <a href="/category/this-week-in-matrix">
                    This Week in Matrix
                </a>
                ‚Äî
                <a href="/author/thib">
                    Thib
                </a>
            </span>
            <br>
            <small>Last update: 10.12.2021 19:09</small>
        </header>
        <div>
            <h2 id="the-adventures-of-twim-bot">The Adventures of TWIM bot</h2>
<p>Last week the Matrix Scientists had turned this room into a portal to TWIM bot's ship tank so we could all fuel it with news about our work. The spec and hookshot news were reported late when the tank was already full, sending TWIM bot's ship into hyperspeed mode üöÄ</p>
<p>We lost contact with the bot for a few days but managed to restore a connection with it. It appeared to have crashed on the green planet of Fuj'ehr. Its ship shattered in pieces at impact! üí•</p>
<p>The bot managed to find most of them, but some critical pieces of the engine were missing. We needed to find those pieces quickly before the mushy ground of Fuj'ehr swallows them forever! üò±</p>
<p>The Editor has asked the Matrix Scientists to reconfigure the room and bridge it to TWIM bot's navigation tools. Each news report highlighted the position of a piece of engine on its map. üó∫Ô∏è</p>
<h2 id="matrix-live">Matrix Live üéô</h2>
<iframe src="https://www.youtube.com/embed/tLlSGqzgzhg" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<p>This week my guests are the FluffyChat and MinesTRIX maintainers, following the v1 release of the simple and beautiful FluffyChat‚Ä¶ and they want to work together!</p>
<h2 id="dept-of-status-of-matrix-face-with-th">Dept of <em>Status of Matrix</em> üå°Ô∏è</h2>
<p><a href="https://matrix.to/#/@austin:tchncs.de">Austin Huang</a> reports</p>
<blockquote>
<p>Version numbers of each homeserver, updated daily using a <a href="https://github.com/austinhuang0131/austinhuang0131.github.io/blob/master/.github/workflows/matrix_ver.yml">GitHub Action</a>, are now added onto my <a href="https://austinhuang.me/matrix-homeservers.html">public homeserver list</a>, in hopes that it will further aid those choosing a homeserver to use Matrix on.</p>
</blockquote>
<p>Very handy to quickly know if a server is well maintained or not before making it your new home!</p>
<h2 id="dept-of-spec-scroll">Dept of Spec üìú</h2>
<p><a href="https://matrix.to/#/@andrewm:amorgan.xyz">anoa</a> says</p>
<blockquote>
<p>Here's your weekly spec update! The heart of Matrix is the specification - and this is modified by Matrix Spec Change (MSC) proposals. Learn more about how the process works at https://spec.matrix.org/unstable/proposals.</p>
<h2 id="msc-status">MSC Status</h2>
<p><strong>New MSCs:</strong></p>
<ul>
<li><a href="https://github.com/matrix-org/matrix-doc/pull/3554">MSC3554: Extensible Events - Translatable Text</a></li>
<li><a href="https://github.com/matrix-org/matrix-doc/pull/3553">MSC3553: Extensible Events - Videos</a></li>
<li><a href="https://github.com/matrix-org/matrix-doc/pull/3552">MSC3552: Extensible Events - Images and Stickers</a></li>
<li><a href="https://github.com/matrix-org/matrix-doc/pull/3551">MSC3551: Extensible Events - Files</a></li>
<li><a href="https://github.com/matrix-org/matrix-doc/pull/3550">MSC3550: Allow HTTP 403 as a response to profile lookups</a></li>
<li><a href="https://github.com/matrix-org/matrix-doc/pull/3548">MSC3547: Allow appservice bot user to read any rooms the appserice is part of</a></li>
</ul>
<p><strong>MSCs with proposed Final Comment Period:</strong></p>
<ul>
<li><em>No MSCs entered proposed FCP state this week.</em></li>
</ul>
<p><strong>MSCs in Final Comment Period:</strong></p>
<ul>
<li><em>No MSCs are in FCP.</em></li>
</ul>
<p><strong>Merged MSCs:</strong></p>
<ul>
<li><a href="https://github.com/matrix-org/matrix-doc/pull/3419">MSC3419: Allow guests to send more event types</a></li>
</ul>
<h2 id="spec-updates">Spec Updates</h2>
<p>Extensible events are coming! With lots of potential usecases to be built on top of the concept (such as threading, polls, and any type of data one would like to through on top of existing room events), extensible events are finally getting some love. New MSCs are available above, which detail some of these usecases. Exciting times!</p>
<p>A small correction from last week's issue: the next aggregations MSC to be focused on (after <a href="https://github.com/matrix-org/matrix-doc/pull/2675">MSC2675</a> (serverside aggregations) is <a href="https://github.com/matrix-org/matrix-doc/pull/2677">MSC2677</a> (annotations and reactions), as it's a more pressing blocker for usecases such as threading and polls.</p>
<p>Otherwise, the Spec Core Team is continuing to wind down in preparation for the holidays ‚òÉÔ∏è</p>
<h2 id="random-msc-of-the-week">Random MSC of the Week</h2>
<p>The random spec of the week is... <a href="https://github.com/matrix-org/matrix-doc/pull/3015">MSC3015: Room state personal overrides</a>.</p>
<p>Quite a novel concept, and one that would enable many usecases, such as the ones described in the MSC itself.
Check it out if that's something that interests you!
<img src="/blog/img/5c2f21a5f2f17106aad9fd177c973720bb611cd0.png" alt="" /></p>
</blockquote>
<h2 id="dept-of-servers-europea">Dept of Servers üè¢</h2>
<h3 id="synapse">Synapse <a href="https://github.com/matrix-org/synapse/">‚Üó</a></h3>
<p>Synapse is the reference homeserver for Matrix</p>
<p><a href="https://matrix.to/#/@dmrobertson:matrix.org">dmr</a> reports</p>
<blockquote>
<p>This week we cut Synapse release candidate <a href="https://github.com/matrix-org/synapse/releases/tag/v1.49.0rc1">1.49.0rc1</a> It includes a bunch of work to supporta plethora of MSCs (<a href="https://github.com/matrix-org/matrix-doc/pull/2675/">MSC 2675</a>, <a href="https://github.com/matrix-org/matrix-doc/pull/3030">MSC3030</a>, <a href="https://github.com/matrix-org/matrix-doc/blob/main/proposals/2918-refreshtokens.md#msc2918-refresh-tokens">MSC2918</a>, <a href="https://github.com/matrix-org/matrix-doc/pull/2946">MSC2946</a>), a crop of bugfixes and improvements to our documentation which incorporate Synapse's old wiki. And as ever, there's a bunch of internal type hinting to keep the Synapse team's blood pressure at healthy levels.</p>
<p>The formal release of Synapse 1.49.0 is scheduled for the coming Tuesday. This will be the last Synapse release of 2021 as the Synapse team prepare for a break over the Christmas period. Releases will continue at the usual pace in the new year, with 1.50.0rc1 slated for 2022/01/04 and 1.50.0 for 2022/01/11.</p>
<p><strong>Please note:</strong> Synapse 1.49 will be the last version to support Python 3.6, PostrgreSQL 9.6, and Ubuntu 18.04 LTS (Bionic): by our next release, these will have reached their upstream end-of-life. If you're reliant on any of these platforms, please ensure you have plans to upgrade.</p>
<p>In other news, we're <a href="https://github.com/matrix-org/sygnal/blob/main/CHANGELOG.md#sygnal-0110-2021-12-09">preparing</a> to release a new version of <a href="https://github.com/matrix-org/sygnal">Sygnal</a> with a series of fixes for common errors. This should make Sygnal administrators much happier by removing an awful lot of error spam from logs!</p>
</blockquote>
<h3 id="sydent">Sydent <a href="https://github.com/matrix-org/sydent">‚Üó</a></h3>
<p>Sydent is the reference Matrix Identity server. It provides a lookup service, so that you can find a Matrix user via their email address or phone number (if they have chosen to share it).</p>
<p><a href="https://matrix.to/#/@dmrobertson:matrix.org">dmr</a> says</p>
<blockquote>
<p>The second <a href="https://matrix.org/blog/2021/12/10/type-coverage-for-sydent-annotation">blog post</a> on improving Sydent's type coverage should be published now. See the first post <a href="https://matrix.org/blog/2021/12/03/type-coverage-for-sydent-motivation">here</a> from last week.</p>
</blockquote>
<h2 id="homeserver-deployment-inbox-tray">Homeserver Deployment üì•Ô∏è</h2>
<h3 id="helm-chart">Helm Chart <a href="https://gitlab.com/ananace/charts">‚Üó</a></h3>
<p>Matrix Kubernetes applications packaged into helm charts</p>
<p><a href="https://matrix.to/#/@ace:kittenface.studio">Ananace</a> reports</p>
<blockquote>
<p>This week has seen yet another set of updates to <a href="https://gitlab.com/ananace/charts">my Helm Charts</a>, with element-web being bumped to 1.9.6 and matrix-synapse seeing fixes to non-standard port configurations and better support for modern ingressClass handling.</p>
</blockquote>
<h2 id="dept-of-clients-iphone">Dept of Clients üì±</h2>
<h3 id="nheko">Nheko <a href="https://nheko-reborn.github.io">‚Üó</a></h3>
<p>Desktop client for Matrix using Qt and C++17.</p>
<p><a href="https://matrix.to/#/@deepbluev7:neko.dev">Nico</a> reports</p>
<blockquote>
<p>If you are using Nheko on a mobile device like the PinePhone, you should now be able to swipe between the room list and the spaces list. Since I don't use a PinePhone, feedback will be appreciated!</p>
</blockquote>
<h3 id="neochat">Neochat <a href="https://invent.kde.org/network/neochat">‚Üó</a></h3>
<p>A client for matrix, the decentralized communication protocol</p>
<p><a href="https://matrix.to/#/@tobiasfella:kde.org">Tobias Fella</a> announces</p>
<blockquote>
<p>NeoChat version 21.12 is out! You may have noticed that this version number is roughly twenty times higher than the previous one. This means that NeoChat is now twenty times as good as the last version. Or it means that version numbers are utterly meaningless and we switched to a date-based version number system since NeoChat is now released together with many other plasma-mobile related apps. This also means that new versions will arrive monthly from now on. New features and fixes in this version include - but are not limited to:</p>
<ul>
<li>Spell checking while writing a message</li>
<li>Improved markdown to html conversion when sending a message</li>
<li>Built-in theme switching</li>
<li>Various fixes to login, logout and account switching</li>
<li>Support for custom emojis</li>
<li>Support for Spoilers</li>
<li>Support for Blurhashes</li>
</ul>
<p><img src="/blog/img/6dd2cd893f050b850d598dac0a04eb6cbe655dc3.png" alt="" />
<img src="/blog/img/c740e976129867e670cad45ffffc08beeb802387.png" alt="" /></p>
</blockquote>
<h3 id="element">Element <a href="https://element.io">‚Üó</a></h3>
<p>Everything related to Element but not strictly bound to a client</p>
<p><a href="https://matrix.to/#/@daniellekirkwood:one.ems.host">Danielle Kirkwood</a> announces</p>
<blockquote>
<h2 id="threads">Threads</h2>
<ul>
<li>Threads is making excellent progress; This week we held 2 internal testing sessions, both of which went swimmingly.</li>
<li>We‚Äôre continuing our hard-work on Notifications to fix those up as best we can.</li>
<li>Also, we started work on the Threads Filter. The filter will allow you to choose between all the threads in a room and threads you‚Äôve actively participated in.</li>
<li>If you‚Äôre using the Labs version of Threads, let us know what you think so far!</li>
</ul>
<h2 id="polls">Polls</h2>
<ul>
<li>Exciting news on Polls; All development on Polls MVP is nearly complete, and will soon be making their way to a production environment near you!</li>
<li>Polls will be available behind Labs flags at first. We're excited to see people using it and we‚Äôre looking forward to hearing any feedback/comments.</li>
</ul>
<h2 id="community-testing">Community Testing</h2>
<ul>
<li>Closed 20 out of 36 issues in encryption and verification (E2EE) this week.</li>
<li>We are planning three testing sessions for next week:
<ul>
<li>Tuesday 17:00-18:00 UTC - first time user experience on iOS, Android and Web</li>
<li>Wednesday: 16:00-17:30 UTC - information architecture changes on Web (with Michael and Nique joining us from the Delight team)</li>
<li>Thursday 16:30-18:00 UTC - bug squash edition on encryption, can we get the issue count to an all new low?</li>
</ul>
</li>
<li>Join us! We‚Äôre at <a href="https://matrix.to/#/#element-community-testing:matrix.org">#element-community-testing:matrix.org</a></li>
</ul>
</blockquote>
<h3 id="element-web-desktop">Element Web/Desktop <a href="https://github.com/vector-im/element-web">‚Üó</a></h3>
<p>Secure and independent communication, connected via Matrix. Come talk with us in <a href="https://matrix.to/#/#element-web:matrix.org">#element-web:matrix.org</a>!</p>
<p><a href="https://matrix.to/#/@daniellekirkwood:one.ems.host">Danielle Kirkwood</a> announces</p>
<blockquote>
<ul>
<li>We are monitoring and triaging feedback, which is submitted through the new feedback interface in the app. </li>
<li>In Labs:
<ul>
<li>Work continues on <a href="https://github.com/vector-im/element-meta/issues/56">Information Architecture</a>: this week we‚Äôve made a spotlight search labs feature that we‚Äôll be testing to replace the current filter.</li>
<li>We‚Äôre also starting to test preferences per space, so keep your eyes peeled for those.</li>
</ul>
</li>
</ul>
</blockquote>
<p><a href="https://matrix.to/#/@madlittlemods:matrix.org">madlittlemods (Eric Eastwood)</a> reports:</p>
<blockquote>
<h2 id="jump-to-date-headers-soon-in-element">Jump to date headers soon in Element</h2>
<p>From the <a href="https://matrix.org/blog/2021/12/03/this-week-in-matrix-2021-12-03#gitter">experimental MSC3030 implementation merge to Synapse update</a> in TWIM last week, we now also have the start of some <a href="https://github.com/matrix-org/matrix-react-sdk/pull/7317">client usage in Element</a> to make featureful jump to date headers!</p>
<p>If you've ever tried to find a message back in the past, you've experienced the burdensome task of having to scroll back manually for days, even months! With the jump to date headers, that will be a thing of the past üòå. Clicking any date separator in the room timeline, will give shortcuts to jump to last week, last month, jump to any date using the date picker, or even the beginning of the room to follow a room upgrade chain.</p>
<p><img src="/blog/img/2021-12-10-jumptodate.png" alt="" /></p>
<p>This is currently still in a <a href="https://github.com/matrix-org/matrix-react-sdk/pull/7317">draft pull request state</a> but will give another update when it lands in Element Labs for everyone to use.</p>
</blockquote>
<h3 id="element-ios">Element iOS <a href="https://github.com/vector-im/element-ios">‚Üó</a></h3>
<p>Secure and independent communication for iOS, connected via Matrix. Come talk with us in <a href="https://matrix.to/#/#element-ios:matrix.org">#element-ios:matrix.org</a>!</p>
<p><a href="https://matrix.to/#/@daniellekirkwood:one.ems.host">Danielle Kirkwood</a> reports</p>
<blockquote>
<ul>
<li>On iOS it‚Äôs been a week of completing things!</li>
<li>We‚Äôve made some final changes to PostHog analytics and MatrixKit has been integrated in element-ios.</li>
<li>There have also been lots of bug fixes - especially around an app crash.</li>
<li>Don‚Äôt forget! As per our update from last week, our release candidates are now prepared on Tuesdays (not Wednesdays).</li>
</ul>
</blockquote>
<h3 id="element-android">Element Android <a href="https://github.com/vector-im/element-android">‚Üó</a></h3>
<p>Secure and independent communication for Android, connected via Matrix. Come talk with us in <a href="https://matrix.to/#/#element-android:matrix.org">#element-android:matrix.org</a>!</p>
<p><a href="https://matrix.to/#/@daniellekirkwood:one.ems.host">Danielle Kirkwood</a> reports</p>
<blockquote>
<ul>
<li>Element Android 1.3.9 has been released on the PlayStore and is available for the beta testers:
<ul>
<li>This version adds support for draft voice messages and a new design for URL previews.</li>
</ul>
</li>
<li>Opt-in PostHog analytics will land soon, and will be included in the next release. </li>
<li>A new &quot;Legals‚Äù screen has been added to Settings in order for users to see all legal info pages for Element, the user's homeserver and the user's identity server (if any).</li>
<li>The next release candidate will be prepared next Tuesday.</li>
</ul>
</blockquote>
<h3 id="commune">Commune <a href="https://github.com/commune-org/commune">‚Üó</a></h3>
<p>Commune is a communications suite built on top of matrix. Commune aims to bring together chat, discussions, email and other interactive apps into a single matrix client.</p>
<p><a href="https://matrix.to/#/@erlend_sh:matrix.org">erlend_sh</a> says</p>
<blockquote>
<p>So here‚Äôs the thing ahq (dev) and I (product) have been working on: https://github.com/commune-org/commune
It‚Äôs a chat/forum hybrid. Still in pre-alpha, proof-of-concept stage.</p>
<p><img src="/blog/img/2021-12-10-commune-1.png" alt="" /></p>
<p><img src="/blog/img/2021-12-10-commune-2.png" alt="" /></p>
<p><img src="/blog/img/2021-12-10-commune-3.png" alt="" /></p>
</blockquote>
<h2 id="dept-of-non-clients-control-knobs">Dept of Non Clients üéõÔ∏è</h2>
<h3 id="matrix-streamchat">matrix-streamchat <a href="https://git.pixie.town/f0x/matrix-streamchat">‚Üó</a></h3>
<p>Matrix powered stream overlay for OBS, to integrate live chat in your favorite (selfhosted) streaming setups.</p>
<p><a href="https://matrix.to/#/@f0x:pixie.town">f0x</a> announces</p>
<blockquote>
<p>TWIM I wrote a Matrix powered stream overlay for OBS, to integrate live chat in your favorite (selfhosted) streaming setups. Was a great little 2 evening project to develop while livestreaming it's development :)</p>
<p>You can find the code and instructions at https://git.pixie.town/f0x/matrix-streamchat
and a hosted instance at https://streamchat.pixie.town</p>
</blockquote>
<iframe src="https://www.youtube.com/embed/03F8Bv2_leM" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<h2 id="dept-of-sdks-and-frameworks">Dept of SDKs and Frameworks üß∞</h2>
<h3 id="jolm">jOlm <a href="https://github.com/brevilo/jolm">‚Üó</a></h3>
<p>Olm bindings for Java</p>
<p><a href="https://matrix.to/#/@brevilo:matrix.org">brevilo</a> announces</p>
<blockquote>
<p><a href="https://github.com/brevilo/jolm">jOlm</a> has seen two releases since the previous update, <a href="https://github.com/brevilo/jolm/releases/tag/1.0.7">v1.0.7</a> and <a href="https://github.com/brevilo/jolm/releases/tag/1.0.8">v1.0.8</a>. jOlm now supports (and requires at least) the latest <code>libolm</code> version 3.2.7. Please note that we deprecated a number of methods in favor of renamed siblings. The majority of the old ones will be removed in the upcoming jOlm 1.1 release, likely published soon after <code>libolm</code>'s <a href="https://matrix.org/blog/2021/12/03/pre-disclosure-upcoming-security-release-of-libolm-and-matrix-js-sdk">announced</a> security release on Dec. 13th. Please follow suit and update your implementations accordingly.</p>
<h2 id="summary">Summary:</h2>
<ul>
<li>üß∞ Maintenance and upstream update releases</li>
<li>‚ö†Ô∏è Renamed methods for improved coherence and due to upstream changes (old ones deprecated)</li>
<li>‚úÖ Up to date with Olm 3.2.7 (new minimum requirement)</li>
</ul>
<h2 id="changelog"><a href="https://github.com/brevilo/jolm/compare/1.0.4...1.0.8">Changelog</a>:</h2>
<ul>
<li>Deprecated methods (see the individual <a href="https://github.com/brevilo/jolm/releases">release notes</a> for full details):
<ul>
<li><code>Account.markOneTimeKeysAsPublished()</code></li>
<li><code>Account.fallbackKey()</code></li>
<li><code>InboundGroupSession.export()</code></li>
<li><code>InboundGroupSession.importer()</code></li>
<li><code>Utility.ed25519_verify()</code></li>
</ul>
</li>
<li>Refined unit tests</li>
<li>Updated dependencies</li>
</ul>
<p>Cheers!</p>
</blockquote>
<h2 id="dept-of-videos-video-camera">Dept of Videos üìπ</h2>
<p><a href="https://matrix.to/#/@matthew:matrix.org">Matthew</a> reports</p>
<blockquote>
<p>We previewed yet more native Matrix VoIP conferencing at CommCon: https://www.youtube.com/watch?v=A4k7DVIK5TE&amp;list=PLvNS4EBAxmJJbvGW-PfXdXOSy9AjHjCLV</p>
</blockquote>
<iframe src="https://www.youtube.com/embed/A4k7DVIK5TE" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<p><a href="https://matrix.to/#/@Half-Shot:half-shot.uk">Half-Shot</a> says</p>
<blockquote>
<p>If you've got room for more video content, I also said more things about bridges. In this one, we do a live code session for a twilio bridge and watch it fly! https://www.youtube.com/watch?v=S5q3FLLvRn4</p>
</blockquote>
<iframe src="https://www.youtube.com/embed/S5q3FLLvRn4" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<h2 id="dept-of-interesting-projects">Dept of Interesting Projects üõ∞Ô∏è</h2>
<p><a href="https://matrix.to/#/@hp:hq.wily.im">Henri</a> says</p>
<blockquote>
<p>Wily Messenger Matrix client</p>
<p>Wily has launched an iOS Matrix client to enable messaging in restricted- or poor networks. mText and Room events are transferred as DNS payload, thus bypassing most captive portals, while message headers are minimized to enable messaging in very low bandwidth/high latency networks.</p>
<p>Wily Messenger is in POC stage, missing i.e. encryption at the moment, among others. We are committed to develop it further and invite a Kotlin developer to join our journey. DM @hp:hq.wily.im</p>
<p>Download: https://apps.apple.com/lv/app/id1576476396</p>
</blockquote>
<h2 id="room-of-the-week-calendar">Room of the Week üìÜ</h2>
<p><a href="https://matrix.to/#/@travis:t2l.io">TravisR</a> says</p>
<blockquote>
<p>We've set up a new Element Space for the Element family of clients and projects, finally. Feel free to join it at <a href="https://matrix.to/#/#community:element.io">#community:element.io</a> and be sure to check out  <a href="https://matrix.to/#/#community:matrix.org">#community:matrix.org</a> while you're there for everything Matrix related. </p>
<p>There's also <a href="https://matrix.to/#/#element-translators:matrix.org">#element-translators:matrix.org</a> for the Element Translators community out there.</p>
</blockquote>
<h2 id="dept-of-ping-table-tennis-paddle-and-ball">Dept of Ping üèì</h2>
<p>Here we reveal, rank, and applaud the homeservers with the lowest ping, as measured by <a href="https://github.com/maubot/echo">pingbot</a>, a <a href="https://github.com/maubot/maubot">maubot</a> that you can host on your own server.</p>
<h3 id="ping-maunium-net"><a href="https://matrix.to/#/#ping:maunium.net">#ping:maunium.net</a></h3>
<p>Join <a href="https://matrix.to/#/#ping:maunium.net">#ping:maunium.net</a> to experience the fun live, and to find out how to add YOUR server to the game.</p>
<table><thead><tr><th style="text-align: center">Rank</th><th style="text-align: center">Hostname</th><th style="text-align: center">Median MS</th></tr></thead><tbody>
<tr><td style="text-align: center">1</td><td style="text-align: center">envs.net</td><td style="text-align: center">494.5</td></tr>
<tr><td style="text-align: center">2</td><td style="text-align: center">nicoll.xyz</td><td style="text-align: center">548</td></tr>
<tr><td style="text-align: center">3</td><td style="text-align: center">matrix.markshorten.co.uk</td><td style="text-align: center">857.5</td></tr>
<tr><td style="text-align: center">4</td><td style="text-align: center">helderferreira.io</td><td style="text-align: center">1373</td></tr>
<tr><td style="text-align: center">5</td><td style="text-align: center">almum.de</td><td style="text-align: center">1886.5</td></tr>
<tr><td style="text-align: center">6</td><td style="text-align: center">diasp.in</td><td style="text-align: center">2958.5</td></tr>
<tr><td style="text-align: center">7</td><td style="text-align: center">matrix.liamgooch.com</td><td style="text-align: center">2982</td></tr>
<tr><td style="text-align: center">8</td><td style="text-align: center">mailstation.de</td><td style="text-align: center">3030.5</td></tr>
<tr><td style="text-align: center">9</td><td style="text-align: center">kde.org</td><td style="text-align: center">3234</td></tr>
<tr><td style="text-align: center">10</td><td style="text-align: center">matrix.org</td><td style="text-align: center">3415</td></tr>
</tbody></table>
<h3 id="ping-no-synapse-maunium-net"><a href="https://matrix.to/#/#ping-no-synapse:maunium.net">#ping-no-synapse:maunium.net</a></h3>
<p>Join <a href="https://matrix.to/#/#ping-no-synapse:maunium.net">#ping-no-synapse:maunium.net</a> to experience the fun live, and to find out how to add YOUR server to the game.</p>
<table><thead><tr><th style="text-align: center">Rank</th><th style="text-align: center">Hostname</th><th style="text-align: center">Median MS</th></tr></thead><tbody>
<tr><td style="text-align: center">1</td><td style="text-align: center">envs.net</td><td style="text-align: center">138.5</td></tr>
<tr><td style="text-align: center">2</td><td style="text-align: center">construct.supercable.onl</td><td style="text-align: center">165</td></tr>
<tr><td style="text-align: center">3</td><td style="text-align: center">weasy-is-my.name</td><td style="text-align: center">317</td></tr>
<tr><td style="text-align: center">4</td><td style="text-align: center">grin.hu</td><td style="text-align: center">403</td></tr>
<tr><td style="text-align: center">5</td><td style="text-align: center">dendrite.supercable.onl</td><td style="text-align: center">531</td></tr>
<tr><td style="text-align: center">6</td><td style="text-align: center">spacedn.com</td><td style="text-align: center">534.5</td></tr>
<tr><td style="text-align: center">7</td><td style="text-align: center">matrix.org</td><td style="text-align: center">828</td></tr>
<tr><td style="text-align: center">8</td><td style="text-align: center">matrix.awesomesheep48.me</td><td style="text-align: center">1084</td></tr>
<tr><td style="text-align: center">9</td><td style="text-align: center">dendrite.s3cr3t.me</td><td style="text-align: center">1103.5</td></tr>
<tr><td style="text-align: center">10</td><td style="text-align: center">0x1a8510f2.space</td><td style="text-align: center">1332</td></tr>
</tbody></table>
<h2 id="the-adventures-of-twim-bot-continued">The Adventures of TWIM bot continued</h2>
<p>The members of the Federation have been very active and helped TWIM bot to find all the pieces of its ship! TWIM bot assembled everything together and put the engine back in its place... but at the last moment, as it was ready to take off, another bright spot appeared on the map following madlittlemods late report!</p>
<p>How could this happen? All the pieces of the engine were already there! Unsure of what to do, the bot asked Earth for directions. Earth confirmed: it was worth going to that new bright spot on the map.</p>
<p>The bot welded back the plate of the engine casing, made sure nothing could get into the ship in its absence, and started heading to the mysterious spot. The signal of our communication tools with TWIM bot weakens as it enters in the thick forest of Fuj'ehr‚Ä¶</p>
<h2 id="that-s-all-i-know-checkered-flag">That's all I know üèÅ</h2>
<p>See you next week, and be sure to stop by <a href="https://matrix.to/#/#twim:matrix.org">#twim:matrix.org</a> with your updates!</p>

        </div>
    </article>
    
    <article class="post">
        <header>
            <h1><a href="&#x2F;blog&#x2F;2021&#x2F;12&#x2F;10&#x2F;type-coverage-for-sydent-annotation&#x2F;" title="Type coverage for Sydent: annotation">Type coverage for Sydent: annotation</a></h1>
            <span>
                10.12.2021 00:00
                ‚Äî
                <a href="/category/tech">
                    Tech
                </a>
                ‚Äî
                <a href="/author/david-robertson">
                    David Robertson
                </a>
            </span>
            
        </header>
        <div>
            <p>This is the second in a series of three posts which discuss recent work to improve type annotations in <a href="https://github.com/matrix-org/sydent">Sydent</a>, the reference Matrix Identity server. <a href="https://matrix.org/blog/2021/12/03/type-coverage-for-sydent-motivation">Last time</a> we discussed the motivation for doing this work in the first place: the <em>why</em>. Now I want to talk about the <em>how</em>. How did we add annotations to individual files, and across the project as whole? What common idioms did we learn on the way?</p>
<h2 id="the-process-of-improving-coverage">The process of improving coverage</h2>
<p>From experience adding typing to Synapse, we decided to annotate one module at a time. We configured a list of files in <code>pyproject.toml</code> which we knew passed mypy's checks. We could run <code>mypy</code> in CI to check that new PRs didn't introduce type problems in modules already covered.</p>
<p>From there, the workflow was</p>
<ol>
<li>Choose a new module to annotate. Add it to the list of <code>files</code> in mypy's configuration.</li>
<li>Run <code>mypy</code>. See how many errors you get.</li>
<li>Choose an error. Fix it. Re-run <code>mypy</code>.</li>
<li>Repeat until no errors remaining.</li>
<li>Submit for review.</li>
</ol>
<p>There are two parts in there which involve a choice. Being honest, I made those choices unscientifically: I tried to choose the easy tasks to do first. My first target was actually the entire <a href="https://github.com/matrix-org/sydent/pull/418">sydent.util</a> subpackage. Probably a bit too large for a first bite! My thinking was that <code>util</code> sounded like something with few dependencies that would have impact across the whole source tree.</p>
<p>Within a given module, I'd try to fix easier errors first: partly for confidence, partly to build up momentum, and partly to get myself familiar with that piece of source code. For example, I'd often start by telling mypy that <code>mylist = []</code> was actually was a <code>List[str]</code> (rather than the generic <code>List[Any]</code> which it would use otherwise).</p>
<p>Picking and choosing easy targets works fairly well, but sometimes that means you end up fixing an error that's really a symptom of an earlier one. Other times fixing one error, e.g. by giving a return type annotation to a function‚Äîwould solve a series of other errors throughout the file. Watching the total number of errors mypy reports bob up and down was intriguing!</p>
<p>In retrospect, I think it would be smoother to generate some kind of dependency graph for the package. I'm imagining a <a href="https://en.wikipedia.org/wiki/Directed_acyclic_graph">DAG</a> where whose vertices are modules, and there's an edge <code>A -&gt; B</code> if <code>A</code> imports from <code>B</code>. The sinks of this DAG (i.e. modules which don't depend on any others in the package) are the ideal place to start: you can get something strictly typechecked there without having to annotate a long chain of dependencies across other files. Another strategy would be to see which modules were the least precise according to mypy's reports‚Äîbut more on those <a href="https://matrix.org/blog/2021/12/17/type-coverage-for-sydent-evaluation">next time</a>.</p>
<h3 id="you-re-at-the-mercy-of-your-dependencies">You're at the mercy of your dependencies</h3>
<p>I think this is my single biggest takeaway from the process of adding annotations to Sydent.
I'll admit the phrasing is melodramatic, but I think it rings true. </p>
<p>Improving coverage boils down to giving the typechecker more information about your program. The more information it has, the more it can check‚Äîand the more errors it can spot. (Hopefully this doesn't make typing come across like a pyramid scheme.) If your dependencies aren't typed, mypy can't validate you're correctly providing inputs and correctly consuming outputs. You might have a bigger impact on overall typing coverage by annotating a dependency (directly or via stubs). I have a hunch that bugs are more likely in code that uses an external dependency: we're much more familiar with the details of our own source code compared to that of a third party we trust.</p>
<p>It's worth looking to see if your dependencies have a newer version including type annotations. Failing that, they may have a stub package added to <a href="https://github.com/python/typeshed/tree/master/stubs">typeshed</a> and published on PyPI. I saw example of both cases when choosing how to configure mypy for Sydent. If some of your dependencies are under your control, consider annotating them‚Äîyou'll feel the benefits across multiple projects pretty quickly.</p>
<h3 id="annotations-when-working-with-twisted">Annotations when working with twisted</h3>
<p>Twisted is Sydent's biggest dependency, and I certainly felt at its mercy! In particular, it has a few quirks which make it trickier to annotate applications using it. Here's a summary of the work we had to do to get those annotations working.</p>
<h4 id="partially-typed-modules-and-stubs">Partially typed modules and stubs</h4>
<p>Early into the process, mypy reported that calling the function <a href="https://twistedmatrix.com/documents/current/api/twisted.python.log.html#err">twisted.python.log.err</a> was an error. It did so because I was running mypy in <a href="https://mypy.readthedocs.io/en/stable/command_line.html#cmdoption-mypy-strict">--strict mode</a>. We'll talk more about why I did so and what this means <a href="https://matrix.org/blog/2021/12/17/type-coverage-for-sydent-evaluation">next time</a>; for now, it's enough to know that calling a function that isn't fully annotated from within a function that is constitutes an error under strict mode. <code>twisted</code> is partially annotated: many key modules and functions have type annotations, but others don't. I was reluctant to give up on <code>--strict</code>. Instead, I decided to stub the <code>err</code> function myself.</p>
<p>A stub is a cut-down version of a python function, class or module which lives in a <code>.pyi</code> file. All implementation details are removed; only type annotations remain. Stubs are useful when you want to write annotations for code you don't control. The <a href="https://github.com/python/typeshed">typeshed</a> library is probably the best example: a collection of third party stubs for the standard library, plus some popular third party packages. Microsoft's <a href="https://github.com/microsoft/python-type-stubs">python-type-stubs</a> is another example. They'd also solve the problem I mentioned at the end of the <a href="https://matrix.org/blog/2021/12/03/type-coverage-for-sydent-motivation">first part</a>: I could use a stub to <em>teach</em> mypy that <code>IResponse.headers</code> was a <code>Headers</code> object. </p>
<p>Writing a stub for <code>log.err</code> was straightforward, thanks mainly to Twisted's thorough documentation. I chose to write it by hand, rather than use <a href="https://mypy.readthedocs.io/en/stable/stubgen.html">stubgen</a>. I'd heard of the latter, but was reluctant to use it for a few reasons.</p>
<ul>
<li>Twisted is a big project with many big files. I didn't want to commit huge stub files for me and my colleagues to maintain.</li>
<li>The more our stubs cover, the larger the risk of a stub becoming out-of-date with twisted itself. Upstream twisted is the best place for these annotations.</li>
<li>We only need annotations for the bits of twisted that we're using.</li>
<li>And, being honest: I wanted the low-level experience of writing stubs, cross-referencing between the source and working how to best capture its type semantics.</li>
</ul>
<p>I think this decision to write a targeted stub made sense at the time. After all, <code>twisted.python.logging.err</code> is just one simple function! But for the project as a whole, I regret not using <code>stubgen</code> to generate module-level stubs. The reason for this is that a <code>.pyi</code> stub file accounts for an entire module: <a href="https://github.com/python/mypy/issues/5880#issuecomment-439237176">no more and no less</a>. This means that the stubs I was writing for parts of twisted only covered the functions and classes I'd stubbed. Any existing annotations in the twisted source code would be ignored, along with any types that mypy was able to infer for itself.</p>
<p>I think it would have been more efficient to use <code>stubgen</code> to generate stubs and patch them up, rather than writing them. That would have helped avoid a few cases I encountered where stubbing one function would cause additional typechecking failures (because mypy was no longer examining the twisted source for that file). It would also have meant that I could just faithfully stub Twisted as it is; in practice, I would sometimes hesitate to stub to avoid having to cover another module. <code>sydent.http</code> was the most painful part of the source tree for this: that's where we make the most use of Twisted.</p>
<h4 id="defer-inlinecallbacks"><a href="https://twistedmatrix.com/documents/current/api/twisted.internet.defer.html#inlineCallbacks">defer.inlineCallbacks</a></h4>
<p>This is a decorator which allows us to write code in the style of <code>async</code>/<code>await</code> without actually using that syntax. (Twisted predates <code>asyncio</code> and the <code>async</code>/<code>await</code> syntax, introduced in Python 3.4 and 3.5 respectively. It was originally released in 2002, back when Python had released version 2.2.) We only use it in <a href="https://github.com/matrix-org/sydent/blob/e4b4dbbdf25255d19effceae7061ad9b3eefc374/sydent/http/matrixfederationagent.py#L125-L132">one place in Sydent</a> nowadays, but I've seen used across Synapse too. I mention it here because it was a bit fiddly to annotate. Here's its use in Sydent:</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span>    @defer.inlineCallbacks
</span><span>    </span><span style="color:#569cd6;">def </span><span>request(
</span><span>        self,
</span><span>        method: bytes,
</span><span>        uri: bytes,
</span><span>        headers: Optional[</span><span style="color:#d69d85;">&quot;Headers&quot;</span><span>] = </span><span style="color:#569cd6;">None</span><span>,
</span><span>        bodyProducer: Optional[</span><span style="color:#d69d85;">&quot;IBodyProducer&quot;</span><span>] = </span><span style="color:#569cd6;">None</span><span>,
</span><span>    ) -&gt; Generator[</span><span style="color:#d69d85;">&quot;defer.Deferred[Any]&quot;</span><span>, Any, IResponse]:
</span></code></pre>
<p>Here, <code>request</code> is a <a href="https://docs.python.org/3/glossary.html#term-generator">generator function</a> because its body uses the <code>yield</code> keyword. Yielding allows the function to relinquish control back to twisted's reactor, only for its execution to be resumed asynchronously in the future. The <a href="https://docs.python.org/3/library/typing.html?highlight=typing%20generator#typing.Generator">Generator</a> type takes three parameters:</p>
<ul>
<li>a <code>YieldType</code>, <code>Deferred[Any]</code>;</li>
<li>a <code>SendType</code>, <code>Any</code>; and</li>
<li>a <code>ReturnType</code>, <code>IResponse</code>.</li>
</ul>
<p>Why have I opted to use <code>Any</code> here, when we've seen (and will see) that this limits mypy's ability to run checks? The answer is that we yield two different types within the function. Firstly a <a href="https://github.com/matrix-org/sydent/blob/e4b4dbbdf25255d19effceae7061ad9b3eefc374/sydent/http/matrixfederationagent.py#L152-L153">routing result</a>:</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span>        routing: _RoutingResult
</span><span>        routing = </span><span style="color:#569cd6;">yield </span><span>defer.ensureDeferred(self._route_matrix_uri(parsed_uri))
</span></code></pre>
<p>and later, <a href="https://github.com/matrix-org/sydent/blob/e4b4dbbdf25255d19effceae7061ad9b3eefc374/sydent/http/matrixfederationagent.py#L194-L195">the IResponse</a> we go on to return:</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span>        res: IResponse
</span><span>        res = </span><span style="color:#569cd6;">yield </span><span>agent.request(method, uri, headers, bodyProducer)
</span></code></pre>
<ul>
<li>
<p>In this example:</p>
</li>
<li>
<p>We yield a value <code>y: Deferred[Any]</code>.</p>
</li>
<li>
<p>That will later be resolved by twisted to an <code>x: Any</code> value. Twisted will send that value to <code>request</code>, and the execution continues.</p>
</li>
<li>
<p>This repeats, until we eventually return an <code>IResponse</code>.</p>
</li>
</ul>
<p>I could more correctly annotate the <code>YieldType</code> as <code>Deferred[Union[_RoutingResult, IResponse]]</code> so that the <code>SendType</code> was <code>Union[_RoutingResult, IResponse]</code>. But this would mean we end up having some kind of type check at each yield point: a <code>cast</code>, or a <code>type: ignore</code>, or a runtime <code>isinstance</code> check. It didn't feel like it was worth the boilerplate, especially since I could narrow e.g. <code>res: Any</code> to <code>res: IResponse</code> with minimal effort.</p>
<p>This problem doesn't arise with using the <code>async/await</code> syntax:</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#569cd6;">async def </span><span>foo() -&gt; int:
</span><span>    </span><span style="color:#569cd6;">return </span><span style="color:#b5cea8;">1
</span><span>
</span><span style="color:#569cd6;">async def </span><span>bar() -&gt; </span><span style="color:#569cd6;">None</span><span>:
</span><span>    x = </span><span style="color:#569cd6;">await </span><span>foo()
</span><span>    reveal_type(foo())
</span><span>    reveal_type(x)
</span></code></pre>
<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>$ mypy example.py
</span><span>example.py:6: note: Revealed type is &quot;typing.Coroutine[Any, Any, builtins.int]&quot;
</span><span>example.py:7: note: Revealed type is &quot;builtins.int*&quot;
</span></code></pre>
<p>Behind the scenes, I <em>think</em> that <code>x = await foo()</code> is really using the same mechanism as the <code>inlineCallbacks</code> approach.</p>
<ul>
<li>An <code>async def</code> function is really a generator function behind the scenes.</li>
<li>When we <code>await foo()</code>, we yield the expression <code>foo()</code></li>
<li>Then the machinery running our coroutine <code>c</code> will call <code>c.send(x)</code> to resume execution, where <code>x</code> is the value produced by waiting for <code>foo()</code>.</li>
</ul>
<p>With the <code>await</code> form, mypy knows two things:</p>
<ul>
<li>the value <code>foo()</code> which was yielded should be <code>Awaitable[T]</code>, and</li>
<li>the value <code>x</code> send to the coroutine should come from awaiting <code>foo()</code>, and therefore be of type <code>T</code>.</li>
</ul>
<p>Mypy can't assume or enforce these rules for the yield form, which can yield and send whatever it likes. There's no reason why the send type should be related to the yield type. Here's a toy example:</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#9b9b9b;">from </span><span>typing </span><span style="color:#9b9b9b;">import </span><span>Any, Dict, Generator
</span><span>
</span><span>
</span><span style="color:#569cd6;">def </span><span>generator_function() -&gt; Generator[int, str, Dict[str, Any]]:
</span><span>  y: int = </span><span style="color:#b5cea8;">10
</span><span>  x: str = </span><span style="color:#569cd6;">yield </span><span>y
</span><span>  print(</span><span style="color:#d69d85;">&quot;Coroutine was sent&quot;</span><span>, x)  </span><span style="color:#608b4e;"># -&gt; Coroutine was sent hello
</span><span>  </span><span style="color:#569cd6;">return </span><span>{</span><span style="color:#d69d85;">&quot;got&quot;</span><span>: x, </span><span style="color:#d69d85;">&quot;done&quot;</span><span>: </span><span style="color:#569cd6;">True</span><span>}
</span><span>
</span><span>coroutine = generator_function()
</span><span>y = next(coroutine)
</span><span>
</span><span style="color:#569cd6;">try</span><span>:
</span><span>  coroutine.send(</span><span style="color:#d69d85;">&quot;hello&quot;</span><span>)
</span><span style="color:#569cd6;">except </span><span>StopIteration </span><span style="color:#569cd6;">as </span><span>e:
</span><span>  return_value = e.value
</span><span>  print(return_value)  </span><span style="color:#608b4e;"># -&gt; {&#39;got&#39;: &#39;hello&#39;, &#39;done&#39;: True}
</span></code></pre>
<p>All in all, the handling of <code>inlineCallbacks</code> is a situation specific to working with (older?) twisted code. It's still nice to understand what's going on behind the scenes though!</p>
<h4 id="zope-interface-interface"><code>zope.interface.Interface</code></h4>
<p>Twisted makes use of <code>zope</code>'s <code>Interface</code> to define a number of abstract interface classes. Speaking personally, I've not seen it used outside twisted, and I think that means it's not supported by much of the typechecking tooling. For example, I've definitely seen PyCharm struggle to realise that it's okay to pass a <code>Response</code> to a function which expects an <code>IResponse</code>! Here's a more complicated example where <code>PyCharm</code> isn't happy with me widening the type <code>LoggingHostnameEndpoint</code> to <code>IStreamClientEndpoint</code>, even though <a href="https://github.com/matrix-org/sydent/blob/92ff7a878a25696365b10cc49e32f5cba32c5960/sydent/http/matrixfederationagent.py#L379-L380">the latter implements the former</a>.</p>
<p><img src="/blog/img/2021-12-10-pycharm-false-positive.png" alt="Screenshot from pycharm showing a false positive warning" /></p>
<p>Mypy out of the box doesn't play well with a zope <code>Interface</code> (nor does any other typechecker I tried). Fortunately, the excellent <a href="https://github.com/Shoobx/mypy-zope">mypy-zope</a> plugin helps here: it teaches mypy that any class like <code>Response</code> which <code>@implements(IResponse)</code>  can be passed in place of an <code>IResponse</code>.</p>
<h3 id="tricks-of-the-trade">Tricks of the trade</h3>
<p>At this point I'd like to share a few generic lessons about typing I'd picked up. Nothing ground-breaking here: I think these are all fairly well-known. Hopefully they're the start of a good cheat sheet for annotating‚Äîthough it pales in comparison to the <a href="https://mypy.readthedocs.io/en/stable/cheat_sheet_py3.html">Mypy cheat sheet</a>.</p>
<h4 id="annotating-decorators">Annotating decorators</h4>
<p>Annotating decorators is fiddly, but it's also vitally important. An unannotated decorator will mask or throw away your decoratee's annotations! The way to write the annotation is best explained by the <a href="https://mypy.readthedocs.io/en/stable/generics.html#declaring-decorators">mypy docs</a>, but briefly: it involves a <code>TypeVar</code> and sometimes a <code>cast</code> too. Here's an example.</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#9b9b9b;">from </span><span>typing </span><span style="color:#9b9b9b;">import </span><span>TypeVar, Callable, Any, cast
</span><span>
</span><span>F = TypeVar(</span><span style="color:#d69d85;">&quot;F&quot;</span><span>, bound=Callable[</span><span style="color:#569cd6;">...</span><span>, Any])
</span><span>
</span><span style="color:#569cd6;">def </span><span>decorator(input: F) -&gt; F:
</span><span>    </span><span style="color:#569cd6;">def </span><span>wrapped(</span><span style="color:#569cd6;">*</span><span>args: Any, </span><span style="color:#569cd6;">**</span><span>kwargs: Any) -&gt; Any:
</span><span>        print(</span><span style="color:#569cd6;">f</span><span style="color:#d69d85;">&quot;Calling </span><span>{f.__name__}</span><span style="color:#d69d85;">&quot;</span><span>)
</span><span>        </span><span style="color:#569cd6;">return </span><span>input_func(*args, </span><span style="color:#569cd6;">**</span><span>kwargs)
</span><span>    </span><span style="color:#569cd6;">return </span><span>cast(F, wrapped)
</span></code></pre>
<p>The idea here is</p>
<ol>
<li>Use <code>Callable[..., Any]</code> to describe a generic function with no particular signature.</li>
<li>Use that as a bound on a type variable <code>F</code>. At each usage of <code>@decorator</code>, mypy will deduce a more specific version of <code>F</code>, e.g. <code>Callable[[int], str]</code>.</li>
<li>Within that usage of <code>@decorator</code>, <code>F</code> is fixed to that specific type. We use <code>-&gt; F</code> to express that &quot;we return a function with the same signature as the decoratee&quot;.</li>
<li>Unfortunately, we don't have a good way to tell <code>mypy</code> that <code>wrapped</code> also has that signature <code>F</code>. We resort to a <code>cast</code> to force mypy to accept this without proof.</li>
</ol>
<p>This might change in the future, e.g. when <a href="https://docs.python.org/3/library/typing.html?highlight=paramspec#typing.ParamSpec">ParamSpec</a> is <a href="https://github.com/python/mypy/issues/8645">fully understood</a> by mypy.</p>
<h4 id="prefer-object-over-any">Prefer <code>object</code> over <code>Any</code></h4>
<p>Both of these are general types for expressing &quot;I don't know anything about this expression&quot;. But only the former will undergo static type checks. We want those type checks to guard against bugs accidentally introduced in the future. For instance, imagine a class with an <code>Any</code> attribute.</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#9b9b9b;">from </span><span>typing </span><span style="color:#9b9b9b;">import </span><span>Any
</span><span style="color:#9b9b9b;">import </span><span>dataclasses
</span><span>
</span><span>@dataclasses.dataclass
</span><span style="color:#569cd6;">class </span><span>C:
</span><span>    label: Any
</span></code></pre>
<p>Imagine in the future we add a new method which assumes that <code>label</code> is a string:</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span>    </span><span style="color:#569cd6;">def </span><span>greeting(self) -&gt; str:
</span><span>        </span><span style="color:#569cd6;">return </span><span style="color:#d69d85;">&quot;My name is &quot; </span><span>+ self.label
</span></code></pre>
<p>Mypy will consider this valid, because no type-checking is done on an <code>Any</code> value. It will complain that it can't prove that <code>greeting</code> returns a <code>str</code>, if <code>--warn-return-any</code> is enabled; but putting that aside, it can't identify the call site as a bug. The bug slips through to runtime.</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span>C(</span><span style="color:#b5cea8;">123</span><span>).greeting()  </span><span style="color:#608b4e;"># TypeError: can only concatenate str (not &quot;int&quot;) to str
</span></code></pre>
<p>Replacing the <code>Any</code> with <code>object</code> does allow mypy to spot the problem.</p>
<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>error: Unsupported operand types for + (&quot;str&quot; and &quot;object&quot;)  [operator]
</span></code></pre>
<h4 id="type-ignore-and-cast-sparingly"><code># type: ignore</code> and <code>cast</code> sparingly</h4>
<p>There's a good chance that mypy knows better than we do, so we should only overrule it if there's no better option. There are two techniques for this. One option is to tell mypy to just silence the error, by appending a <code># type: ignore</code> comment to the erroneous line. The other is to force it to accept that a certain expression has a given type: that's what <a href="https://docs.python.org/3/library/typing.html?highlight=paramspec#typing.cast">cast</a> is for.</p>
<p>I never like using either of these, but sometimes they're the most practical choice. I'd recommend two best practices for their use, however:</p>
<ol>
<li>Only ignore a specific error code, e.g. <code># type: ignore[assignment]</code>.  Those codes can be displayed by passing <code>--show-error-codes</code> to mypy.</li>
<li>Leave a comment before every <code>#type: ignore[...]</code> and every <code>cast</code> to justify their correctness. I don't think this is a widely-held practice. I picked it up from the Rust world, where it's <a href="https://rust-lang.github.io/api-guidelines/documentation.html#function-docs-include-error-panic-and-safety-considerations-c-failure">encouraged</a> as a way to justify <code>unsafe</code> source code.</li>
</ol>
<h4 id="there-s-good-stuff-in-typing">There's good stuff in <code>typing</code></h4>
<p>It's worth a read through the <a href="https://docs.python.org/3/library/typing.html">module documentation</a>‚Äîplenty of things in there I wish I'd known about sooner. There's lots in the toolkit to chose from. Some bits I use fairly often include:</p>
<ul>
<li><a href="https://docs.python.org/3/library/typing.html?highlight=typing%20protocol#typing.Protocol">Protocol</a>: lets you formalise duck typing. To use it, define a class that inherits from <code>Protocol</code>. Its methods and attributes are all stubs which describe what you require of objects belonging to this type. It's like an <a href="https://docs.python.org/3/library/abc.html?highlight=abc#module-abc">abstract base class</a> or interface, but purely at typecheck time.</li>
<li><a href="https://docs.python.org/3/library/typing.html?highlight=typing%20generic#typing.Generic">Generic</a>: define your own generic types. A bit of a slippery slope to type mania!</li>
<li>[Optional<code>](https://docs.python.org/3/library/typing.html?highlight=typing%20generic#typing.Optional): I use this all the time. It's always good to make your </code>None`s explicit!</li>
<li><a href="https://docs.python.org/3/library/typing.html?highlight=typing%20generic#typing.NewType">NewType</a>: I haven't had a chance to use it much. As I understand it, it's a way to define a &quot;strong typedef&quot;. For example, we can use it to distinguish lengths from durations, even if they're both represented by a <code>float</code> at runtime.</li>
</ul>
<p>I want to call out two parts of <code>typing</code> in particular:</p>
<h4 id="overload"><a href="https://docs.python.org/3/library/typing.html?highlight=typing%20generic#typing.overload">overload</a></h4>
<p><code>overload</code> is a way to provide extra information about a function depending on how it's called. For instance, consider this function which takes a <code>str</code> or <code>bytes</code> as input and returns its uppercase version.</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#569cd6;">def </span><span>upper(x: Union[bytes, str]) -&gt; Union[bytes, str]:
</span><span>    </span><span style="color:#569cd6;">return </span><span>x.upper()
</span></code></pre>
<p>The problem with this annotation is that we'll have to check at every call site to see if the return value was a <code>bytes</code> or a <code>str</code> object. But we know that uppercasing a <code>str</code> gives us a <code>str</code>, and uppercasing a <code>bytes</code> gives us a <code>bytes.</code> We can use <code>overload</code> to express this.</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#9b9b9b;">from </span><span>typing </span><span style="color:#9b9b9b;">import </span><span>overload
</span><span>
</span><span>@overload
</span><span style="color:#569cd6;">def </span><span>upper(x: str) -&gt; str: </span><span style="color:#569cd6;">...
</span><span>
</span><span>@overload
</span><span style="color:#569cd6;">def </span><span>upper(x: bytes) -&gt; bytes: </span><span style="color:#569cd6;">...
</span><span>
</span><span style="color:#569cd6;">def </span><span>upper(x: Union[bytes, str]) -&gt; Union[bytes, str]:
</span><span>    </span><span style="color:#569cd6;">return </span><span>x.upper()
</span></code></pre>
<p>The first two <code>@overload</code> definitions are like stubs: they're purely used for their annotations. The actual runtime implementation is specified at the end, undecorated. (<strong>NB</strong>: this specific example is better expressed without overloads, by using <a href="https://docs.python.org/3/library/typing.html?highlight=typing%20generic#typing.AnyStr">AnyStr</a>.)</p>
<p>I was really impressed to see how <code>mypy</code> could use this overloading information. Here's an example:</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#9b9b9b;">from </span><span>typing </span><span style="color:#9b9b9b;">import </span><span>overload, Literal
</span><span>
</span><span>@overload
</span><span style="color:#569cd6;">def </span><span>f(x: int) -&gt; Literal[</span><span style="color:#b5cea8;">1</span><span>]: </span><span style="color:#569cd6;">...
</span><span>
</span><span>@overload
</span><span style="color:#569cd6;">def </span><span>f(x: str) -&gt; Literal[</span><span style="color:#b5cea8;">2</span><span>]: </span><span style="color:#569cd6;">...
</span><span>
</span><span style="color:#569cd6;">def </span><span>f(x: object) -&gt; int:
</span><span>    </span><span style="color:#569cd6;">if </span><span>isinstance(x, int):
</span><span>        </span><span style="color:#569cd6;">return </span><span style="color:#b5cea8;">1
</span><span>    </span><span style="color:#569cd6;">elif </span><span>isinstance(x, str):
</span><span>        </span><span style="color:#569cd6;">return </span><span style="color:#b5cea8;">2
</span><span>    </span><span style="color:#569cd6;">return </span><span style="color:#b5cea8;">3
</span><span>
</span><span style="color:#569cd6;">if </span><span>f(</span><span style="color:#b5cea8;">10</span><span>) == </span><span style="color:#b5cea8;">2</span><span>:
</span><span>    print(</span><span style="color:#d69d85;">&quot;potato&quot;</span><span>)
</span></code></pre>
<p>We can see that <code>f(10) == 1</code> and so the equality is always <code>False</code>: we'll never print the word &quot;potato&quot;. Mypy can reason through this too, if we ask it nicely.</p>
<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>$ mypy example.py
</span><span>Success: no issues found in 1 source file
</span><span>
</span><span>$ mypy --strict-equality --warn-unreachable example.py
</span><span>example.py:16: error: Non-overlapping equality check (left operand type: &quot;Literal[1]&quot;, right operand type: &quot;Literal[2]&quot;)
</span><span>example.py:17: error: Statement is unreachable
</span><span>Found 2 errors in 1 file (checked 1 source file)
</span></code></pre>
<h4 id="typeddict"><a href="https://docs.python.org/3/library/typing.html?highlight=typeddict#typing.TypedDict">TypedDict</a></h4>
<p>I mentioned this <a href="https://matrix.org/blog/2021/12/03/type-coverage-for-sydent-motivation">in last week's post</a>) when talking about the missing <code>await</code> bug.
Subclassing from <code>TypedDict</code> allows us to define a new type whose values are dictionaries with</p>
<ul>
<li>a fixed set of keys (some mandatory, some not), and</li>
<li>a fixed type for each key's value.</li>
</ul>
<p><a href="https://www.python.org/dev/peps/pep-0589/">PEP 589</a> can best describe the motivation, but in short: there's a lot of source code out there that passes dictionaries around. <code>TypedDict</code> is a way to gradually add typechecking to that code, without having to refactor it to use e.g. a <a href="https://docs.python.org/3/library/dataclasses.html">dataclass</a> or a <a href="https://docs.python.org/3/library/typing.html#typing.NamedTuple">NamedTuple</a>. Let's have a quick example.</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#9b9b9b;">from </span><span>typing </span><span style="color:#9b9b9b;">import </span><span>List, TypedDict
</span><span>
</span><span style="color:#569cd6;">class </span><span>Person(</span><span style="color:#4ec9b0;">TypedDict</span><span>):
</span><span>    full_name: str
</span><span>    nicknames: List[str]
</span><span>    age: int
</span><span>
</span><span>p: Person = {
</span><span>    </span><span style="color:#d69d85;">&quot;full_name&quot;</span><span>: </span><span style="color:#d69d85;">&quot;David Matthew Robertson&quot;</span><span>,
</span><span>    </span><span style="color:#d69d85;">&quot;nicknames&quot;</span><span>: [</span><span style="color:#d69d85;">&quot;dmr&quot;</span><span>],
</span><span>    </span><span style="color:#d69d85;">&quot;age&quot;</span><span>: </span><span style="color:#b5cea8;">29</span><span>,
</span><span>}
</span></code></pre>
<p>Mypy will detect if you delete or omit a required key, or if you insert a key that's not part of the type.</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#608b4e;"># error: Key &quot;age&quot; of TypedDict &quot;Person&quot; cannot be deleted
</span><span style="color:#569cd6;">del </span><span>p[</span><span style="color:#d69d85;">&quot;age&quot;</span><span>]
</span><span>
</span><span style="color:#608b4e;"># error: Missing keys (&quot;full_name&quot;, &quot;nicknames&quot;, &quot;age&quot;) for TypedDict &quot;Person&quot;
</span><span>p2: Person = {}
</span><span>
</span><span style="color:#608b4e;"># error: TypedDict &quot;Person&quot; has no key &quot;eye_colour&quot;
</span><span>p[</span><span style="color:#d69d85;">&quot;eye_colour&quot;</span><span>] = </span><span style="color:#d69d85;">&quot;brown&quot;
</span></code></pre>
<p><code>TypedDict</code> is a useful tool, but there are a few important gotchas to be aware of. In my view, these are all minor and worth putting up with, to benefit from the extra type information that a <code>TypedDict</code> provides. Let's take a look.</p>
<h5 id="typeddict-is-incompatible-with-dict"><code>TypedDict</code> is incompatible with <code>Dict</code></h5>
<p>This one surprised me at first. Why can't I pass my <code>TypedDict</code> to a function that accepts a generic dictionary?</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#9b9b9b;">import </span><span>json
</span><span style="color:#9b9b9b;">from </span><span>typing </span><span style="color:#9b9b9b;">import </span><span>Dict, TypedDict
</span><span>
</span><span style="color:#569cd6;">class </span><span>Foo(</span><span style="color:#4ec9b0;">TypedDict</span><span>):
</span><span>    bar: str
</span><span>
</span><span style="color:#569cd6;">def </span><span>print_size(d: Dict[object, object]) -&gt; </span><span style="color:#569cd6;">None</span><span>:
</span><span>    print(len(d))
</span><span>
</span><span>f: Foo = {</span><span style="color:#d69d85;">&quot;bar&quot;</span><span>: </span><span style="color:#d69d85;">&quot;baz&quot;</span><span>}
</span><span style="color:#608b4e;"># error: Argument 1 to &quot;print_size&quot; has incompatible type &quot;Foo&quot;; expected &quot;Dict[object, object]&quot;
</span><span>print_size(f)
</span></code></pre>
<p>The answer is that it wouldn't be type-safe! For all we know, the function <code>print_size</code> might mutate its argument <code>d</code>. It might add a key, remove a key, or change the type of a value. Each of those would break the contract that <code>TypedDict</code> is supposed to enforce, so mypy is correct to flag this as an error. <a href="https://github.com/python/mypy/issues/4976">This GitHub issue</a> has more discussion.</p>
<p>There are few workarounds for this kind of problem.</p>
<ul>
<li>The function might be able to accept a <code>TypedDict</code> directly.</li>
<li>The function could accept a <code>Mapping</code> instead of a <code>Dict</code>. This is type-safe because the <code>Mapping</code> type does not offer mutating methods such as <code>pop</code>, <code>__setitem__</code>, <code>__del__</code>; but it only works if the function does not mutate the dictionary.</li>
<li>A more drastic approach would discard the <code>TypedDict</code> information with a <code>cast</code> to <code>Dict[str, object]</code> or similar. If so, I'd strongly recommend a comment explaining why the cast is correct and safe.</li>
</ul>
<h5 id="mixing-mandatory-and-required-fields">Mixing mandatory and required fields</h5>
<p>Secondly, defining a <code>TypedDict</code> with a mixture of optional and required keys is a little fiddly. All keys can be made optional by passing <code>total=False</code> in the class definition. To have some keys optional and others mandatory, we have to make <em>two</em> TypedDicts. Say for instance we wanted to allow a potentially-missing <code>favourite_colour</code> field to <code>Person</code>. We can't add an annotation <code>favourite_colour: Optional[str]</code> to the first class body. That's optional in a different sense: it would mean that <code>favourite_colour</code> is a mandatory field which is allowed to be <code>None</code>. Instead, we apply <code>total=False</code> to a subclass:</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#9b9b9b;">from </span><span>typing </span><span style="color:#9b9b9b;">import </span><span>List, TypedDict
</span><span>
</span><span style="color:#569cd6;">class </span><span>_PersonRequired(</span><span style="color:#4ec9b0;">TypedDict</span><span>):
</span><span>    full_name: str
</span><span>    nicknames: List[str]
</span><span>    age: int
</span><span>
</span><span style="color:#569cd6;">class </span><span>Person(</span><span style="color:#4ec9b0;">_PersonRequired</span><span>, total=</span><span style="color:#4ec9b0;">False</span><span>):
</span><span>    favourite_colour: str
</span></code></pre>
<p>This means that a valid <code>Person</code> dictionary may have no <code>favourite_colour</code> key. If it is present, it must be a <code>str</code>.</p>
<p>The syntax is unfortunately a little clunky. <a href="https://www.python.org/dev/peps/pep-0655/">PEP 655</a> acknowledges this and proposes an alternative.</p>
<h5 id="typeddict-is-typecheck-time-only"><code>TypedDict</code> is typecheck-time only</h5>
<p>One final note: a <code>TypedDict</code> does no validation or conversion whatsoever. If mypy can't know the keys and values a dictionary will have a typecheck-time, you'll need to validate it by hand at runtime. We see this a lot because when deserialising json objects into a dictionary. Here's an example.</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#9b9b9b;">import </span><span>json
</span><span style="color:#9b9b9b;">from </span><span>typing </span><span style="color:#9b9b9b;">import </span><span>TypedDict
</span><span>
</span><span style="color:#569cd6;">class </span><span>Foo(</span><span style="color:#4ec9b0;">TypedDict</span><span>):
</span><span>    bar: str
</span><span>
</span><span style="color:#608b4e;"># note: Revealed type is &quot;Any&quot;
</span><span>reveal_type(json.loads(</span><span style="color:#d69d85;">&quot;</span><span style="color:#b4cea8;">{}</span><span style="color:#d69d85;">&quot;</span><span>))
</span><span style="color:#608b4e;"># no error. mypy can&#39;t do analysis on Any.
</span><span>f: Foo = json.loads(</span><span style="color:#d69d85;">&quot;</span><span style="color:#b4cea8;">{}</span><span style="color:#d69d85;">&quot;</span><span>)
</span></code></pre>
<h2 id="next-time">Next time</h2>
<p>This covers a lot of the machinery and the day-to-day process of annotating Sydent. The <a href="https://matrix.org/blog/2021/12/17/type-coverage-for-sydent-evaluation">last part of this series</a> will give us a chance to quantify our efforts and reflect on the wider typing ecosystem.</p>
<hr />
<p>Many thanks for reading! If you've got any corrections, comments or queries, I'm available on Matrix at <a href="https://matrix.to/#/@dmrobertson:matrix.org">@dmrobertson:matrix.org</a>.</p>

        </div>
    </article>
    
    <article class="post">
        <header>
            <h1><a href="&#x2F;blog&#x2F;2021&#x2F;12&#x2F;03&#x2F;pre-disclosure-upcoming-security-release-of-libolm-and-matrix-js-sdk&#x2F;" title="Pre-disclosure: upcoming security release of libolm and matrix-js-sdk">Pre-disclosure: upcoming security release of libolm and matrix-js-sdk</a></h1>
            <span>
                03.12.2021 00:00
                ‚Äî
                <a href="/category/security">
                    Security
                </a>
                ‚Äî
                <a href="/author/matrix-security">
                    Matrix Security
                </a>
            </span>
            
        </header>
        <div>
            <p>On <strong>Monday, 13th December</strong> we plan to publish a security release of libolm at 15:00 UTC to address a single high severity issue. To the best of our knowledge, only matrix-js-sdk and clients relying on it for E2EE are affected by this issue. This includes Element Web/Desktop and their forks (like SchildiChat). The release of libolm will be immediately followed by a security release of matrix-js-sdk and the affected clients. Users of these clients are encouraged to <strong>upgrade as soon as the patched versions are released</strong>.</p>
<p>We will be reaching out to downstream packagers to ensure they can prepare patched versions of the affected packages at the time of the release. The details of the vulnerability will be disclosed in a blog post on the day of the release. There is so far no evidence of the vulnerability being exploited in the wild.</p>
<p>The patched version numbers will be as follows:</p>
<ul>
<li>libolm 3.2.8</li>
<li>matrix-js-sdk 15.2.1</li>
<li>Element Web/Desktop 1.9.7</li>
</ul>
<p>Thank you for your patience while we work to resolve this issue.</p>
<p><em>Edit, 2021-12-13: Added patched release numbers.</em></p>

        </div>
    </article>
    
    <article class="post">
        <header>
            <h1><a href="&#x2F;blog&#x2F;2021&#x2F;12&#x2F;03&#x2F;this-week-in-matrix-2021-12-03&#x2F;" title="This Week in Matrix 2021-12-03">This Week in Matrix 2021-12-03</a></h1>
            <span>
                03.12.2021 00:00
                ‚Äî
                <a href="/category/this-week-in-matrix">
                    This Week in Matrix
                </a>
                ‚Äî
                <a href="/author/thib">
                    Thib
                </a>
            </span>
            
        </header>
        <div>
            <h2 id="the-adventures-of-twim-bot">The Adventures of TWIM bot</h2>
<p>One thing you might not know is that TWIM bot is a space traveler, sent by the Matrix scientists to explore that zone called &quot;The Possibilities&quot;. The <a href="https://matrix.to/#/#twim:matrix.org">#twim:matrix.org</a> room is a portal to its energy tank, and we had received a distress signal!</p>
<p>To help the TWIM explorer fulfil its mission, we asked the Matrix community to fuel it with news before it crashed into space debris made of aggregated ignorance!</p>
<p>This week again, the community has been very active and explored many possibilities of the Matrix universe!</p>
<h2 id="matrix-live">Matrix Live üéô</h2>
<iframe src="https://www.youtube.com/embed/RHaXIHiRlHQ" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<p>For this week's Matrix Live my guest is Amandine and we're discussing how Element and 50 other organisations are trying to shape the future of EU's law for more interoperability. Bonus point: we have a double bridge demo with Matrix, Slack and Telegram!</p>
<h2 id="dept-of-status-of-matrix-face-with-th">Dept of <em>Status of Matrix</em> üå°Ô∏è</h2>
<h3 id="fosdem">FOSDEM!</h3>
<p>This year, the Matrix.org Foundation is excited to host the first ever Matrix.org Foundation and Community devroom at FOSDEM. A full day of talks, demos and workshops around Matrix itself and projects built on top of Matrix. <a href="https://matrix.org/blog/2021/12/02/call-for-participation-for-the-fosdem-2022-matrix-dev-room">Read (and answer to) our Call for Partipactions</a>!</p>
<h3 id="finnish-admins-to-the-rescue">Finnish Admins to the Rescue</h3>
<p><a href="https://matrix.to/#/@cos:hacklab.fi">cos</a> says</p>
<blockquote>
<p>A group of Finnish Matrix admins have set up a free homeserver for Finnish public called pikaviestin.fi (literally instant messenger dot fi). It offers a bunch of bridges and registration requires an e-mail address in one of Finnish e-mail providers or organizations. We welcome all Finns to register there and help decentralize Matrix. Support room can be found at <a href="https://matrix.to/#/#aula:pikaviestin.fi">#aula:pikaviestin.fi</a></p>
</blockquote>
<p>That's a fantastic initiative! Kudos to all the sysadmins involved!</p>
<h2 id="dept-of-spec-scroll">Dept of Spec üìú</h2>
<p><a href="https://matrix.to/#/@andrewm:amorgan.xyz">anoa</a> reports</p>
<blockquote>
<p>Here's your weekly spec update! The heart of Matrix is the specification - and this is modified by Matrix Spec Change (MSC) proposals. Learn more about how the process works at https://spec.matrix.org/unstable/proposals.</p>
<h2 id="msc-status">MSC Status</h2>
<p><strong>New MSCs:</strong></p>
<ul>
<li><a href="https://github.com/matrix-org/matrix-doc/pull/3531">MSC3531: Letting moderators hide messages</a></li>
</ul>
<p><strong>MSCs with proposed Final Comment Period:</strong></p>
<ul>
<li><em>No MSCs entered proposed FCP state this week.</em></li>
</ul>
<p><strong>MSCs in Final Comment Period:</strong></p>
<ul>
<li><a href="https://github.com/matrix-org/matrix-doc/pull/3419">MSC3419: Allow guests to send more event types</a></li>
</ul>
<p><strong>Merged MSCs:</strong></p>
<ul>
<li><em>No MSCs were merged this week.</em></li>
</ul>
<h2 id="spec-updates">Spec Updates</h2>
<p>The end of the year is drawing to a close. Thus many of the Spec Core Team members are focusing on implementation in order to meet deadlines. Review is still occurring though! As above, we have <a href="https://github.com/matrix-org/matrix-doc/pull/3419">MSC3419</a> (allow guests to send more event types). This was born out of next-generation VoIP work, but it should have a positive impact on improving the guest experience in Matrix on the whole.</p>
<p>Otherwise work is still ongoing by Bruno and others on untangling the aggregations MSCs, specifically <a href="https://github.com/matrix-org/matrix-doc/pull/2675">MSC2675</a> and <a href="https://github.com/matrix-org/matrix-doc/pull/2676">MSC2676</a>.</p>
<p>And finally, Alexandre Franke has <a href="https://github.com/matrix-org/matrix-doc/pull/3542">PR'd some work</a> to allow for matrix.org's OpenAPI spec to be widely available, meaning anyone with a <a href="https://swagger.io/">Swagger</a> (or other <a href="https://www.openapis.org/">OpenAPI</a> viewer) client can easily pull it and start sending requests against a Matrix homeserver. Fun times!</p>
<h2 id="random-msc-of-the-week">Random MSC of the Week</h2>
<p>The random spec of the week is... <a href="https://github.com/matrix-org/matrix-doc/pull/3419">MSC3419: Allow guests to send more event types</a>.</p>
<p>Random numbers, ladies and gentleman.
<img src="/blog/img/66e13adad362e10cb349489f05f02756fd1f3319.png" alt="" /></p>
</blockquote>
<h2 id="dept-of-servers-europea">Dept of Servers üè¢</h2>
<h3 id="synapse">Synapse <a href="https://github.com/matrix-org/synapse/">‚Üó</a></h3>
<p>Synapse is the reference homeserver for Matrix</p>
<p><a href="https://matrix.to/#/@callahad:matrix.org">callahad</a> says</p>
<blockquote>
<p>Goooood evening TWIM readers!</p>
<p>I want to start by drawing attention to a blog post which we published today: <a href="https://matrix.org/blog/2021/12/03/type-coverage-for-sydent-motivation">Type coverage for Sydent: motivation</a>. This the first in a series of three articles discussing what we've learned from making Sydent pass the <a href="https://mypy.readthedocs.io/">mypy</a> type checker in strict mode. Improving type coverage across Synapse, Sygnal, and Sydent has been a major focus of the backend team at Element for the past few months, and we think we've learned a few useful things in the process.</p>
<p>This week we also <a href="https://matrix.org/blog/2021/11/30/synapse-1-48-0-released">released Synapse 1.48</a> with loads of internal improvements, new Admin APIs, better alignment with the Matrix 1.1 spec, and more. We're planning one more release for the year, 1.49 on December 14th, and then we're taking a break until Synapse 1.50 on January 11th.</p>
<p>Importantly: Synapse 1.49 will be the last release to support Python 3.6, PostrgreSQL 9.6, and Ubuntu 18.04 LTS (Bionic) ‚Äî if you're reliant on any of these platforms, please ensure you have plans to upgrade.</p>
<p>Let us know what you think of the article (and the Synapse release!), and we'll see you next week!</p>
</blockquote>
<h3 id="sydent">Sydent <a href="https://github.com/matrix-org/sydent">‚Üó</a></h3>
<p>Sydent is the reference Matrix Identity server. It provides a lookup service, so that you can find a Matrix user via their email address or phone number (if they have chosen to share it).</p>
<p><a href="https://matrix.to/#/@dmrobertson:matrix.org">dmr</a> reports</p>
<blockquote>
<p>I've just published a <a href="https://matrix.org/blog/2021/12/03/type-coverage-for-sydent-motivation">blog post</a> (part one of three) about our efforts to improve Sydent's type coverage. It should hopefully be of interest to anyone who works with Python or is interested in static analysis more generally.</p>
</blockquote>
<h3 id="gitter">Gitter</h3>
<p><a href="https://matrix.to/#/@madlittlemods:matrix.org">madlittlemods (Eric Eastwood)</a> reports</p>
<blockquote>
<p>In the vein of <a href="https://github.com/vector-im/roadmap/issues/26">Gitter feature parity</a> on Matrix, we've made the first steps towards a better public static archive. We merged an experimental implementation of <a href="https://github.com/matrix-org/matrix-doc/pull/3030">MSC3030</a> into <a href="https://github.com/matrix-org/synapse">Synapse</a> which lets you use the unstable <code>/timestamp_to_event</code> client API endpoint go from a given timestamp to the closest event ID. This will allow us to implement a calendar jump to date interface to be able to navigate to any day in the rooms history. Our first target to add the jump to date UI in is <a href="https://github.com/vector-im/hydrogen-web">Hydrogen</a> since we plan to server-side render Hydrogen for the actual public static archive as well.</p>
<p>To enable the <a href="https://github.com/matrix-org/matrix-doc/pull/3030">MSC3030</a> unstable API endpoints in Synapse, add <code>experimental_features</code> -&gt; <code>msc3030_enabled: true</code> to your <code>homeserver.yaml</code>:</p>
<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>GET /_matrix/client/unstable/org.matrix.msc3030/rooms/&lt;roomID&gt;/timestamp_to_event?ts=&lt;timestamp&gt;&amp;dir=&lt;direction&gt;
</span><span>{
</span><span>    &quot;event_id&quot;: ...
</span><span>    &quot;origin_server_ts&quot;: ...
</span><span>}
</span></code></pre>
<p>Also as part of <a href="https://github.com/matrix-org/matrix-doc/pull/3030">MSC3030</a>, when you use the client API endpoint, if your homeserver sees that the closest event it has locally in the database is next to a gap in the history, it will go out and ask other federated homeservers what they have as the closest event instead.</p>
<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>GET /_matrix/federation/unstable/org.matrix.msc3030/timestamp_to_event/&lt;roomID&gt;?ts=&lt;timestamp&gt;&amp;dir=&lt;direction&gt;
</span><span>{
</span><span>    &quot;event_id&quot;: ...
</span><span>    &quot;origin_server_ts&quot;: ...
</span><span>}
</span></code></pre>
<p>*--</p>
<p><a href="https://github.com/matrix-org/matrix-doc/pull/2716">MSC2716</a> to import batches of historical messages is still marching along getting some polishing passes and strengthening the assertions in the Complement tests to make sure things are going absolutely correctly. It's also good to see <a href="https://www.beeper.com/">Beeper</a> utilizing it and catching a <a href="https://github.com/matrix-org/synapse/issues/11241">few</a> <a href="https://github.com/matrix-org/synapse/issues/11219">bugs</a> along the way üí™.</p>
</blockquote>
<h2 id="dept-of-bridges-bridge-at-night">Dept of Bridges üåâ</h2>
<h3 id="hookshot">Hookshot</h3>
<p>Half-Shot reports very late, to the great despair of TWIM's editor:</p>
<blockquote>
<h3 id="hookshot-gets-provisioning">Hookshot gets provisioning!</h3>
<p>Stop the press. This is a last minute TWIM. We've been beavering away on <a href="https://github.com/Half-Shot/matrix-hookshot">matrix-hookshot</a>. It's gained many features in the last week, but the big thing is that hookshot has gained the ability to provision connections over a provisioning API, which means it should hook nicely into Dimension (and other integration managers, in the future)!</p>
<p>Other notable features are:</p>
<ul>
<li>Support for multiple webhooks per room</li>
<li>Support for the username/text fields on an incoming webhook (slack style)</li>
<li>Named webhooks, so each hook now has a sensible displayname</li>
<li>The ability to spawn GitHub actions from rooms using the <code>!gh workflow run</code> command</li>
<li>Lots of new supported events from GitLab, such as reviews and tag pushes</li>
<li>Hosted documentation (so all of the above is easy to setup), it's a bit in progress atm.</li>
</ul>
<p>We're aiming for a release very very soon, hopefully in the next week or so!
<img src="/blog/img/hookshot_1.png" alt="" />
<img src="/blog/img/hookshot_2.png" alt="" /></p>
</blockquote>
<h2 id="homeserver-deployment-inbox-tray">Homeserver Deployment üì•Ô∏è</h2>
<h3 id="helm-chart">Helm Chart <a href="https://gitlab.com/ananace/charts">‚Üó</a></h3>
<p>Matrix Kubernetes applications packaged into helm charts</p>
<p><a href="https://matrix.to/#/@ace:kittenface.studio">Ananace</a> says</p>
<blockquote>
<p>And this week, as a complete and utter surprise, <a href="https://gitlab.com/ananace/charts">my Helm Charts</a> got updates; with matrix-synapse updated to 1.48.0</p>
</blockquote>
<h2 id="dept-of-clients-iphone">Dept of Clients üì±</h2>
<h3 id="schildichat">SchildiChat <a href="https://schildi.chat">‚Üó</a></h3>
<p>SchildiChat is a fork of Element that focuses on UI changes such as message bubbles and a unified chat list for both direct messages and groups, which is a more familiar approach to users of other popular instant messengers.</p>
<p><a href="https://matrix.to/#/@qg:supercable.onl">qg</a> announces</p>
<blockquote>
<p>In a new release being published just now we added the possibility to mark rooms as unread also on Web/Desktop (using <a href="https://github.com/matrix-org/matrix-doc/pull/2867">MSC2867</a>, huge thanks to @alangecker for his PR on Element Web!).
This has already been implemented in SchildiChat-Android and is now enabled on both by default.</p>
</blockquote>
<h3 id="nheko">Nheko <a href="https://nheko-reborn.github.io">‚Üó</a></h3>
<p>Desktop client for Matrix using Qt and C++17.</p>
<p><a href="https://matrix.to/#/@deepbluev7:neko.dev">Nico</a> says</p>
<blockquote>
<p>We finally figured out what caused the issues with the flatpak on GNOME, especially on Arm. It should now work properly, if you use Flathub. On the Pinephone (and other systems, that don't set a locale/use the C locale), timestamps should now not be needlessly long anymore. Redactions got a face-lift to distinguish them better from normal messages. We added a workaround for Synapse not allowing you to leave a banned room. We now delete the room from the room list permanently if Synapse returns &quot;unknown room&quot; when trying to leave it. Spaces can now show the entire hierarchy in the sidebar (if you pull it out) and you can navigate to subspaces by clicking on them in the roomlist, even if you collapsed the space hierarchy in the sidebar.</p>
<p>That's all, now let me bake some cookies! üç™</p>
</blockquote>
<h3 id="fluffychat">FluffyChat <a href="https://fluffychat.im">‚Üó</a></h3>
<p><a href="https://matrix.to/#/@krille:janian.de">Krille Fear</a> says</p>
<blockquote>
<p>Today we have released FluffyChat 1.0.0 with a whole new design, a lot of bug fixes and huge performance improvements.</p>
<h3 id="new-design">New design</h3>
<p>The new design has bigger message bubbles with fancy shadows and bigger fonts. The contrast has been improved and some elements, like the time on every single message bubble, are now hidden by default. But they are not gone! Detailed message information are now accessible in the new message info page, where we not also can see the message type and the timestamp, but also the whole JSON source code of each timeline event.</p>
<h3 id="spaces">Spaces</h3>
<p>Spaces have got a lot improvements and bug fixes. They have moved to the bottom bar of the chat list (while this bottom bar is still hidden if you have not joined any space yet). The multi account switcher have instead been moved to a top left drop-down menu. So we finally got rid of the drawer, which seems to be a deprecated material design feature anyway. This new UX makes spaces much easier to use. You can long press on them to go to the space settings and long press on any chat in the chat list, to add or remove a chat to (or from) a space.
We still have no support for the spaces summary API though so we don't have yet the ability to discover new rooms inside of a space but this feature might land soon in the Matrix Dart SDK.</p>
<h3 id="multi-account">Multi Account</h3>
<p>FluffyChats multi account is still in beta but got a lot of bug fixes as well. You are now able to sort your accounts in &quot;bundles&quot; which can be very handy. The new account switcher button gives you a much better overview over your connected Matrix accounts now.</p>
<h3 id="performance">Performance</h3>
<p>We did a lot refactoring under the hood in our Matrix Dart SDK and have improved our in-app database a lot. On the web it now uses IndexedDB natively while it tunes all database transactions on all platforms. This leads to the fastest FluffyChat experience we ever had and makes the app finally kinda usable with bigger accounts on all platforms. The room list is now lazy loaded which speeds up the app start (especially with multi account enabled) a lot.
Choose your own primary color
This was a long requested feature. You can now choose your favorite color to style your FluffyChat for your needs:</p>
<p>What will you choose? Let me know in the comments. I mostly like blue on my Ubuntu desktop.</p>
<h3 id="new-major-version">New major version?</h3>
<p>Ahhh by the way... What does it mean that we now have FluffyChat 1.0.0? It does NOT mean that the previous versions were not yet stable or ready for daily use. It just means that we make so many changes at once that we thought, bumping the first digit of our pseudo-semver version string might make sense. We totally messed up our versioning and are now going to do it better. Promised!!
What's next?
We are often asked: What is the roadmap of FluffyChat?
Well... we still don't have a clear roadmap and might never have. FluffyChat is completely driven by volunteers. But what I can say that we would like to do in the next months is:</p>
<ul>
<li>Better QA -&gt; We would like to write some integration tests, push release candidates before new releases and involve everyone in testing them to offer the best stability possible.</li>
<li>Native video calls -&gt; Yes! There will soon land support for native video calls in the Matrix Dart SDK and we are going to implement this in FluffyChat.</li>
<li>Stories -&gt; Like you might know from SnapChat, WhatsApp or Instagram, stories are little messages you can send to all of your contacts and which will disappear after 24 hours. I would really like to implement this in FluffyChat!</li>
<li>Better notifications for iOS</li>
<li>Deeper support for spaces</li>
<li>Knocking feature</li>
<li>Drag&amp;Drop for web</li>
</ul>
<p>But as I said this is what we would like to do. We can't give any warranties on anything. We can only do our best. But you can help us if you like (You don't have to).</p>
<ul>
<li>Join the FluffyChat community: https://matrix.to/#/#fluffychat:matrix.org</li>
<li>Report bugs at our issue tracker: https://gitlab.com/famedly/fluffychat/-/issues</li>
<li>Help with the translations and join our translators team: https://matrix.to/#/#fluffychat-translation:matrix.org</li>
<li>Help with development directly in GitLab &lt;3</li>
<li>... or support us on Liberapay so we can organize more FluffyChat developer meetings: https://matrix.to/#/#fluffychat-translation:matrix.org</li>
</ul>
<h3 id="the-complete-changelog-for-fluffychat-1-0-0">The complete changelog for FluffyChat 1.0.0:</h3>
<ul>
<li>design: Chat backup dialog as a banner</li>
<li>design: Encrypted by design, all users valid is normal not green</li>
<li>design: Move video call button to menu</li>
<li>design: Display edit marker in new bubbles</li>
<li>design: Floating input bar</li>
<li>design: Minor color changes</li>
<li>design: Move device ID to menu</li>
<li>design: Place share button under qr code</li>
<li>design: Redesign and simplify bootstrap</li>
<li>design: Remove cupertino icons</li>
<li>feat: Display typing indicators with gif</li>
<li>feat: Fancy chat list loading animation</li>
<li>feat: New database backend with FluffyBox</li>
<li>feat: Make the main color editable for users</li>
<li>feat: Move styles one settings level up</li>
<li>feat: Multiple mute, pin and mark unread</li>
<li>feat: New chat design</li>
<li>feat: New chat details design</li>
<li>feat: New Public room bottom sheet</li>
<li>feat: New settings design</li>
<li>feat: Nicer images, stickers and videos</li>
<li>feat: nicer loading bar</li>
<li>feat: Open im.fluffychat uris</li>
<li>feat: Redesign multiaccounts and spaces</li>
<li>feat: Redesign start page</li>
<li>feat: Send reactions to multiple events</li>
<li>feat: Speed up app start</li>
<li>feat: Use SalomonBottomBar</li>
<li>feat: Drag&amp;Drop to send multiple files on desktop and web</li>
<li>fix: Adjust color</li>
<li>fix: Automatic key requests</li>
<li>fix: Bootstrap loop</li>
<li>fix: Chat background</li>
<li>fix: Chat list flickering</li>
<li>fix: Contrast in dark mode</li>
<li>fix: Crash when there is no prev message</li>
<li>fix: Do display error image widget</li>
<li>fix: Do not display bottombar in selectmode</li>
<li>fix: Dont enable encryption with bots</li>
<li>fix: Dont loose selected events</li>
<li>fix: Dont rerun server checks</li>
<li>fix: download path for saving files</li>
<li>fix: Hide FAB in new chat page if textfield has focus</li>
<li>fix: Let bottom space bar scroll</li>
<li>fix: Load spaces on app start</li>
<li>fix: Only mark unread if actually marked</li>
<li>fix: Public room design</li>
<li>fix: Remove avatar from room</li>
<li>fix: Remove broken docker job</li>
<li>fix: Report sync status error</li>
<li>fix: Self sign while bootstrap</li>
<li>fix: Sender name prefix in DM rooms</li>
<li>fix: Set room avatar</li>
<li>fix: Various multiaccount fixes</li>
<li>fix: Wrong version in snap packages
<img src="/blog/img/zzZpaxCiMkvXADEaQmItoWJo.jpeg" alt="" />
<img src="/blog/img/OvISMDfIBmNZGGPVkDNoabRw.png" alt="" />
<img src="/blog/img/BAaGNIefBUYFvusUntZusneN.jpeg" alt="" /></li>
</ul>
</blockquote>
<p>What a massive update! Little birds told me we will hear about FluffyChat very soon!</p>
<h3 id="element">Element <a href="https://element.io">‚Üó</a></h3>
<p>Everything related to Element but not strictly bound to a client</p>
<p><a href="https://matrix.to/#/@kittykat:matrix.org">kittykat</a> says</p>
<blockquote>
<p><strong>Threads</strong></p>
<ul>
<li>On Web, work continues on notifications and integration with homeserver APIs to improve user experience.</li>
<li>On Mobile, link sharing has been added and work is about to start on notifications.</li>
</ul>
<p><strong>Polls</strong></p>
<ul>
<li>Polls are nearly ready!  If you enable this feature in labs, you can create a poll with several options, and people can vote on it.</li>
<li>We‚Äôre working on the finishing touches, and the first version of polls will be available in a release (on Element Desktop, Web, Android and iOS) within a few weeks.</li>
</ul>
<p><strong>Community testing</strong></p>
<ul>
<li>We closed 34 encryption bugs which had been resolved by improvements to the workflows and user interfaces.</li>
<li>Due to the overwhelming success with bug squash sessions in the last few weeks, we are making these a regular feature. Our next session will be on Thursday 9 December at 17:00 UTC.</li>
<li>For information about upcoming sessions and to join in, join <a href="https://matrix.to/#/#element-community-testing:matrix.org">#element-community-testing:matrix.org</a>
<img src="/blog/img/ATkwyyLlzZVvjmTSeDjxCAaN.png" alt="" /></li>
</ul>
</blockquote>
<h3 id="element-web-desktop">Element Web/Desktop <a href="https://github.com/vector-im/element-web">‚Üó</a></h3>
<p>Secure and independent communication, connected via Matrix. Come talk with us in <a href="https://matrix.to/#/#element-web:matrix.org">#element-web:matrix.org</a>!</p>
<p><a href="https://matrix.to/#/@kittykat:matrix.org">kittykat</a> announces</p>
<blockquote>
<ul>
<li>In labs, work continues on<a href="https://github.com/vector-im/element-meta/issues/56"> Information Architecture</a>: new history interaction to replace breadcrumbs
<img src="/blog/img/YGhfoeGyKUnYtYgEEGFMXyDT.png" alt="" /></li>
<li>We are monitoring and triaging feedback which is submitted through the new feedback UI in the app.</li>
<li>Fixed long standing bug around link formatting - links are not formatted as markdown any more.</li>
</ul>
</blockquote>
<h3 id="element-ios">Element iOS <a href="https://github.com/vector-im/element-ios">‚Üó</a></h3>
<p>Secure and independent communication for iOS, connected via Matrix. Come talk with us in <a href="https://matrix.to/#/#element-ios:matrix.org">#element-ios:matrix.org</a>!</p>
<p><a href="https://matrix.to/#/@kittykat:matrix.org">kittykat</a> says</p>
<blockquote>
<ul>
<li>Analytics: final changes to allow opt-in analytics reporting with PostHog</li>
<li>MatrixKit has been integrated into element-ios in preparation for moving to the SwiftUI framework</li>
<li>Release Candidates are now scheduled on Tuesdays (previously on Wednesdays) which will bring them in line with Web releases.</li>
</ul>
</blockquote>
<h3 id="element-android">Element Android <a href="https://github.com/vector-im/element-android">‚Üó</a></h3>
<p>Secure and independent communication for Android, connected via Matrix. Come talk with us in <a href="https://matrix.to/#/#element-android:matrix.org">#element-android:matrix.org</a>!</p>
<p><a href="https://matrix.to/#/@kittykat:matrix.org">kittykat</a> announces</p>
<blockquote>
<ul>
<li>Element 1.3.9 has been submitted to Google: it adds support for voice message drafts and many bug fixes.</li>
<li>Starting work on new login flow: the user will be asked if they have an account or want to create one on the very first screen.</li>
<li>Analytics (PostHog): implementing the opt-in screen. Should be included in the 1.3.10 release.</li>
<li>Release Candidates are now scheduled on Tuesdays (previously on Wednesdays) which will bring them in line with Web releases.</li>
</ul>
</blockquote>
<h2 id="dept-of-sdks-and-frameworks">Dept of SDKs and Frameworks üß∞</h2>
<h3 id="trixnity">Trixnity <a href="https://gitlab.com/benkuly/trixnity">‚Üó</a></h3>
<p>Multiplatform Kotlin SDK for Matrix</p>
<p><a href="https://matrix.to/#/@benedict:imbitbu.de">Benedict</a> says</p>
<blockquote>
<p><a href="https://gitlab.com/benkuly/trixnity">Trixnity</a>, a multiplatform Matrix SDK written in Kotlin, has grown up since the last release 6 month ago! It has it first release candidate for v1.0.0!</p>
<p>If you don't heard about Trixnity: Trixnity aims to be strongly typed, customizable and easy to use. You can register custom events and Trixnity will take care, that you can send and receive that type.</p>
<p>The most exciting thing is the new trixnity-client module. It provides a high level client implementation and allows you to easily implement clients for Desktop, Mobile and Web. You just need to render data from and passing user interactions to Trixnity. The key features are:</p>
<ul>
<li><input disabled="" type="checkbox" checked=""/>
exchangeable database</li>
<li><input disabled="" type="checkbox" checked=""/>
fast cache on top of the database</li>
<li><input disabled="" type="checkbox" checked=""/>
E2E (olm, megolm)</li>
<li><input disabled="" type="checkbox" checked=""/>
verification</li>
<li><input disabled="" type="checkbox" checked=""/>
room list</li>
<li><input disabled="" type="checkbox" checked=""/>
timelines</li>
<li><input disabled="" type="checkbox" checked=""/>
user and room display name calculation</li>
<li><input disabled="" type="checkbox" checked=""/>
asynchronous message sending without caring about E2E stuff or online status</li>
<li><input disabled="" type="checkbox" checked=""/>
media support (thumbnail generation, offline &quot;upload&quot;, etc.)</li>
<li><input disabled="" type="checkbox" checked=""/>
redactions</li>
</ul>
<p>At the moment, Trixnity only supports JVM in all modules, but JS and Native will follow soon (to be exact: when Kotlin 1.6.10 and ktor 2.0.0 is released). I also implemented the module trixnity-olm, which implements the wrappers of libolm for Kotlin JVM/JS/Native.</p>
<p>Cross signing is one of the next big features, I want to implement.</p>
</blockquote>
<h3 id="simplematrixbotlib">simplematrixbotlib <a href="https://github.com/KrazyKirby99999/simple-matrix-bot-lib">‚Üó</a></h3>
<p>simplematrixbotlib is an easy to use bot library for the Matrix ecosystem written in Python and based on matrix-nio.</p>
<p><a href="https://matrix.to/#/@krazykirby99999:matrix.org">krazykirby99999</a> reports</p>
<blockquote>
<h2 id="version-2-4-1-released">Version 2.4.1 Released!</h2>
<h3 id="docs-changes">Docs Changes:</h3>
<ul>
<li>Added missing <code>await</code> statements to several examples</li>
<li>Added additional clarification on using the &quot;m.notice&quot; msgtype</li>
<li>Used Markdown instead of HTML to display a specific link</li>
</ul>
<p>Example usage is shown below:</p>
<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>import simplematrixbotlib as botlib
</span><span>
</span><span>creds = botlib.Creds(&quot;https://home.server&quot;, &quot;user&quot;, &quot;pass&quot;)
</span><span>bot = botlib.Bot(creds)
</span><span>PREFIX = &#39;!&#39;
</span><span>
</span><span>@bot.listener.on_message_event
</span><span>async def echo(room, message):
</span><span>    match = botlib.MessageMatch(room, message, bot, PREFIX)
</span><span>    if match.is_not_from_this_bot() and match.prefix() and match.command( &quot;echo&quot;):
</span><span>        response = &quot; &quot;.join(arg for arg in match.args())
</span><span>        await bot.api.send_text_message(room.room_id, response)
</span><span>
</span><span>bot.run()
</span></code></pre>
<p>A thank you to HarHarLinks for their contributions to version 2.4.1!</p>
<p>Request additional features <a href="https://github.com/KrazyKirby99999/simple-matrix-bot-lib/issues/new?assignees=&amp;labels=&amp;template=feature_request.md&amp;title=">here</a>.</p>
<p><a href="https://github.com/KrazyKirby99999/simple-matrix-bot-lib">View source on Github</a>
<a href="https://pypi.org/project/simplematrixbotlib/">View package on PyPi</a>
<a href="https://simple-matrix-bot-lib.readthedocs.io/en/latest/">View docs on readthedocs.io</a>
https://matrix.to/#/#simplematrixbotlib:matrix.org</p>
</blockquote>
<h2 id="dept-of-videos-video-camera">Dept of Videos üìπ</h2>
<p><a href="https://matrix.to/#/@andybalaam:matrix.org">andybalaam</a> announces</p>
<blockquote>
<p>I'm exploring the matrix-rust-sdk on my live stream every week. I'm working on a simple Rust bot for Matrix. Come watch me struggle with the compiler on <a href="https://diode.zone/c/andybalaam_programming/videos">PeerTube</a> or <a href="https://www.twitch.tv/andybalaam">Twitch</a> every wednesday at 14:00 UTC!</p>
</blockquote>
<h2 id="room-of-the-week-calendar">Room of the Week üìÜ</h2>
<p><a href="https://matrix.to/#/@timokoesters:fachschaften.org">Timo ‚ö°Ô∏è</a> says</p>
<blockquote>
<p>Hi everyone! Did you ever feel lost in the Matrix world? The room directory is big, but it's still hard to find something you like. Or are you a room moderator, but there is not much activity in your room because it doesn't have enough users?</p>
<p>This is why I want to share rooms (or spaces) I find interesting.</p>
<hr />
<p>This week's room is: <a href="https://matrix.to/#/#audiophiles:matrix.org">#audiophiles:matrix.org</a> </p>
<p><strong>&quot;Headphones, Speakers, IEM and any audio related equipment. Music recommendations as well.&quot;</strong></p>
<hr />
<p>If you want to suggest a room for this section, tell me in <a href="https://matrix.to/#/#roomoftheweek:fachschaften.org">#roomoftheweek:fachschaften.org</a></p>
</blockquote>
<h2 id="dept-of-ping-table-tennis-paddle-and-ball">Dept of Ping üèì</h2>
<p>Here we reveal, rank, and applaud the homeservers with the lowest ping, as measured by <a href="https://github.com/maubot/echo">pingbot</a>, a <a href="https://github.com/maubot/maubot">maubot</a> that you can host on your own server.</p>
<h3 id="ping-maunium-net"><a href="https://matrix.to/#/#ping:maunium.net">#ping:maunium.net</a></h3>
<p>Join <a href="https://matrix.to/#/#ping:maunium.net">#ping:maunium.net</a> to experience the fun live, and to find out how to add YOUR server to the game.</p>
<table><thead><tr><th style="text-align: center">Rank</th><th style="text-align: center">Hostname</th><th style="text-align: center">Median MS</th></tr></thead><tbody>
<tr><td style="text-align: center">1</td><td style="text-align: center">matrix.markshorten.co.uk</td><td style="text-align: center">1013</td></tr>
<tr><td style="text-align: center">2</td><td style="text-align: center">helderferreira.io</td><td style="text-align: center">1099</td></tr>
<tr><td style="text-align: center">3</td><td style="text-align: center">envs.net</td><td style="text-align: center">1438</td></tr>
<tr><td style="text-align: center">4</td><td style="text-align: center">thomcat.rocks</td><td style="text-align: center">2552.5</td></tr>
<tr><td style="text-align: center">5</td><td style="text-align: center">matrix.sp-codes.de</td><td style="text-align: center">3732.5</td></tr>
<tr><td style="text-align: center">6</td><td style="text-align: center">jauriarts.org</td><td style="text-align: center">3756.5</td></tr>
<tr><td style="text-align: center">7</td><td style="text-align: center">trygve.me</td><td style="text-align: center">3829</td></tr>
<tr><td style="text-align: center">8</td><td style="text-align: center">grimneko.de</td><td style="text-align: center">5095.5</td></tr>
<tr><td style="text-align: center">9</td><td style="text-align: center">kittenface.studio</td><td style="text-align: center">5606</td></tr>
<tr><td style="text-align: center">10</td><td style="text-align: center">jeroenhd.nl</td><td style="text-align: center">6970</td></tr>
</tbody></table>
<h3 id="ping-no-synapse-maunium-net"><a href="https://matrix.to/#/#ping-no-synapse:maunium.net">#ping-no-synapse:maunium.net</a></h3>
<p>Join <a href="https://matrix.to/#/#ping-no-synapse:maunium.net">#ping-no-synapse:maunium.net</a> to experience the fun live, and to find out how to add YOUR server to the game.</p>
<table><thead><tr><th style="text-align: center">Rank</th><th style="text-align: center">Hostname</th><th style="text-align: center">Median MS</th></tr></thead><tbody>
<tr><td style="text-align: center">1</td><td style="text-align: center">matrix.awesomesheep48.me</td><td style="text-align: center">1042</td></tr>
<tr><td style="text-align: center">2</td><td style="text-align: center">0x1a8510f2.space</td><td style="text-align: center">1076</td></tr>
<tr><td style="text-align: center">3</td><td style="text-align: center">dendrite.s3cr3t.me</td><td style="text-align: center">4405</td></tr>
</tbody></table>
<h2 id="the-adventures-of-twim-bot-continued">The Adventures of TWIM bot continued</h2>
<p>Following the late reports of the spec and hookshot updates, TWIM bot's ship went into hyperspeed. Our dear bot lost control of the ship and we lost its signal. We're doing our best to contact it and hope it's safe!</p>
<h2 id="that-s-all-i-know-checkered-flag">That's all I know üèÅ</h2>
<p>See you next week, and be sure to stop by <a href="https://matrix.to/#/#twim:matrix.org">#twim:matrix.org</a> with your updates!</p>

        </div>
    </article>
    
    <article class="post">
        <header>
            <h1><a href="&#x2F;blog&#x2F;2021&#x2F;12&#x2F;03&#x2F;type-coverage-for-sydent-motivation&#x2F;" title="Type coverage for Sydent: motivation">Type coverage for Sydent: motivation</a></h1>
            <span>
                03.12.2021 00:00
                ‚Äî
                <a href="/category/tech">
                    Tech
                </a>
                ‚Äî
                <a href="/author/david-robertson">
                    David Robertson
                </a>
            </span>
            
        </header>
        <div>
            <p><em>This is the first of three posts on improving type coverage in Sydent. Join us next Friday for the <a href="https://matrix.org/blog/2021/12/10/type-coverage-for-sydent-annotation">second part</a>!</em></p>
<p><a href="https://github.com/matrix-org/sydent">Sydent</a> is the reference Matrix Identity server. It provides a <a href="https://matrix.org/docs/spec/identity_service/r0.3.0">lookup service</a>, so that you can find a Matrix user via their email address or phone number (if they've chosen to share it).</p>
<p>We recently worked on <a href="https://github.com/matrix-org/sydent/issues/414">improving Sydent's type coverage</a>: the proportion of its source code with explicit annotations denoting the kind of data that each variable, expression and return value is expected to hold. These annotations are optional, but if present, they allow tools like <a href="https://mypy.readthedocs.io/en/stable/">mypy</a> to analyze your programs and spot entire classes of bugs <em>before</em> you ship them! In this instance, we aimed to make Sydent pass <code>mypy --strict</code>, which <a href="https://github.com/matrix-org/sydent/commit/7bdaac2774840e1f9697d30515f367c5c8c16866">it now does</a>. Here's what the process looked like:</p>
<p><img src="/blog/img/TWGXKTFpjYxlbnHRkZFAzljQ.png" alt="Coverage as measured by mypy. Precision and the number of typed expressions increase over the latter half of 2021." /></p>
<p>Two lines show two different measures of how well-typed the project is. The grey region covers our two-week sprint towards improving coverage; the earliest data point is from just before previous efforts to improve typing earlier in the year.</p>
<p>In a series of posts, I'd like to reflect on this sprint and share what we've learned. In particular, I aim to:</p>
<ul>
<li>explain why we wanted to improve type coverage <em>now</em>;</li>
<li>work through examples to see how (if?) mypy could have spotted bugs;</li>
<li>describe the annotation process;</li>
<li>illustrate common patterns I learned along the way;</li>
<li>discuss the checks that <code>mypy</code> provides; and finally</li>
<li>reflect on the state of Python's typing ecosystem.</li>
</ul>
<p>In this first part, we'll concentrate on the first two topics; the <a href="https://matrix.org/blog/2021/12/10/type-coverage-for-sydent-annotation">second</a> covers the middle two; and the <a href="https://matrix.org/blog/2021/12/17/type-coverage-for-sydent-evaluation">third</a> the last two.</p>
<h2 id="why-do-this-now">Why do this now?</h2>
<p>It took us a long time (too long) to notice that the Sydent instance serving <code>matrix.org</code> <a href="https://github.com/vector-im/element-web/issues/19317">was failing to send SMS messages for verification</a>. We suspected that something was going wrong with our <a href="https://github.com/matrix-org/sydent/blob/main/sydent/sms/openmarket.py">API call to OpenMarket</a>. Our first step was to <a href="https://github.com/matrix-org/sydent/issues/410">improve logging</a>, so we could start to deduce what was going wrong and why. Whilst trawling through logs, we spotted <a href="https://github.com/matrix-org/sydent/pull/413#pullrequestreview-775154313">
one problem</a> which meant we weren't actually sending off the API request in the first place. Further investigation revealed a <a href="https://github.com/matrix-org/sydent/pull/415">strings-versus-bytes confusion</a> which meant that we would always (incorrectly) interpret the API response as having failed.</p>
<p>All in all, phone number verification was unknowingly broken in the 2.4.0 release, to be fixed in 2.4.6 a month later. How could we do better? Better test coverage is (as ever) one answer. But <a href="https://github.com/matrix-org/sydent/pull/413#pullrequestreview-775154313">it struck me</a> that the two bugs we'd encountered might be ripe for automatic detection:</p>
<ul>
<li>we created an <a href="https://docs.python.org/3/library/typing.html#typing.Awaitable">Awaitable</a> but didn't <code>await</code> it or use it in any way, and</li>
<li>we tried to look up a <code>str</code> key in a dictionary which mapped <code>bytes</code> to <code>bytes</code>.</li>
</ul>
<p>Could a static analysis tool like <code>mypy</code> detect these? How much work would it take to do so? Are there other bugs and problems we could spot with it? I was curious to answer these questions and learn more about the tools that Python's typing ecosystem provides.</p>
<h2 id="could-typing-have-spotted-these-problems">Could typing have spotted these problems?</h2>
<p>Let's start with the first of question: what can <code>mypy</code> detect?</p>
<h3 id="the-missing-await">The missing <code>await</code></h3>
<p>Instead of writing <code>x = await foo()</code>, we simply had <code>x = foo()</code> and didn't then go on to <code>await x</code>. Mypy doesn't have means to detect this at present. There was interest in <a href="https://github.com/python/mypy/issues/2499">this issue</a> on such a feature, with related threads <a href="https://github.com/python/mypy/issues/5597">here</a> and <a href="https://github.com/python/mypy/issues/5650">here</a>.</p>
<p>Are there other opportunities to spot the error? Here's the relevant bit of source code from <a href="https://github.com/matrix-org/sydent/blob/2e3b7576b17e92080319e08c0c0ebf566935636c/sydent/http/servlets/msisdnservlet.py#L93-L98">before the fix</a>.</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span>            sid = self.sydent.validators.msisdn.requestToken(
</span><span>                phone_number_object, clientSecret, sendAttempt, brand
</span><span>            )
</span><span>            resp = {
</span><span>                </span><span style="color:#d69d85;">&quot;success&quot;</span><span>: </span><span style="color:#569cd6;">True</span><span>,
</span><span>                </span><span style="color:#d69d85;">&quot;sid&quot;</span><span>: str(sid),
</span><span>                </span><span style="color:#d69d85;">&quot;msisdn&quot;</span><span>: msisdn,
</span><span>                </span><span style="color:#d69d85;">&quot;intl_fmt&quot;</span><span>: intl_fmt,
</span><span>            }
</span></code></pre>
<p>The call to <code>requestToken</code> produces a value of type <code>Awaitable[int]</code>. If we tried to assign that to an expression of type <code>int</code> we'd get an error that mypy can spot.</p>
<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>$ cat example.py
</span><span>async def foo() -&gt; int:
</span><span>    return 1
</span><span>
</span><span>async def bar():
</span><span>    x = foo()      # no error
</span><span>    y: int = foo() # error: rhs is Awaitable[int], but lhs expects int
</span><span>
</span><span>$ mypy --check-untyped-defs example.py
</span><span>example.py:6: error: Incompatible types in assignment (expression has type &quot;Coroutine[Any, Any, int]&quot;, variable has type &quot;int&quot;)
</span><span>Found 1 error in 1 file (checked 1 source file)
</span></code></pre>
<p>Note that we have to specifically ask mypy to typecheck the body of <code>bar</code> by passing <a href="https://mypy.readthedocs.io/en/stable/command_line.html#cmdoption-mypy-check-untyped-defs">--check-untyped-defs</a>; by default, <code>mypy</code> will only typecheck annotated code.</p>
<p>We might also have been able to detect the error by looking at how we used <code>sid</code>. Unfortunately, the only use of was in a conversion <code>str(sid)</code>, which is a perfectly type-safe call for both <code>sid: int</code> and <code>sid: Awaitable[int]</code>. But let's put that aside for a second‚Äîsuppose we added <code>&quot;sid&quot;: sid</code> directly into the <code>resp</code> dictionary. Could mypy have spotted there was a problem with <em>that</em>?</p>
<p>Unfortunately not. Because <code>resp</code> has no annotation, we have to rely on how it's used to spot any type inconsistencies. There's only one use of <code>resp</code>: as the return value from its enclosing function, <code>render_POST</code>. Mypy's only chance to spot a type problem would be to compare the mypy's inferred type for <code>resp</code> to the return type of <code>render_POST</code>. What are those types? We can use <code>reveal_type</code> to see the former is <code>Dict[str, object]</code>. For the latter:</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span>    @jsonwrap
</span><span>    </span><span style="color:#569cd6;">def </span><span>render_POST(self, request: Request) -&gt; JsonDict:
</span></code></pre>
<p>The return type is <code>JsonDict</code>, which is an <a href="https://github.com/matrix-org/sydent/blob/2e3b7576b17e92080319e08c0c0ebf566935636c/sydent/types.py#L17">alias</a> for <code>Dict[str, Any]</code>. This is bad news, because <code>Dict[str, object]</code> and <code>Dict[str, Any]</code> are compatible. Digging a level deeper, this is because <code>sid: Any</code> holds true for both <code>sid: int</code> and <code>sid: Awaitable[int]</code>‚Äîso there's no error to spot here. The <code>Any</code> type is compatible with any other type whatsoever! Mypy uses <code>Any</code> as a way to <a href="https://mypy.readthedocs.io/en/stable/kinds_of_types.html#the-any-type">defer all type checking to runtime</a>; mypy won't (and can't!) statically analyse the usage of an expression of type <code>Any</code>. Indeed, mypy's reports will tell you how many <code>Any</code>s you're working with, and offer a variety of options to <a href="https://mypy.readthedocs.io/en/stable/command_line.html#disallow-dynamic-typing">warn or error on usages of <code>Any</code></a>.</p>
<p>If we were inserting <code>sid</code> directly into a dictionary, we could do better by annotating the dictionary (or the function's return type) as a <a href="https://docs.python.org/3/library/typing.html#typing.TypedDict">TypedDict</a>. This is a way to specify a dictionary with a fixed set of keys, each with a fixed type. It comes in really handy for Sydent, Sygnal and Synapse‚Äîall of <a href="https://matrix.org/docs/spec/">the Matrix APIs</a> exchange JSON dictionaries, so anything we can do to teach mypy about their shape and types is gold dust.</p>
<p>In short, there were options for detecting this with some code changes, but no magic wand that would have spotted the error in the code as written.</p>
<h3 id="the-strings-bytes-confusion">The strings/bytes confusion</h3>
<p>Our <a href="https://github.com/matrix-org/sydent/pull/415/files#diff-4b3e0551612818927c87fe0100262ec230e0342def9d3f09214b93dea3efacb8L103-R107">error</a> was here:</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span>        headers = dict(resp.headers.getAllRawHeaders())
</span><span>        request_id = </span><span style="color:#569cd6;">None
</span><span>        </span><span style="color:#569cd6;">if </span><span style="color:#d69d85;">&quot;X-Request-Id&quot; </span><span style="color:#569cd6;">in </span><span>headers:
</span><span>            request_id = headers[</span><span style="color:#d69d85;">&quot;X-Request-Id&quot;</span><span>][</span><span style="color:#b5cea8;">0</span><span>]
</span></code></pre>
<p>In this sample, <code>resp.headers</code> is a <a href="https://twistedmatrix.com/documents/current/api/twisted.web.http_headers.Headers.html">twisted.web.http_headers.Headers</a> instance. <code>getAllRawHeaders</code> is <a href="https://twistedmatrix.com/documents/current/api/twisted.web.http_headers.Headers.html#getAllRawHeaders">documented</a> as returning an iterable of <code>(bytes, Sequence[bytes])</code> pairs. Even better, mypy can see this because <code>getAllRawHeaders</code> is <a href="https://github.com/twisted/twisted/blob/5c24e99e671c4082a1ddc8dbeb869402294bd0dc/src/twisted/web/http_headers.py#L261">annotated</a> (many thanks to the twisted authors for this). Mypy should be able to deduce that we build a dictionary <code>headers: Dict[bytes, Sequence[bytes]</code>. We can check this using <a href="https://mypy.readthedocs.io/en/stable/cheat_sheet_py3.html#when-you-re-puzzled-or-when-things-are-complicated"><code>reveal_type</code></a>:</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span>        headers = dict(resp.headers.getAllRawHeaders())
</span><span>        reveal_type(headers)
</span></code></pre>
<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>$ mypy
</span><span>sydent/sms/openmarket.py:110: note: Revealed type is &quot;builtins.dict[builtins.bytes*, typing.Sequence*[builtins.bytes]]&quot;
</span></code></pre>
<p>(The <code>*</code> in <code>builtins.bytes*</code> here means mypy has <a href="https://stackoverflow.com/a/50499509/5252017">inferred</a> that the dictionary's keys are bytes, rather than being told explicitly that they must be bytes.)</p>
<p>That's all fine and dandy. But why didn't we spot this before if the annotations were all in place in twisted? Let's put aside the fact that, erm, we weren't running mypy in Sydent's CI <a href="https://github.com/matrix-org/sydent/pull/416">until the recent sprint</a>, unlike our <a href="https://github.com/matrix-org/synapse/blob/5640992d176a499204a0756b1677c9b1575b0a49/.github/workflows/tests.yml#L21">other</a> <a href="https://github.com/matrix-org/sygnal/blob/4a7367e84476a4b1054b1fe20e9e06f9f66e27f8/.github/workflows/pipeline.yml#L18-L26">projects</a>. Checking out the problematic version, we can run mypy on the file we know to contain the bug.</p>
<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>$ git checkout v2.4.0
</span><span>$ mypy --strict sydent/sms/openmarket.py
</span><span>sydent/sms/openmarket.py:82: error: Dict entry 0 has incompatible type &quot;str&quot;: &quot;int&quot;; expected &quot;str&quot;: &quot;str&quot;  [dict-item]
</span></code></pre>
<p>Huh. Mypy spots something, but not the error we were hoping for. What's going on here? We can ask mypy to show its working with <code>reveal_type</code> again.</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span>        resp = </span><span style="color:#569cd6;">await </span><span>self.http_cli.post_json_get_nothing(
</span><span>            API_BASE_URL, send_body, {</span><span style="color:#d69d85;">&quot;headers&quot;</span><span>: req_headers}
</span><span>        )
</span><span>        reveal_type(resp)
</span><span>        headers = dict(resp.headers.getAllRawHeaders())
</span><span>        reveal_type(resp.headers)
</span><span>        reveal_type(resp.headers.getAllwRawHeaders())
</span><span>        reveal_type(headers)
</span></code></pre>
<p>This yields:</p>
<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>$ mypy sydent/sms/openmarket.py
</span><span>sydent/sms/openmarket.py:82: error: Dict entry 0 has incompatible type &quot;str&quot;: &quot;int&quot;; expected &quot;str&quot;: &quot;str&quot;  [dict-item]
</span><span>sydent/sms/openmarket.py:102: note: Revealed type is &quot;twisted.web.iweb.IResponse*&quot;
</span><span>sydent/sms/openmarket.py:104: note: Revealed type is &quot;Any&quot;
</span><span>sydent/sms/openmarket.py:105: note: Revealed type is &quot;Any&quot;
</span><span>sydent/sms/openmarket.py:106: note: Revealed type is &quot;builtins.dict[Any, Any]&quot;
</span><span>Found 1 error in 1 file (checked 1 source file)
</span></code></pre>
<p>Ahh, the <code>Any</code> type. As mentioned above, this represents a value whose type can't be statically determined. We're left to runtime checks to detect the problem. But we won't detect it at runtime, because dictionaries don't enforce any kind of type requirements on their keys and values.</p>
<p>The problem here is that mypy can't see that <code>resp.headers</code> is a twisted <code>Headers</code> object. If we could inform it of this, mypy would spot our bug:</p>
<pre data-lang="python" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python "><code class="language-python" data-lang="python"><span>        </span><span style="color:#9b9b9b;">import </span><span>twisted.web.http_headers
</span><span>        raw_headers: twisted.web.http_headers.Headers = resp.headers
</span><span>        reveal_type(resp)
</span><span>        headers = dict(raw_headers.getAllRawHeaders())
</span><span>        reveal_type(raw_headers)
</span><span>        reveal_type(raw_headers.getAllRawHeaders())
</span><span>        reveal_type(headers)
</span></code></pre>
<pre style="background-color:#1e1e1e;color:#dcdcdc;"><code><span>$ mypy sydent/sms/openmarket.py
</span><span>sydent/sms/openmarket.py:82: error: Dict entry 0 has incompatible type &quot;str&quot;: &quot;int&quot;; expected &quot;str&quot;: &quot;str&quot;  [dict-item]
</span><span>sydent/sms/openmarket.py:104: note: Revealed type is &quot;twisted.web.iweb.IResponse*&quot;
</span><span>sydent/sms/openmarket.py:106: note: Revealed type is &quot;twisted.web.http_headers.Headers&quot;
</span><span>sydent/sms/openmarket.py:107: note: Revealed type is &quot;typing.Iterator[Tuple[builtins.bytes, typing.Sequence[builtins.bytes]]]&quot;
</span><span>sydent/sms/openmarket.py:108: note: Revealed type is &quot;builtins.dict[builtins.bytes*, typing.Sequence*[builtins.bytes]]&quot;
</span><span>sydent/sms/openmarket.py:114: error: Invalid index type &quot;str&quot; for &quot;Dict[bytes, Sequence[bytes]]&quot;; expected type &quot;bytes&quot;  [index]
</span><span>sydent/sms/openmarket.py:114: error: Argument 1 to &quot;split&quot; of &quot;bytes&quot; has incompatible type &quot;str&quot;; expected &quot;Optional[bytes]&quot;  [arg-type]
</span><span>Found 3 errors in 1 file (checked 1 source file)
</span></code></pre>
<p>There it is, on line 114: <code>Invalid index type &quot;str&quot; for &quot;Dict[bytes, Sequence[bytes]]&quot;; expected type &quot;bytes&quot;</code>.</p>
<p>Unfortunately it'd be a pain to annotate our application code to mark every use of <code>IResponse.headers</code> as a <code>Headers</code> object. We'll see a better way to do things in this <a href="https://matrix.org/blog/2021/12/10/type-coverage-for-sydent-annotation">the next post</a>, which discusses the nitty-gritty details of adding annotations file-by-file.</p>
<hr />
<p>Many thanks for reading! If you've got any corrections, comments or queries, I'm available on Matrix at <a href="https://matrix.to/#/@dmrobertson:matrix.org">@dmrobertson:matrix.org</a>.</p>

        </div>
    </article>
    
    <article class="post">
        <header>
            <h1><a href="&#x2F;blog&#x2F;2021&#x2F;12&#x2F;02&#x2F;call-for-participation-for-the-fosdem-2022-matrix-dev-room&#x2F;" title="Call for Participation for the FOSDEM 2022 Matrix Dev Room!">Call for Participation for the FOSDEM 2022 Matrix Dev Room!</a></h1>
            <span>
                02.12.2021 00:00
                ‚Äî
                <a href="/category/general">
                    General
                </a>
                ‚Äî
                <a href="/author/thib">
                    Thib
                </a>
            </span>
            
        </header>
        <div>
            <h2 id="a-full-day-of-matrix-talks">A full day of Matrix talks</h2>
<p>This year, the Matrix.org Foundation is excited to host the first ever <em>Matrix.org Foundation and Community</em> devroom at FOSDEM. A full day of talks, demos and workshops around Matrix itself and projects built on top of Matrix.</p>
<p>Matrix is the open source project that publishes the Matrix open standard for secure, decentralised, real-time communication, and its Apache licensed reference implementations.</p>
<p>We encourage people working on the Matrix protocol or building on it in an open source project to submit a proposal! Note that companies are welcome to talk about the Matrix details of their open source projects, but marketing talks are not welcome.</p>
<p>We want this devroom to be a space where the Matrix community can show its work, where developers can talk about the challenges they faced and how they overcame them, and where people can get a glimpse of the future of the Matrix protocol and ecosystem.</p>
<h2 id="talk-details">Talk Details</h2>
<p>The talks will be pre-recorded in January. They will be played during FOSDEM, followed by a session of live Q&amp;A depending on the format. During the playback of the talk, people will be able to comment and ask questions in the chat (via Matrix!).</p>
<p>The talks can follow one of three formats:</p>
<ul>
<li>5 min lightning talk, ideal to showcase your project and make people want to have a look at it</li>
<li>20 min talk + 10 min Q&amp;A, for topics that can be covered briefly</li>
<li>50 min talk + 10 min Q&amp;A for more complex subjects which need more focus</li>
</ul>
<p>We strongly encourage you to prepare a demo when it makes sense, so people can actually see what your work looks like in practice!</p>
<p>Of course, the proposal must respect the FOSDEM terms as well:</p>
<blockquote>
<p>The conference language is English. All content must relate to Free and Open Source Software. By participating in the event you agree to the publication of your recordings, slides and other content provided under the same licence as all FOSDEM content (CC-BY).</p>
</blockquote>
<h2 id="submitting-a-proposal">Submitting a Proposal</h2>
<p>Proposals must be <a href="https://penta.fosdem.org/submission/FOSDEM22">submitted on FOSDEM's conference management system Pentabarf</a> before December 17th 2021. If you are not used to Pentabarf, you can follow this <a href="https://eyskens.me/beginners-guide-to-pentabarf/">beginners guide to Pentabarf</a>.</p>
<p>We expect to receive more requests than we have slots available. The devroom organisers (two community members and one core team rep) will be reviewing the proposals and accepting them based on the potential positive impact the project has on Matrix (as defined in by the Mission section of https://matrix.org/foundation).</p>
<p>If a project proposal has been turned down, it doesn't mean we don't believe it has good potential. Maintainers are invited to join the <a href="https://matrix.to/#/#twim:matrix.org">#twim:matrix.org</a> Matrix room to give it some visibility.</p>

        </div>
    </article>
    
    <nav class="pagination">
    <div class="prev">
        
        <a href="&#x2F;blog&#x2F;page&#x2F;11&#x2F;">‚Äπ Previous</a>
        
    </div>
    <span class="page-number">12 / 67</span>
    <div class="prev">
        
        <a href="&#x2F;blog&#x2F;page&#x2F;13&#x2F;">Next ‚Ä∫</a>
        
    </div>
</nav>

</div>
    </main>

    <footer class="site-footer">
    <div class="internal-links">
        
        <a href="&#x2F;faq">FAQs</a>
        
        <a href="&#x2F;security-disclosure-policy">Security Disclosure Policy</a>
        
        <a href="&#x2F;security-hall-of-fame">Security Hall of Fame</a>
        
        <a href="&#x2F;legal&#x2F;code-of-conduct">Code of Conduct for Matrix.org</a>
        
        <a href="&#x2F;legal">Legal</a>
        
        <a href="&#x2F;contact">Contact</a>
        
        <a href="https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix.org&#x2F;">Site Source</a>
        
    </div>
    <div class="external-links">
        <div>
            
            <a href="https:&#x2F;&#x2F;github.com&#x2F;matrix-org"><img src="/assets/github.svg" alt="GitHub"></a>
            
            <a href="https:&#x2F;&#x2F;gitlab.matrix.org&#x2F;"><img src="/assets/gitlab.svg" alt="GitLab"></a>
            
            <a href="https:&#x2F;&#x2F;mastodon.matrix.org&#x2F;@matrix"><img src="/assets/mastodon.svg" alt="Mastodon"></a>
            
            <a href="https:&#x2F;&#x2F;twitter.com&#x2F;matrixdotorg"><img src="/assets/twitter.svg" alt="Twitter"></a>
            
            <a href="https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UCVFkW-chclhuyYRbmmfwt6w"><img src="/assets/youtube.svg" alt="YouTube"></a>
            
        </div>
    </div>
    <p>¬© 2022 The Matrix.org Foundation C.I.C.</p>
</footer>

</body>

</html>
