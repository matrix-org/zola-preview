<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="twitter:widgets:csp" content="on" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="twitter:site" content="@matrixdotorg" />
    <meta name="twitter:creator" content="@matrixdotorg" />

    <title>Matrix.org - Synapse 1.22.0 released</title>
    <link rel="shortcut icon" href="/assets/favicon.ico" />
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg" />
    <link rel="stylesheet" href="/style.css" />

    


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "NewsArticle",
    "headline": "Synapse 1.22.0 released",
    "datePublished": "2020-10-27T17:01+00:00",
    
    "author": [
    
    {
        "@type": "Person",
        "name": "Dan Callahan",
        "url": "matrix.org/authors/dan-callahan"
    }
    
    ]
}
</script>
</head>

<body>
    
    <header class="site-header">
    <a href="/" class="brand">
        <img src="/images/matrix-logo-white.svg" alt="Matrix logo">
    </a>
    <input id="site-header-dropdown-checkbox" type="checkbox" class="dropdown-checkbox" aria-hidden="true">
    <label for="site-header-dropdown-checkbox" class="dropdown-button">&#xe602;</label>
    <label for="site-header-dropdown-checkbox" class="page-overlay"></label>
    <nav>
        
        
        <a href="&#x2F;about&#x2F;" class="
            ">
            About
        </a>
        
        
        
        <a href="&#x2F;blog&#x2F;" class="
            current">
            Blog
        </a>
        
        
        
        <a href="&#x2F;docs&#x2F;" class="
            ">
            Documentation
        </a>
        
        
        
        
        
        <div class="section-wrap">
            <input id="ecosystem-submenu-checkbox" type="checkbox" class="submenu-checkbox" aria-hidden="true"
                >
            <label for="ecosystem-submenu-checkbox" class="submenu-title">Ecosystem <div class="arrow">
                </div></label>

            <div class="section-submenu-wrap">
                <div class="section-submenu">
                    
                    
                    <a href="&#x2F;ecosystem&#x2F;clients&#x2F;">Clients</a>
                    
                    
                    <a href="&#x2F;ecosystem&#x2F;bridges&#x2F;">Bridges</a>
                    
                    
                    <a href="&#x2F;ecosystem&#x2F;servers&#x2F;">Servers</a>
                    
                    <a href="&#x2F;ecosystem&#x2F;integrations&#x2F;">Integrations</a>
                    
                    <a href="&#x2F;ecosystem&#x2F;sdks&#x2F;">SDKs</a>
                    
                    <a href="&#x2F;ecosystem&#x2F;hosting&#x2F;">Hosting</a>
                    
                </div>
            </div>
        </div>
        
        
        
        <a href="&#x2F;podcasts&#x2F;" class="
            ">
            Podcasts
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;shop.matrix.org" class="
            ">
            Shop
        </a>
        
        
        
        <a href="&#x2F;try-matrix&#x2F;" class="primary
            ">
            Try Matrix
        </a>
        
        
    </nav>
</header>


    <main>
        
<article class="content post with-sidebar">
    <header>
        <h1>Synapse 1.22.0 released</h1>
        <span>
            27.10.2020 17:01
            
            —
            <a href="/category/releases">Releases</a>
            
            —
            <a
                href="/author/dan-callahan">Dan Callahan</a>
            
        </span>
        
    </header>
    <div class="post-main">
        <div class="post-content">
            <p><a href="https://github.com/matrix-org/synapse/releases/tag/v1.22.0">Synapse 1.22.0</a> now available!</p>
<p>This release focused on improving Synapse's horizontal scalability, including:</p>
<ul>
<li>Support for running background tasks in separate worker processes.</li>
<li>Fixes to sharded event persisters, which were experimentally introduced in 1.21.0.</li>
<li>Fixing a message duplication bug with worker-based deployments. (<a href="https://github.com/matrix-org/synapse/issues/8476">#8476</a>)</li>
</ul>
<p>Synapse 1.22.0 also has a few other notable changes:</p>
<ul>
<li>Defaulting to <a href="https://matrix.org/docs/spec/rooms/v6">version 6</a> rooms, per <a href="https://github.com/matrix-org/matrix-doc/pull/2788/">MSC2788</a>.</li>
<li>Initial support for three new experimental MSCs:
<ul>
<li><a href="https://github.com/matrix-org/matrix-doc/pull/2732">MSC2732</a>: Supporting olm fallback keys</li>
<li><a href="https://github.com/matrix-org/matrix-doc/pull/2697">MSC2697</a>: Supporting device dehydration</li>
<li><a href="https://github.com/matrix-org/matrix-doc/pull/2409">MSC2409</a>: Allowing appservices to receive ephemeral events like read receipts, presence, and typing indicators.</li>
</ul>
</li>
<li>Multi-arch Docker images, covering <code>arm64</code> and <code>arm/v7</code> in addition to <code>amd64</code>.</li>
</ul>
<p>Installation instructions are available <a href="https://github.com/matrix-org/synapse/blob/master/INSTALL.md">on GitHub</a>, as is the <code>v1.22.0</code> <a href="https://github.com/matrix-org/synapse/releases/tag/v1.22.0">release tag</a>.</p>
<p>Lastly, Synapse is a Free and Open Source Software project, and we'd like to extend our thanks to everyone who contributed to this release, including <a href="https://github.com/Akkowicz">@Akkowicz</a>, <a href="https://github.com/BBBSnowball">@BBBSnowball</a>, <a href="https://github.com/maquis196">@maquis196</a>, and <a href="https://github.com/samuel-p">@samuel-p</a>.</p>
<p>The full changelog for 1.22.0 is as follows:</p>
<h1 id="synapse-1-22-0-2020-10-27">Synapse 1.22.0 (2020-10-27)</h1>
<p>No significant changes.</p>
<h1 id="synapse-1-22-0rc2-2020-10-26">Synapse 1.22.0rc2 (2020-10-26)</h1>
<h2 id="bugfixes">Bugfixes</h2>
<ul>
<li>Fix bugs where ephemeral events were not sent to appservices. Broke in v1.22.0rc1. (<a href="https://github.com/matrix-org/synapse/issues/8648">#8648</a>, <a href="https://github.com/matrix-org/synapse/issues/8656">#8656</a>)</li>
<li>Fix <code>user_daily_visits</code> table to not have duplicate rows per user/device due to multiple user agents. Broke in v1.22.0rc1. (<a href="https://github.com/matrix-org/synapse/issues/8654">#8654</a>)</li>
</ul>
<h1 id="synapse-1-22-0rc1-2020-10-22">Synapse 1.22.0rc1 (2020-10-22)</h1>
<h2 id="features">Features</h2>
<ul>
<li>Add a configuration option for always using the &quot;userinfo endpoint&quot; for OpenID Connect. This fixes support for some identity providers, e.g. GitLab. Contributed by Benjamin Koch. (<a href="https://github.com/matrix-org/synapse/issues/7658">#7658</a>)</li>
<li>Add ability for <code>ThirdPartyEventRules</code> modules to query and manipulate whether a room is in the public rooms directory. (<a href="https://github.com/matrix-org/synapse/issues/8292">#8292</a>, <a href="https://github.com/matrix-org/synapse/issues/8467">#8467</a>)</li>
<li>Add support for olm fallback keys (<a href="https://github.com/matrix-org/matrix-doc/pull/2732">MSC2732</a>). (<a href="https://github.com/matrix-org/synapse/issues/8312">#8312</a>, <a href="https://github.com/matrix-org/synapse/issues/8501">#8501</a>)</li>
<li>Add support for running background tasks in a separate worker process. (<a href="https://github.com/matrix-org/synapse/issues/8369">#8369</a>, <a href="https://github.com/matrix-org/synapse/issues/8458">#8458</a>, <a href="https://github.com/matrix-org/synapse/issues/8489">#8489</a>, <a href="https://github.com/matrix-org/synapse/issues/8513">#8513</a>, <a href="https://github.com/matrix-org/synapse/issues/8544">#8544</a>, <a href="https://github.com/matrix-org/synapse/issues/8599">#8599</a>)</li>
<li>Add support for device dehydration (<a href="https://github.com/matrix-org/matrix-doc/pull/2697">MSC2697</a>). (<a href="https://github.com/matrix-org/synapse/issues/8380">#8380</a>)</li>
<li>Add support for <a href="https://github.com/matrix-org/matrix-doc/pull/2409">MSC2409</a>, which allows sending typing, read receipts, and presence events to appservices. (<a href="https://github.com/matrix-org/synapse/issues/8437">#8437</a>, <a href="https://github.com/matrix-org/synapse/issues/8590">#8590</a>)</li>
<li>Change default room version to &quot;6&quot;, per <a href="https://github.com/matrix-org/matrix-doc/pull/2788">MSC2788</a>. (<a href="https://github.com/matrix-org/synapse/issues/8461">#8461</a>)</li>
<li>Add the ability to send non-membership events into a room via the <code>ModuleApi</code>. (<a href="https://github.com/matrix-org/synapse/issues/8479">#8479</a>)</li>
<li>Increase default upload size limit from 10M to 50M. Contributed by @Akkowicz. (<a href="https://github.com/matrix-org/synapse/issues/8502">#8502</a>)</li>
<li>Add support for modifying event content in <code>ThirdPartyRules</code> modules. (<a href="https://github.com/matrix-org/synapse/issues/8535">#8535</a>, <a href="https://github.com/matrix-org/synapse/issues/8564">#8564</a>)</li>
</ul>
<h2 id="bugfixes-1">Bugfixes</h2>
<ul>
<li>Fix a longstanding bug where invalid ignored users in account data could break clients. (<a href="https://github.com/matrix-org/synapse/issues/8454">#8454</a>)</li>
<li>Fix a bug where backfilling a room with an event that was missing the <code>redacts</code> field would break. (<a href="https://github.com/matrix-org/synapse/issues/8457">#8457</a>)</li>
<li>Don't attempt to respond to some requests if the client has already disconnected. (<a href="https://github.com/matrix-org/synapse/issues/8465">#8465</a>)</li>
<li>Fix message duplication if something goes wrong after persisting the event. (<a href="https://github.com/matrix-org/synapse/issues/8476">#8476</a>)</li>
<li>Fix incremental sync returning an incorrect <code>prev_batch</code> token in timeline section, which when used to paginate returned events that were included in the incremental sync. Broken since v0.16.0. (<a href="https://github.com/matrix-org/synapse/issues/8486">#8486</a>)</li>
<li>Expose the <code>uk.half-shot.msc2778.login.application_service</code> to clients from the login API. This feature was added in v1.21.0, but was not exposed as a potential login flow. (<a href="https://github.com/matrix-org/synapse/issues/8504">#8504</a>)</li>
<li>Fix error code for <code>/profile/{userId}/displayname</code> to be <code>M_BAD_JSON</code>. (<a href="https://github.com/matrix-org/synapse/issues/8517">#8517</a>)</li>
<li>Fix a bug introduced in v1.7.0 that could cause Synapse to insert values from non-state <code>m.room.retention</code> events into the <code>room_retention</code> database table. (<a href="https://github.com/matrix-org/synapse/issues/8527">#8527</a>)</li>
<li>Fix not sending events over federation when using sharded event writers. (<a href="https://github.com/matrix-org/synapse/issues/8536">#8536</a>)</li>
<li>Fix a long standing bug where email notifications for encrypted messages were blank. (<a href="https://github.com/matrix-org/synapse/issues/8545">#8545</a>)</li>
<li>Fix increase in the number of <code>There was no active span...</code> errors logged when using OpenTracing. (<a href="https://github.com/matrix-org/synapse/issues/8567">#8567</a>)</li>
<li>Fix a bug that prevented errors encountered during execution of the <code>synapse_port_db</code> from being correctly printed. (<a href="https://github.com/matrix-org/synapse/issues/8585">#8585</a>)</li>
<li>Fix appservice transactions to only include a maximum of 100 persistent and 100 ephemeral events. (<a href="https://github.com/matrix-org/synapse/issues/8606">#8606</a>)</li>
</ul>
<h2 id="updates-to-the-docker-image">Updates to the Docker image</h2>
<ul>
<li>Added multi-arch support (arm64,arm/v7) for the docker images. Contributed by @maquis196. (<a href="https://github.com/matrix-org/synapse/issues/7921">#7921</a>)</li>
<li>Add support for passing commandline args to the synapse process. Contributed by @samuel-p. (<a href="https://github.com/matrix-org/synapse/issues/8390">#8390</a>)</li>
</ul>
<h2 id="improved-documentation">Improved Documentation</h2>
<ul>
<li>Update the directions for using the manhole with coroutines. (<a href="https://github.com/matrix-org/synapse/issues/8462">#8462</a>)</li>
<li>Improve readme by adding new shield.io badges. (<a href="https://github.com/matrix-org/synapse/issues/8493">#8493</a>)</li>
<li>Added note about docker in manhole.md regarding which ip address to bind to. Contributed by @Maquis196. (<a href="https://github.com/matrix-org/synapse/issues/8526">#8526</a>)</li>
<li>Document the new behaviour of the <code>allowed_lifetime_min</code> and <code>allowed_lifetime_max</code> settings in the room retention configuration. (<a href="https://github.com/matrix-org/synapse/issues/8529">#8529</a>)</li>
</ul>
<h2 id="deprecations-and-removals">Deprecations and Removals</h2>
<ul>
<li>Drop unused <code>device_max_stream_id</code> table. (<a href="https://github.com/matrix-org/synapse/issues/8589">#8589</a>)</li>
</ul>
<h2 id="internal-changes">Internal Changes</h2>
<ul>
<li>Check for unreachable code with mypy. (<a href="https://github.com/matrix-org/synapse/issues/8432">#8432</a>)</li>
<li>Add unit test for event persister sharding. (<a href="https://github.com/matrix-org/synapse/issues/8433">#8433</a>)</li>
<li>Allow events to be sent to clients sooner when using sharded event persisters. (<a href="https://github.com/matrix-org/synapse/issues/8439">#8439</a>, <a href="https://github.com/matrix-org/synapse/issues/8488">#8488</a>, <a href="https://github.com/matrix-org/synapse/issues/8496">#8496</a>, <a href="https://github.com/matrix-org/synapse/issues/8499">#8499</a>)</li>
<li>Configure <code>public_baseurl</code> when using demo scripts. (<a href="https://github.com/matrix-org/synapse/issues/8443">#8443</a>)</li>
<li>Add SQL logging on queries that happen during startup. (<a href="https://github.com/matrix-org/synapse/issues/8448">#8448</a>)</li>
<li>Speed up unit tests when using PostgreSQL. (<a href="https://github.com/matrix-org/synapse/issues/8450">#8450</a>)</li>
<li>Remove redundant database loads of stream_ordering for events we already have. (<a href="https://github.com/matrix-org/synapse/issues/8452">#8452</a>)</li>
<li>Reduce inconsistencies between codepaths for membership and non-membership events. (<a href="https://github.com/matrix-org/synapse/issues/8463">#8463</a>)</li>
<li>Combine <code>SpamCheckerApi</code> with the more generic <code>ModuleApi</code>. (<a href="https://github.com/matrix-org/synapse/issues/8464">#8464</a>)</li>
<li>Additional testing for <code>ThirdPartyEventRules</code>. (<a href="https://github.com/matrix-org/synapse/issues/8468">#8468</a>)</li>
<li>Add <code>-d</code> option to <code>./scripts-dev/lint.sh</code> to lint files that have changed since the last git commit. (<a href="https://github.com/matrix-org/synapse/issues/8472">#8472</a>)</li>
<li>Unblacklist some sytests. (<a href="https://github.com/matrix-org/synapse/issues/8474">#8474</a>)</li>
<li>Include the log level in the phone home stats. (<a href="https://github.com/matrix-org/synapse/issues/8477">#8477</a>)</li>
<li>Remove outdated sphinx documentation, scripts and configuration. (<a href="https://github.com/matrix-org/synapse/issues/8480">#8480</a>)</li>
<li>Clarify error message when plugin config parsers raise an error. (<a href="https://github.com/matrix-org/synapse/issues/8492">#8492</a>)</li>
<li>Remove the deprecated <code>Handlers</code> object. (<a href="https://github.com/matrix-org/synapse/issues/8494">#8494</a>)</li>
<li>Fix a threadsafety bug in unit tests. (<a href="https://github.com/matrix-org/synapse/issues/8497">#8497</a>)</li>
<li>Add user agent to user_daily_visits table. (<a href="https://github.com/matrix-org/synapse/issues/8503">#8503</a>)</li>
<li>Add type hints to various parts of the code base. (<a href="https://github.com/matrix-org/synapse/issues/8407">#8407</a>, <a href="https://github.com/matrix-org/synapse/issues/8505">#8505</a>, <a href="https://github.com/matrix-org/synapse/issues/8507">#8507</a>, <a href="https://github.com/matrix-org/synapse/issues/8547">#8547</a>, <a href="https://github.com/matrix-org/synapse/issues/8562">#8562</a>, <a href="https://github.com/matrix-org/synapse/issues/8609">#8609</a>)</li>
<li>Remove unused code from the test framework. (<a href="https://github.com/matrix-org/synapse/issues/8514">#8514</a>)</li>
<li>Apply some internal fixes to the <code>HomeServer</code> class to make its code more idiomatic and statically-verifiable. (<a href="https://github.com/matrix-org/synapse/issues/8515">#8515</a>)</li>
<li>Factor out common code between <code>RoomMemberHandler._locally_reject_invite</code> and <code>EventCreationHandler.create_event</code>. (<a href="https://github.com/matrix-org/synapse/issues/8537">#8537</a>)</li>
<li>Improve database performance by executing more queries without starting transactions. (<a href="https://github.com/matrix-org/synapse/issues/8542">#8542</a>)</li>
<li>Rename <code>Cache</code> to <code>DeferredCache</code>, to better reflect its purpose. (<a href="https://github.com/matrix-org/synapse/issues/8548">#8548</a>)</li>
<li>Move metric registration code down into <code>LruCache</code>. (<a href="https://github.com/matrix-org/synapse/issues/8561">#8561</a>, <a href="https://github.com/matrix-org/synapse/issues/8591">#8591</a>)</li>
<li>Replace <code>DeferredCache</code> with the lighter-weight <code>LruCache</code> where possible. (<a href="https://github.com/matrix-org/synapse/issues/8563">#8563</a>)</li>
<li>Add virtualenv-generated folders to <code>.gitignore</code>. (<a href="https://github.com/matrix-org/synapse/issues/8566">#8566</a>)</li>
<li>Add <code>get_immediate</code> method to <code>DeferredCache</code>. (<a href="https://github.com/matrix-org/synapse/issues/8568">#8568</a>)</li>
<li>Fix mypy not properly checking across the codebase, additionally, fix a typing assertion error in <code>handlers/auth.py</code>. (<a href="https://github.com/matrix-org/synapse/issues/8569">#8569</a>)</li>
<li>Fix <code>synmark</code> benchmark runner. (<a href="https://github.com/matrix-org/synapse/issues/8571">#8571</a>)</li>
<li>Modify <code>DeferredCache.get()</code> to return <code>Deferred</code>s instead of <code>ObservableDeferred</code>s. (<a href="https://github.com/matrix-org/synapse/issues/8572">#8572</a>)</li>
<li>Adjust a protocol-type definition to fit <code>sqlite3</code> assertions. (<a href="https://github.com/matrix-org/synapse/issues/8577">#8577</a>)</li>
<li>Support macOS on the <code>synmark</code> benchmark runner. (<a href="https://github.com/matrix-org/synapse/issues/8578">#8578</a>)</li>
<li>Update <code>mypy</code> static type checker to 0.790. (<a href="https://github.com/matrix-org/synapse/issues/8583">#8583</a>, <a href="https://github.com/matrix-org/synapse/issues/8600">#8600</a>)</li>
<li>Re-organize the structured logging code to separate the TCP transport handling from the JSON formatting. (<a href="https://github.com/matrix-org/synapse/issues/8587">#8587</a>)</li>
<li>Remove extraneous unittest logging decorators from unit tests. (<a href="https://github.com/matrix-org/synapse/issues/8592">#8592</a>)</li>
<li>Minor optimisations in caching code. (<a href="https://github.com/matrix-org/synapse/issues/8593">#8593</a>, <a href="https://github.com/matrix-org/synapse/issues/8594">#8594</a>)</li>
</ul>

        </div>
        
        <aside>
            <h3>Post Contents</h3>

            <ul style="list-style: none; padding-left: 0px;">
                
                <li>
                    <a href="matrix.org/blog/2020/10/27/synapse-1-22-0-released/#synapse-1-22-0-2020-10-27">Synapse 1.22.0 (2020-10-27)</a>
                    
                </li>
                
                <li>
                    <a href="matrix.org/blog/2020/10/27/synapse-1-22-0-released/#synapse-1-22-0rc2-2020-10-26">Synapse 1.22.0rc2 (2020-10-26)</a>
                    
                    <ul>
                        
                        <li>
                            <a href="matrix.org/blog/2020/10/27/synapse-1-22-0-released/#bugfixes">Bugfixes</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
                <li>
                    <a href="matrix.org/blog/2020/10/27/synapse-1-22-0-released/#synapse-1-22-0rc1-2020-10-22">Synapse 1.22.0rc1 (2020-10-22)</a>
                    
                    <ul>
                        
                        <li>
                            <a href="matrix.org/blog/2020/10/27/synapse-1-22-0-released/#features">Features</a>
                        </li>
                        
                        <li>
                            <a href="matrix.org/blog/2020/10/27/synapse-1-22-0-released/#bugfixes-1">Bugfixes</a>
                        </li>
                        
                        <li>
                            <a href="matrix.org/blog/2020/10/27/synapse-1-22-0-released/#updates-to-the-docker-image">Updates to the Docker image</a>
                        </li>
                        
                        <li>
                            <a href="matrix.org/blog/2020/10/27/synapse-1-22-0-released/#improved-documentation">Improved Documentation</a>
                        </li>
                        
                        <li>
                            <a href="matrix.org/blog/2020/10/27/synapse-1-22-0-released/#deprecations-and-removals">Deprecations and Removals</a>
                        </li>
                        
                        <li>
                            <a href="matrix.org/blog/2020/10/27/synapse-1-22-0-released/#internal-changes">Internal Changes</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
            </ul>
        </aside>
        
    </div>
</article>

    </main>

    <footer class="site-footer">
    <div class="internal-links">
        
        <a href="&#x2F;faq">FAQs</a>
        
        <a href="&#x2F;security-disclosure-policy">Security Disclosure Policy</a>
        
        <a href="&#x2F;security-hall-of-fame">Security Hall of Fame</a>
        
        <a href="&#x2F;legal&#x2F;code-of-conduct">Code of Conduct for Matrix.org</a>
        
        <a href="&#x2F;legal">Legal</a>
        
        <a href="&#x2F;contact">Contact</a>
        
        <a href="https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix.org&#x2F;">Site Source</a>
        
    </div>
    <div class="external-links">
        <div>
            
            <a href="https:&#x2F;&#x2F;github.com&#x2F;matrix-org"><img src="/assets/github.svg" alt="GitHub"></a>
            
            <a href="https:&#x2F;&#x2F;gitlab.matrix.org&#x2F;"><img src="/assets/gitlab.svg" alt="GitLab"></a>
            
            <a href="https:&#x2F;&#x2F;mastodon.matrix.org&#x2F;@matrix"><img src="/assets/mastodon.svg" alt="Mastodon"></a>
            
            <a href="https:&#x2F;&#x2F;twitter.com&#x2F;matrixdotorg"><img src="/assets/twitter.svg" alt="Twitter"></a>
            
            <a href="https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UCVFkW-chclhuyYRbmmfwt6w"><img src="/assets/youtube.svg" alt="YouTube"></a>
            
        </div>
    </div>
    <p><a href="/legal/copyright-notice">Copyright Notice</a></p>
</footer>

</body>

</html>
